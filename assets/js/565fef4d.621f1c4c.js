"use strict";(self.webpackChunkdoris_website=self.webpackChunkdoris_website||[]).push([["90713"],{759745:function(e,n,i){i.r(n),i.d(n,{default:()=>m,frontMatter:()=>o,metadata:()=>s,assets:()=>l,toc:()=>d,contentTitle:()=>t});var s=JSON.parse('{"id":"query-acceleration/query-profile","title":"Query Profile Analysis","description":"Apache Doris provides Query Profile to expose query execution details. This article covers the overall architecture and practical guidance, including:","source":"@site/docs/query-acceleration/query-profile.md","sourceDirName":"query-acceleration","slug":"/query-acceleration/query-profile","permalink":"/docs/dev/query-acceleration/query-profile","draft":false,"unlisted":false,"tags":[],"version":"current","lastUpdatedAt":1770477659000,"frontMatter":{"title":"Query Profile Analysis","language":"en","description":"Apache Doris provides Query Profile to expose query execution details. This article covers the overall architecture and practical guidance, including:"},"sidebar":"docs","previous":{"title":"Dictionary Table(Experimental)","permalink":"/docs/dev/query-acceleration/dictionary"},"next":{"title":"BITMAP Precise Deduplication","permalink":"/docs/dev/query-acceleration/distinct-counts/bitmap-precise-deduplication"}}'),r=i("785893"),a=i("250065");let o={title:"Query Profile Analysis",language:"en",description:"Apache Doris provides Query Profile to expose query execution details. This article covers the overall architecture and practical guidance, including:"},t="Overview",l={},d=[{value:"Enable Profile",id:"enable-profile",level:2},{value:"enable_profile",id:"enable_profile",level:3},{value:"profile_level",id:"profile_level",level:3},{value:"auto_profile_threshold_ms",id:"auto_profile_threshold_ms",level:3},{value:"Configure Profile Storage",id:"configure-profile-storage",level:2},{value:"max_query_profile_num",id:"max_query_profile_num",level:3},{value:"max_spilled_profile_num",id:"max_spilled_profile_num",level:3},{value:"spilled_profile_storage_path",id:"spilled_profile_storage_path",level:3},{value:"spilled_profile_storage_limit_bytes",id:"spilled_profile_storage_limit_bytes",level:3},{value:"Retrieve Profiles",id:"retrieve-profiles",level:2},{value:"Via FE Web UI",id:"via-fe-web-ui",level:3},{value:"Via command line",id:"via-command-line",level:3},{value:"From disk directly",id:"from-disk-directly",level:3},{value:"Profile Structure",id:"profile-structure",level:2},{value:"Example: Reading a Profile",id:"example-reading-a-profile",level:2},{value:"Query &amp; Fragment &amp; PlanNode",id:"query--fragment--plannode",level:3},{value:"Pipeline &amp; Operator",id:"pipeline--operator",level:3},{value:"CommonCounters &amp; CustomCounters",id:"commoncounters--customcounters",level:3},{value:"HashJoin",id:"hashjoin",level:3},{value:"Aggregation",id:"aggregation",level:3}];function c(e){let n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"overview",children:"Overview"})}),"\n",(0,r.jsx)(n.p,{children:"Apache Doris provides Query Profile to expose query execution details. This article covers the overall architecture and practical guidance, including:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Collection workflow: how Profile is collected from Backends and stored on Frontend."}),"\n",(0,r.jsx)(n.li,{children:"Collection-related parameters: how to configure to filter noise and focus on key query details."}),"\n",(0,r.jsx)(n.li,{children:"Reading methods: how to quickly locate operators that impact performance."}),"\n"]}),"\n",(0,r.jsx)(n.h1,{id:"query-profile-architecture",children:"Query Profile Architecture"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"alt text",src:i(954888).Z+"",width:"1280",height:"889"})}),"\n",(0,r.jsxs)(n.p,{children:["The core consists of FE ",(0,r.jsx)(n.code,{children:"ProfileManager"})," and BE ",(0,r.jsx)(n.code,{children:"AsyncReportThreadPool"}),"."]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["When a query starts, FE registers Profile-related data structures into ",(0,r.jsx)(n.code,{children:"ProfileManager"}),"."]}),"\n",(0,r.jsx)(n.li,{children:"After a BE query finishes, it registers its Profile as a task into an async reporting thread pool to FE."}),"\n",(0,r.jsxs)(n.li,{children:["BE ",(0,r.jsx)(n.code,{children:"AsyncReportThreadPool"})," sends Profile data to FE via RPC, per-query."]}),"\n",(0,r.jsx)(n.li,{children:"FE background threads process and manage collected Profiles, decide retention and eviction, and compress and persist suitable Profiles."}),"\n",(0,r.jsx)(n.li,{children:"Users view Profiles via Web UI or curl."}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"ProfileManager"})," fetches Profiles from memory or external storage and returns them as text."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Async reporting and persistence have the greatest impact on Profile behavior."}),"\n",(0,r.jsxs)(n.p,{children:["Under heavy load, async reporting may time out. To avoid excessive memory usage on FE, ",(0,r.jsx)(n.code,{children:"ProfileManager"})," abandons timed-out Profiles after waiting for a while. You can adjust ",(0,r.jsx)(n.code,{children:"profile_async_collect_expire_time_secs"})," in ",(0,r.jsx)(n.code,{children:"fe.conf"}),". If timeouts are frequent, check resource usage first; turning off global Profile may be safer."]}),"\n",(0,r.jsx)(n.p,{children:"Persisting Profiles to disk ensures:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Profiles no longer occupy FE memory."}),"\n",(0,r.jsx)(n.li,{children:"Profiles remain queryable after FE restarts."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"This allows FE to retain thousands of complete Profiles and makes it easier to compare before/after upgrades to validate performance improvements."}),"\n",(0,r.jsx)(n.h1,{id:"configure-profile",children:"Configure Profile"}),"\n",(0,r.jsx)(n.h2,{id:"enable-profile",children:"Enable Profile"}),"\n",(0,r.jsx)(n.h3,{id:"enable_profile",children:"enable_profile"}),"\n",(0,r.jsx)(n.p,{children:"When false, Profile is not generated. Default: false."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"mysql> select 1;\n...\nmysql> show query profile;\n...\n"})}),"\n",(0,r.jsx)(n.h3,{id:"profile_level",children:"profile_level"}),"\n",(0,r.jsxs)(n.p,{children:["Default: 1. ",(0,r.jsx)(n.strong,{children:"Effective in 4.0 and master branches. Do not use this parameter in versions prior to 4.0; earlier versions have different semantics."})]}),"\n",(0,r.jsxs)(n.p,{children:["By default, BE reports a concise Profile (enough for FE to build MergedProfile). For more details with minimal impact, set ",(0,r.jsx)(n.code,{children:"profile_level=2"}),". The maximum is 3; at level 3, collecting some counters may affect performance."]}),"\n",(0,r.jsxs)(n.p,{children:["Example: default ",(0,r.jsx)(n.code,{children:"EXCHANGE_OPERATOR"})," counters:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"EXCHANGE_OPERATOR(id=1):\n     - InstanceID: ef33b72e30b84b68-82ad027edbee5910\n     - BlocksProduced: 1\n     - CloseTime: 4.243us\n     - ExecTime: 30.834us\n     - InitTime: 20.902us\n     - MemoryUsage: 0.00 \n     - MemoryUsagePeak: 36.00 KB\n     - OpenTime: 1.93us\n     - ProjectionTime: 0ns\n     - RowsProduced: 10\n     - WaitForDependencyTime: 0ns\n       - WaitForData0: 635.324us\n"})}),"\n",(0,r.jsxs)(n.p,{children:["With ",(0,r.jsx)(n.code,{children:"profile_level=2"}),", more counters appear:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"EXCHANGE_OPERATOR(id=1):\n     - InstanceID: 514023de1b7b41a3-9e59e43c591103a2\n     - BlocksProduced: 1\n     - CloseTime: 3.523us\n     - CreateMergerTime: 0ns\n     - DataArrivalWaitTime: 0ns\n     - DecompressBytes: 0.00 \n     - DecompressTime: 0ns\n     - DeserializeRowBatchTimer: 0ns\n     - ExecTime: 28.439us\n     - FilterTime: 287ns\n     - FirstBatchArrivalWaitTime: 0ns\n     - GetDataFromRecvrTime: 3.482us\n     - InitTime: 18.258us\n     - LocalBytesReceived: 36.00 KB\n     - MaxFindRecvrTime(NS): 0\n     - MaxWaitForWorkerTime: 0\n     - MaxWaitToProcessTime: 0\n     - MemoryUsage: 0.00 \n     - MemoryUsagePeak: 36.00 KB\n     - OpenTime: 1.44us\n     - ProjectionTime: 0ns\n     - RemoteBytesReceived: 0.00 \n     - RowsProduced: 10\n     - SendersBlockedTotalTimer(*): 0ns\n     - WaitForDependencyTime: 0ns\n       - WaitForData0: 596.708us\n"})}),"\n",(0,r.jsx)(n.h3,{id:"auto_profile_threshold_ms",children:"auto_profile_threshold_ms"}),"\n",(0,r.jsx)(n.p,{children:"Default: -1. Effective from 3.0."}),"\n",(0,r.jsxs)(n.p,{children:["Globally enabling Profile can generate\u5927\u91CF entries, consuming FE CPU/memory/disk and affecting latency-sensitive small queries, so FE periodically cleans Profiles. To avoid losing a slow query Profile, use this parameter to only generate and retain Profiles when query time exceeds the threshold. ",(0,r.jsx)(n.code,{children:"-1"})," means generate Profiles for all queries."]}),"\n",(0,r.jsx)(n.p,{children:"Example: with global Profile on, all queries generate Profiles. Set a threshold to skip trivial ones:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"mysql> clean all profile;\nmysql> set global auto_profile_threshold_ms=1000;\n...\nmysql> show query profile;\n\nEmpty set (0.00 sec)\n"})}),"\n",(0,r.jsx)(n.h2,{id:"configure-profile-storage",children:"Configure Profile Storage"}),"\n",(0,r.jsxs)(n.p,{children:["Doris can persist Profiles on FE local disk to keep more records. Configure in ",(0,r.jsx)(n.code,{children:"fe.conf"}),":"]}),"\n",(0,r.jsx)(n.h3,{id:"max_query_profile_num",children:"max_query_profile_num"}),"\n",(0,r.jsx)(n.p,{children:"Default: 500. Max Profiles kept in FE memory. Excess are evicted from oldest."}),"\n",(0,r.jsx)(n.h3,{id:"max_spilled_profile_num",children:"max_spilled_profile_num"}),"\n",(0,r.jsx)(n.p,{children:"Default: 500. Max Profiles stored on disk. Excess are deleted from oldest."}),"\n",(0,r.jsx)(n.h3,{id:"spilled_profile_storage_path",children:"spilled_profile_storage_path"}),"\n",(0,r.jsxs)(n.p,{children:["Local directory for Profiles. Default: ",(0,r.jsx)(n.code,{children:"log/profile"}),"."]}),"\n",(0,r.jsx)(n.h3,{id:"spilled_profile_storage_limit_bytes",children:"spilled_profile_storage_limit_bytes"}),"\n",(0,r.jsx)(n.p,{children:"Default: 1 GB. Max total disk space occupied by Profiles."}),"\n",(0,r.jsx)(n.h2,{id:"retrieve-profiles",children:"Retrieve Profiles"}),"\n",(0,r.jsx)(n.h3,{id:"via-fe-web-ui",children:"Via FE Web UI"}),"\n",(0,r.jsxs)(n.p,{children:["Visit FE ",(0,r.jsx)(n.code,{children:"ip:http_port"})," and log in. Open QueryProfile to view all Profiles on the current FE, click Profile ID for details.\nNotes:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Profiles exist only on the FE that executed the SQL; they are not synchronized across FEs. Connect to the FE used by the query."}),"\n",(0,r.jsx)(n.li,{children:"Import jobs are forwarded to FE Master for execution, so their Profiles must be fetched from the Master FE."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"alt text",src:i(366826).Z+"",width:"1280",height:"312"})}),"\n",(0,r.jsx)(n.h3,{id:"via-command-line",children:"Via command line"}),"\n",(0,r.jsxs)(n.p,{children:["When FE Web UI is unavailable (e.g., security constraints), use CLI. First, ",(0,r.jsx)(n.code,{children:"show query profile"})," to list the latest 20 profiles."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"mysql> show query profile;\n...\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Fetch a specific Profile via HTTP API, e.g., ID ",(0,r.jsx)(n.code,{children:"f7efdc4c092d4b14-95e0f7f7783974d3"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"curl -uroot: http://127.0.0.1:5937/api/profile/text?query_id=f7efdc4c092d4b14-95e0f7f7783974d3 > f7efdc4c092d4b14-95e0f7f7783974d3.profile\n"})}),"\n",(0,r.jsx)(n.p,{children:"The result matches Web UI:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"> head f7efdc4c092d4b14-95e0f7f7783974d3.profile -n 10\nSummary:\n   - Profile ID: f7efdc4c092d4b14-95e0f7f7783974d3\n   - Task Type: QUERY\n   - Start Time: 2025-02-26 19:31:27\n   - End Time: 2025-02-26 19:32:41\n   - Total: 1min14sec\n   - Task State: OK\n   - User: root\n   - Default Catalog: internal\n   - Default Db: tpch\n"})}),"\n",(0,r.jsx)(n.h3,{id:"from-disk-directly",children:"From disk directly"}),"\n",(0,r.jsxs)(n.p,{children:["From 3.0 on, Profiles can be persisted. Default directory: ",(0,r.jsx)(n.code,{children:"log/profile"}),". For faster viewing, unzip the target file to get text output. Notes:"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Doris FE protects ",(0,r.jsx)(n.code,{children:"log/profile"}),"; do not keep the unzipped output inside, or it will be deleted."]}),"\n",(0,r.jsxs)(n.li,{children:["Text format differs slightly from Web UI: ",(0,r.jsx)(n.code,{children:"Summary"})," is saved as JSON meta, the rest matches Web UI."]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"unzip profile/1740745121714_33bf38e988ea4945-b585d2f74d1da3fd.zip\nhead 33bf38e988ea4945-b585d2f74d1da3fd.profile -n 10\n"})}),"\n",(0,r.jsx)(n.h2,{id:"profile-structure",children:"Profile Structure"}),"\n",(0,r.jsx)(n.p,{children:"Profile content comprises:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Summary\n",(0,r.jsx)(n.code,{children:"SummaryProfile"})," is the metadata, recording key fields for retrieval, such as ",(0,r.jsx)(n.code,{children:"Profile ID"}),", ",(0,r.jsx)(n.code,{children:"Total"}),"."]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-text",children:"-  Profile  ID:  d4d281168bf7490a-a133623295744f85\n-  Task  Type:  QUERY\n-  Start  Time:  2025-02-28  19:23:14\n-  End  Time:  2025-02-28  19:23:16\n-  Total:  2sec420ms\n-  Task  State:  OK\n"})}),"\n",(0,r.jsxs)(n.ol,{start:"2",children:["\n",(0,r.jsx)(n.li,{children:"ExecutionSummary\nSummary of execution. Plan-related fields record Planner time."}),"\n",(0,r.jsx)(n.li,{children:"ChangedSessionVariables\nSession variables changed during execution."}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-text",children:"ChangedSessionVariables:\nVarName                       | CurrentValue | DefaultValue\n------------------------------|--------------|-------------\ninsert_visible_timeout_ms     | 10000        | 60000       \nfetch_splits_max_wait_time_ms | 4000         | 1000        \nexec_mem_limit                | 2147483648   | 100147483648\nprofile_level                 | 2            | 1           \nauto_profile_threshold_ms     | 1            | -1          \n"})}),"\n",(0,r.jsxs)(n.ol,{start:"4",children:["\n",(0,r.jsxs)(n.li,{children:["MergedProfile\nAggregation of ",(0,r.jsx)(n.code,{children:"DetailProfile"}),". Main purposes:"]}),"\n"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Clarify query plan and Pipeline structure."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Doris has a Query \u2192 Fragment \u2192 PlanNode hierarchy for planning; the executor schedules by Pipeline, each consisting of Operators. MergedProfile clearly shows the transformation from plan to Pipeline. Examples below show how to reconstruct plan and Pipeline."}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Quickly locate bottleneck operators."}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["Use ",(0,r.jsx)(n.code,{children:"DependencyWaitTime"})," in MergedProfile to find the most time-consuming operator, then inspect its details in DetailProfile."]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Compare data skew."}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["By comparing ",(0,r.jsx)(n.code,{children:"InputRows"})," and ",(0,r.jsx)(n.code,{children:"RowsProduced"}),", you can judge whether data is uneven across Backends, which often causes slow or failed queries."]}),"\n",(0,r.jsxs)(n.ol,{start:"5",children:["\n",(0,r.jsx)(n.li,{children:"DetailProfile"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["The detailed execution information. DetailProfile records, for each Fragment and Pipeline, the ",(0,r.jsx)(n.code,{children:"PipelineTask"})," execution across Backends. After locating the bottleneck in MergedProfile, use DetailProfile for deep analysis."]}),"\n",(0,r.jsx)(n.h2,{id:"example-reading-a-profile",children:"Example: Reading a Profile"}),"\n",(0,r.jsxs)(n.p,{children:["Consider a typical query with Aggregation, Join and Scan on the TPCH dataset: join ",(0,r.jsx)(n.code,{children:"customer"})," and ",(0,r.jsx)(n.code,{children:"orders"}),", then aggregate."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"SELECT c.c_name,\n       Count(o.o_orderkey) AS total_orders,\n       Sum(o.o_totalprice) AS total_spent\nFROM   customer c\n       JOIN orders o\n         ON c.c_custkey = o.o_custkey\nGROUP  BY c.c_name\nLIMIT  20 \n"})}),"\n",(0,r.jsx)(n.p,{children:"To keep the Profile concise, limit parallelism:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"set parallel_pipeline_task_num=2;\n"})}),"\n",(0,r.jsx)(n.p,{children:"After running and fetching the Profile via Web UI, focus on MergedProfile. For brevity, only key fields are shown:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"MergedProfile:\n     Fragments:\n       Fragment 0:\n         Pipeline 0(instance_num=1):\n           RESULT_SINK_OPERATOR(id=0):\n             CommonCounters:\n                - ExecTime: avg 176.545us, max 176.545us, min 176.545us\n                - InputRows: sum 20, avg 20, max 20, min 20\n                - WaitForDependency[RESULT_SINK_OPERATOR_DEPENDENCY]Time: avg 0ns, max 0ns, min 0ns\n             CustomCounters:\n           EXCHANGE_OPERATOR(id=8):\n             CommonCounters:\n                - ExecTime: avg 84.559us, max 84.559us, min 84.559us\n                - RowsProduced: sum 20, avg 20, max 20, min 20\n             CustomCounters:\n                - WaitForDependencyTime: avg 0ns, max 0ns, min 0ns\n                  - WaitForData0: avg 11sec450ms, max 11sec450ms, min 11sec450ms\n       Fragment 1:\n         Pipeline 0(instance_num=2):\n           DATA_STREAM_SINK_OPERATOR(dest_id=8):\n            CommonCounters:\n              - ExecTime: avg 31.515us, max 33.405us, min 29.626us\n              - InputRows: sum 20, avg 10, max 11, min 9\n              - WaitForDependencyTime: avg 0ns, max 0ns, min 0ns\n               - WaitForRpcBufferQueue: avg 0ns, max 0ns, min 0ns\n            CustomCounters:\n             - BlocksProduced: sum 2, avg 1, max 1, min 1\n          SORT_OPERATOR(nereids_id=443)(id=7):\n           CommonCounters:\n             - ExecTime: avg 980ns, max 1.199us, min 762ns\n             - RowsProduced: sum 20, avg 10, max 11, min 9\n             - WaitForDependency[SORT_OPERATOR_DEPENDENCY]Time: avg 11sec450ms, max 11sec450ms, min 11sec450ms\n           CustomCounters:\n        Pipeline 1(instance_num=2):\n          SORT_SINK_OPERATOR(nereids_id=443)(id=7):\n           CommonCounters:\n             - ExecTime: avg 49.414us, max 54.802us, min 44.27us\n             - InputRows: sum 20, avg 10, max 11, min 9\n             - WaitForDependency[SORT_SINK_OPERATOR_DEPENDENCY]Time: avg 0ns, max 0ns, min 0ns\n           CustomCounters:\n          AGGREGATION_OPERATOR(nereids_id=438)(id=6):\n           CommonCounters:\n             - ExecTime: avg 34.521us, max 36.402us, min 32.640us\n             - RowsProduced: sum 20, avg 10, max 11, min 9\n             - WaitForDependency[AGGREGATION_OPERATOR_DEPENDENCY]Time: avg 11sec450ms, max 11sec450ms, min 11sec450ms\n           CustomCounters:\n        Pipeline 2(instance_num=2):\n          AGGREGATION_SINK_OPERATOR(nereids_id=438)(id=6):\n           CommonCounters:\n             - ExecTime: avg 109.89us, max 118.582us, min 99.596us\n             - InputRows: sum 40, avg 20, max 22, min 18\n             - WaitForDependency[AGGREGATION_SINK_OPERATOR_DEPENDENCY]Time: avg 0ns, max 0ns, min 0ns\n           CustomCounters:\n          EXCHANGE_OPERATOR(id=5):\n           CommonCounters:\n             - ExecTime: avg 29.741us, max 34.521us, min 24.962us\n             - RowsProduced: sum 40, avg 20, max 22, min 18\n           CustomCounters:\n             - WaitForDependencyTime: avg 0ns, max 0ns, min 0ns\n              - WaitForData0: avg 11sec450ms, max 11sec450ms, min 11sec450ms\n       Fragment 2:\n        Pipeline 0(instance_num=2):\n          DATA_STREAM_SINK_OPERATOR(dest_id=5):\n           CommonCounters:\n             - ExecTime: avg 71.148us, max 73.242us, min 69.54us\n             - InputRows: sum 40, avg 20, max 20, min 20\n             - WaitForDependencyTime: avg 0ns, max 0ns, min 0ns\n              - WaitForRpcBufferQueue: avg 0ns, max 0ns, min 0ns\n           CustomCounters:\n          AGGREGATION_OPERATOR(nereids_id=428)(id=4):\n           CommonCounters:\n             - ExecTime: avg 350.431us, max 393.100us, min 307.762us\n             - RowsProduced: sum 40, avg 20, max 20, min 20\n             - WaitForDependency[AGGREGATION_OPERATOR_DEPENDENCY]Time: avg 11sec30ms, max 11sec450ms, min 10sec610ms\n           CustomCounters:\n        Pipeline 1(instance_num=2):\n          AGGREGATION_SINK_OPERATOR(nereids_id=428)(id=4):\n           CommonCounters:\n             - ExecTime: avg 442.308ms, max 449.109ms, min 435.506ms\n             - InputRows: sum 150.0M (150000000), avg 75.0M (75000000), max 75.000001M (75000001), min 74.999999M (74999999)\n             - MemoryUsage: sum 2.05 MB, avg 1.03 MB, max 1.03 MB, min 1.03 MB\n             - MemoryUsagePeak: sum 2.05 MB, avg 1.03 MB, max 1.03 MB, min 1.03 MB\n             - WaitForDependency[AGGREGATION_SINK_OPERATOR_DEPENDENCY]Time: avg 0ns, max 0ns, min 0ns\n           CustomCounters:\n             - MemoryUsageHashTable: sum 1.03 MB, avg 526.28 KB, max 526.28 KB, min 526.28 KB\n             - MemoryUsageSerializeKeyArena: sum 1.02 MB, avg 524.00 KB, max 524.00 KB, min 524.00 KB\n          HASH_JOIN_OPERATOR(nereids_id=418)(id=3):\n           CommonCounters:\n             - ExecTime: avg 9sec169ms, max 9sec582ms, min 8sec756ms\n             - RowsProduced: sum 150.0M (150000000), avg 75.0M (75000000), max 75.000001M (75000001), min 74.999999M (74999999)\n             - WaitForDependency[HASH_JOIN_OPERATOR_DEPENDENCY]Time: avg 949.860ms, max 962.978ms, min 936.743ms\n           CustomCounters:\n             - ProbeRows: sum 150.0M (150000000), avg 75.0M (75000000), max 75.000001M (75000001), min 74.999999M (74999999)\n          OLAP_SCAN_OPERATOR(nereids_id=397. table_name=orders(orders))(id=2):\n           CommonCounters:\n             - ExecTime: avg 396.233ms, max 410.306ms, min 382.160ms\n             - RowsProduced: sum 150.0M (150000000), avg 75.0M (75000000), max 75.000001M (75000001), min 74.999999M (74999999)\n           CustomCounters:\n             - WaitForDependency[OLAP_SCAN_OPERATOR_DEPENDENCY]Time: avg 0ns, max 0ns, min 0ns\n        Pipeline 2(instance_num=2):\n          HASH_JOIN_SINK_OPERATOR(nereids_id=418)(id=3):\n           CommonCounters:\n             - ExecTime: avg 445.146ms, max 890.258ms, min 34.635us\n             - InputRows: sum 15.0M (15000000), avg 7.5M (7500000), max 15.0M (15000000), min 0\n             - WaitForDependency[HASH_JOIN_SINK_OPERATOR_DEPENDENCY]Time: avg 482.355ms, max 964.711ms, min 0ns\n           CustomCounters:\n             - MemoryUsageHashTable: sum 185.22 MB, avg 92.61 MB, max 185.22 MB, min 0.00 \n          EXCHANGE_OPERATOR(id=1):\n           CommonCounters:\n             - ExecTime: avg 10.131ms, max 20.243ms, min 19.26us\n             - RowsProduced: sum 15.0M (15000000), avg 7.5M (7500000), max 15.0M (15000000), min 0\n           CustomCounters:\n             - WaitForDependencyTime: avg 0ns, max 0ns, min 0ns\n              - WaitForData0: avg 47.582ms, max 47.582ms, min 47.582ms\n       Fragment 3:\n        Pipeline 0(instance_num=2):\n          DATA_STREAM_SINK_OPERATOR(dest_id=1):\n           CommonCounters:\n             - ExecTime: avg 3.269ms, max 3.281ms, min 3.258ms\n             - InputRows: sum 15.0M (15000000), avg 7.5M (7500000), max 7.500001M (7500001), min 7.499999M (7499999)\n             - WaitForDependencyTime: avg 0ns, max 0ns, min 0ns\n              - WaitForLocalExchangeBuffer0: avg 142.859ms, max 285.713ms, min 6.733us\n              - WaitForRpcBufferQueue: avg 0ns, max 0ns, min 0ns\n           CustomCounters:\n          OLAP_SCAN_OPERATOR(nereids_id=403. table_name=customer(customer))(id=0):\n           CommonCounters:\n             - ExecTime: avg 77.435ms, max 78.752ms, min 76.118ms\n             - RowsProduced: sum 15.0M (15000000), avg 7.5M (7500000), max 7.500001M (7500001), min 7.499999M (7499999)\n           CustomCounters:\n             - WaitForDependency[OLAP_SCAN_OPERATOR_DEPENDENCY]Time: avg 49.690ms, max 50.522ms, min 48.858ms\n\n"})}),"\n",(0,r.jsx)(n.p,{children:"The above is a trimmed MergedProfile. Doris query planning has a three-level structure: Query \u2192 Fragment \u2192 PlanNode, while the BE execution engine further introduces Pipeline \u2192 Operator."}),"\n",(0,r.jsx)(n.h3,{id:"query--fragment--plannode",children:"Query & Fragment & PlanNode"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"alt text",src:i(417352).Z+"",width:"710",height:"1404"})}),"\n",(0,r.jsxs)(n.p,{children:["Arrows indicate data flow. The entire query plan is split into 4 Fragments (left blocks) and multiple PlanNodes (Fragment and its PlanNodes on the same horizontal line). PlanNodes include two SCAN_NODEs reading ",(0,r.jsx)(n.code,{children:"customer"})," and ",(0,r.jsx)(n.code,{children:"orders"}),", multiple DATA_STREAM_SINK and EXCHANGE nodes for inter-Fragment data transfer, HASH_JOIN to join scanned data, and two-phase aggregation (AGGREGATION and AGGREGATION(MERGE)). RESULT_SINK returns results to FE, preceded by TOP-N to limit rows."]}),"\n",(0,r.jsx)(n.h3,{id:"pipeline--operator",children:"Pipeline & Operator"}),"\n",(0,r.jsx)(n.p,{children:"How does the QueryPlan translate to Pipelines and Operators? Take Fragments 1 and 2 (with AGGREGATION and HASH_JOIN) as examples."}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"alt text",src:i(461308).Z+"",width:"755",height:"1280"})}),"\n",(0,r.jsx)(n.p,{children:"During execution, Doris splits certain PlanNodes into one or more Operators."}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["DATA_STREAM_SINK becomes DATA_STREAM_SINK_OPERATOR, which outputs data from a Fragment. It has no OperatorId, only a destination OperatorId; ",(0,r.jsx)(n.code,{children:"dest_id=5"})," means it sends data to ",(0,r.jsx)(n.code,{children:"EXCHANGE_OPERATOR(id=5)"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["HASH_JOIN with ",(0,r.jsx)(n.code,{children:"PlanNodeId=3"})," becomes HASH_JOIN_SINK_OPERATOR and HASH_JOIN_OPERATOR, both with Operator Id 3 (same as PlanNodeId)."]}),"\n",(0,r.jsx)(n.li,{children:"Phase-1 AGGREGATION and Phase-2 AGGREGATION(MERGE) are each split into a pair of SINK and SOURCE operators."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Operators are linked into Pipelines. Each of Fragments 1 and 2 has 3 Pipelines. Operators inside a Pipeline stream data without blocking; operators that connect Pipelines do block due to logical dependencies (e.g., Probe waits for Build to finish hash-table construction) or system constraints (e.g., EXCHANGE_OPERATOR waiting for network data from DATA_STREAM_SINK_OPERATOR)."}),"\n",(0,r.jsx)(n.p,{children:"Scheduling non-blocking operators together in Pipelines improves resource utilization and cache locality."}),"\n",(0,r.jsx)(n.h3,{id:"commoncounters--customcounters",children:"CommonCounters & CustomCounters"}),"\n",(0,r.jsx)(n.p,{children:"CommonCounters are mandatory for all Operators in Doris:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"ExecTime: time spent in the current operator (excluding upstream time)."}),"\n",(0,r.jsx)(n.li,{children:"RowsProduced (non-Sink): rows output by the operator."}),"\n",(0,r.jsx)(n.li,{children:"InputRows (Sink): rows consumed by the sink."}),"\n",(0,r.jsx)(n.li,{children:"MemoryUsage & MemoryUsagePeak: current and peak memory usage."}),"\n",(0,r.jsx)(n.li,{children:"WaitForDependency: time spent waiting on dependencies."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"CustomCounters are operator-specific. See the operator profile documentation for details on each counter."}),"\n",(0,r.jsx)(n.h3,{id:"hashjoin",children:"HashJoin"}),"\n",(0,r.jsx)(n.p,{children:"With the basics established, reconstruct the Join execution via MergedProfile."}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"alt text",src:i(182586).Z+"",width:"766",height:"688"})}),"\n",(0,r.jsx)(n.p,{children:"Parallelism was set to 2, so although the diagram shows one connected pair of Pipeline 1 and Pipeline 2, 4 PipelineTasks actually run (2 per pipeline)."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"Pipeline 0(instance_num=2)\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"instance_num"})," equals the total PipelineTask count across all BEs. With 1 BE and ",(0,r.jsx)(n.code,{children:"parallel_pipeline_task_num=2"}),", ",(0,r.jsx)(n.code,{children:"instance_num=2"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["In Pipeline 2, two PipelineTasks processed 15M rows to build the hash table; average build time was 445.146 ms. Pipeline 1 depends on Pipeline 2 completing hash build; the wait shows as ",(0,r.jsx)(n.code,{children:"WaitForDependency"}),", averaging 949.860 ms. Why is the wait longer than the build? In this case FE planned a BROADCAST_JOIN, and only one of the two PipelineTasks actually performs the build:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"HASH_JOIN_SINK_OPERATOR(nereids_id=418)(id=3):\n CommonCounters:\n    - ExecTime: avg 445.146ms, max 890.258ms, min 34.635us\n    - InputRows: sum 15.0M (15000000), avg 7.5M (7500000), max 15.0M (15000000), min 0\n    - WaitForDependency[HASH_JOIN_SINK_OPERATOR_DEPENDENCY]Time: avg 482.355ms, max 964.711ms, min 0ns\n CustomCounters:\n    - MemoryUsageHashTable: sum 185.22 MB, avg 92.61 MB, max 185.22 MB, min 0.00 \n"})}),"\n",(0,r.jsx)(n.p,{children:"From the MergedProfile, despite parallelism=2, one PipelineTask took 890.258 ms while the other took 34.635 us and processed zero rows\u2014indicating only one task built the hash, explaining:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"WaitForDependency[HASH_JOIN_OPERATOR_DEPENDENCY]Time: avg 949.860ms, max 962.978ms, min 936.743ms\n"})}),"\n",(0,r.jsx)(n.p,{children:"Continuing with HASH_JOIN_OPERATOR: after ~949.860 ms of waiting, Probe begins. Two OLAP_SCAN_OPERATOR(id=2) read 150M rows, and all rows feed into AGGREGATION_SINK_OPERATOR, which builds the hash table and continues aggregation."}),"\n",(0,r.jsx)(n.h3,{id:"aggregation",children:"Aggregation"}),"\n",(0,r.jsx)(n.p,{children:"The query aggregates: Count(o.o_orderkey) AS total_orders, Sum(o.o_totalprice) AS total_spent, and GROUP BY c.c_name."}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"alt text",src:i(303777).Z+"",width:"842",height:"1248"})}),"\n",(0,r.jsx)(n.p,{children:"Doris uses two-phase aggregation here."}),"\n",(0,r.jsxs)(n.p,{children:["Phase 1: the AGGREGATION pair with ",(0,r.jsx)(n.code,{children:"id=4"}),". AGGREGATION_SINK_OPERATOR(id=4) consumes 150M rows, builds a hash table on GROUP BY keys, and updates AggregationData."]}),"\n",(0,r.jsxs)(n.p,{children:["After Phase 1, AggregationData is sent via EXCHANGE to Phase 2. Since different PipelineTasks may handle the same GROUP BY key, EXCHANGE partitions by ",(0,r.jsx)(n.code,{children:"name"})," so identical keys reach the same Phase-2 operator."]}),"\n",(0,r.jsx)(n.p,{children:"AGGREGATION_OPERATOR(id=4) outputs 40 rows, meaning the Phase-1 hash table has 40 entries. Phase 2 AGGREGATION_SINK_OPERATOR(id=6) deserializes Phase-1 results to AggregationData and merges; AGGREGATION_OPERATOR(id=6) then feeds TOP-N. With LIMIT 20, TOP-N stops early after collecting 20 rows."}),"\n",(0,r.jsx)(n.p,{children:"Overall, the slowest operator is HASH_JOIN_OPERATOR(id=3). After identifying this via MergedProfile, check DetailProfile for fine-grained counters. Refer to operator docs for definitions."})]})}function m(e={}){let{wrapper:n}={...(0,a.a)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},954888:function(e,n,i){i.d(n,{Z:function(){return s}});let s=i.p+"assets/images/profile-image-0-18d56920287086f1c6cedf3a4e5e7354.png"},366826:function(e,n,i){i.d(n,{Z:function(){return s}});let s=i.p+"assets/images/profile-image-1-e7f06dc86ca9dd077e3fb20e42b94256.png"},417352:function(e,n,i){i.d(n,{Z:function(){return s}});let s=i.p+"assets/images/profile-image-2-88f9b581f4b4fd675c5bb76311febf53.png"},461308:function(e,n,i){i.d(n,{Z:function(){return s}});let s=i.p+"assets/images/profile-image-3-2f8e896342272495698ff8d7ec49ecf5.png"},182586:function(e,n,i){i.d(n,{Z:function(){return s}});let s=i.p+"assets/images/profile-image-4-7e36ac331d91ad84121ad4ed5190f189.png"},303777:function(e,n,i){i.d(n,{Z:function(){return s}});let s=i.p+"assets/images/profile-image-5-fe06e847d5be3a978ab97a8ccb0d0c08.png"},250065:function(e,n,i){i.d(n,{Z:function(){return t},a:function(){return o}});var s=i(667294);let r={},a=s.createContext(r);function o(e){let n=s.useContext(a);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),s.createElement(a.Provider,{value:n},e.children)}}}]);