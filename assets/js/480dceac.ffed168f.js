"use strict";(self.webpackChunkdoris_website=self.webpackChunkdoris_website||[]).push([["46285"],{800553:function(e,t,n){n.r(t),n.d(t,{default:()=>h,frontMatter:()=>r,metadata:()=>a,assets:()=>o,toc:()=>d,contentTitle:()=>l});var a=JSON.parse('{"id":"admin-manual/maint-monitor/disk-capacity","title":"Disk Capacity Management","description":"This document mainly introduces system parameters and processing strategies related to disk storage capacity.","source":"@site/versioned_docs/version-2.0/admin-manual/maint-monitor/disk-capacity.md","sourceDirName":"admin-manual/maint-monitor","slug":"/admin-manual/maint-monitor/disk-capacity","permalink":"/docs/2.0/admin-manual/maint-monitor/disk-capacity","draft":false,"unlisted":false,"tags":[],"version":"2.0","frontMatter":{"title":"Disk Capacity Management","language":"en"},"sidebar":"docs","previous":{"title":"Monitoring and alarming","permalink":"/docs/2.0/admin-manual/maint-monitor/monitor-alert"},"next":{"title":"Data Replica Management","permalink":"/docs/2.0/admin-manual/maint-monitor/tablet-repair-and-balance"}}'),i=n("785893"),s=n("250065");let r={title:"Disk Capacity Management",language:"en"},l="Disk Capacity Management",o={},d=[{value:"Glossary",id:"glossary",level:2},{value:"Basic Principles",id:"basic-principles",level:2},{value:"FE Parameter",id:"fe-parameter",level:2},{value:"BE Parameter",id:"be-parameter",level:2},{value:"Disk Capacity Release",id:"disk-capacity-release",level:2}];function c(e){let t={a:"a",br:"br",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.header,{children:(0,i.jsx)(t.h1,{id:"disk-capacity-management",children:"Disk Capacity Management"})}),"\n",(0,i.jsx)(t.p,{children:"This document mainly introduces system parameters and processing strategies related to disk storage capacity."}),"\n",(0,i.jsx)(t.p,{children:"If Doris' data disk capacity is not controlled, the process will hang because the disk is full. Therefore, we monitor the disk usage and remaining capacity, and control various operations in the Doris system by setting different warning levels, and try to avoid the situation where the disk is full."}),"\n",(0,i.jsx)(t.h2,{id:"glossary",children:"Glossary"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["Data Dir: Data directory, each data directory specified in the ",(0,i.jsx)(t.code,{children:"storage_root_path"})," of the BE configuration file ",(0,i.jsx)(t.code,{children:"be.conf"}),". Usually a data directory corresponds to a disk, so the following ",(0,i.jsx)(t.strong,{children:"disk"})," also refers to a data directory."]}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"basic-principles",children:"Basic Principles"}),"\n",(0,i.jsx)(t.p,{children:"BE will report disk usage to FE on a regular basis (every minute). FE records these statistical values and restricts various operation requests based on these statistical values."}),"\n",(0,i.jsxs)(t.p,{children:["Two thresholds, ",(0,i.jsx)(t.strong,{children:"High Watermark"})," and ",(0,i.jsx)(t.strong,{children:"Flood Stage"}),", are set in FE. Flood Stage is higher than High Watermark. When the disk usage is higher than High Watermark, Doris will restrict the execution of certain operations (such as replica balancing, etc.). If it is higher than Flood Stage, certain operations (such as load data) will be prohibited."]}),"\n",(0,i.jsxs)(t.p,{children:["At the same time, a ",(0,i.jsx)(t.strong,{children:"Flood Stage"})," is also set on the BE. Taking into account that FE cannot fully detect the disk usage on BE in a timely manner, and cannot control certain BE operations (such as Compaction). Therefore, Flood Stage on the BE is used for the BE to actively refuse and stop certain operations to achieve the purpose of self-protection."]}),"\n",(0,i.jsx)(t.h2,{id:"fe-parameter",children:"FE Parameter"}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.strong,{children:"High Watermark:"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"storage_high_watermark_usage_percent: default value is 85 (85%).\nstorage_min_left_capacity_bytes: default value is 2GB.\n"})}),"\n",(0,i.jsxs)(t.p,{children:["When disk capacity ",(0,i.jsx)(t.strong,{children:"more than"})," ",(0,i.jsx)(t.code,{children:"storage_high_watermark_usage_percent"}),", ",(0,i.jsx)(t.strong,{children:"or"})," disk free capacity ",(0,i.jsx)(t.strong,{children:"less than"})," ",(0,i.jsx)(t.code,{children:"storage_min_left_capacity_bytes"}),", the disk will no longer be used as the destination path for the following operations:"]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"Tablet Balance"}),"\n",(0,i.jsx)(t.li,{children:"Colocation Relocation"}),"\n",(0,i.jsx)(t.li,{children:"Decommission"}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.strong,{children:"Flood Stage:"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"storage_flood_stage_usage_percent: default value is 95 (95%).\nstorage_flood_stage_left_capacity_bytes: default value is 1GB.\n"})}),"\n",(0,i.jsxs)(t.p,{children:["When disk capacity ",(0,i.jsx)(t.strong,{children:"more than"})," ",(0,i.jsx)(t.code,{children:"storage_flood_stage_usage_percent"}),", ",(0,i.jsx)(t.strong,{children:"or"})," disk free capacity ",(0,i.jsx)(t.strong,{children:"less than"})," ",(0,i.jsx)(t.code,{children:"storage_flood_stage_left_capacity_bytes"}),", the disk will no longer be used as the destination path for the following operations:"]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"Tablet Balance"}),"\n",(0,i.jsx)(t.li,{children:"Colocation Relocation"}),"\n",(0,i.jsx)(t.li,{children:"Replica make up"}),"\n",(0,i.jsx)(t.li,{children:"Restore"}),"\n",(0,i.jsx)(t.li,{children:"Load/Insert"}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"be-parameter",children:"BE Parameter"}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.strong,{children:"Flood Stage:"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"storage_flood_stage_usage_percent: default value is 90 (90%).\nstorage_flood_stage_left_capacity_bytes: default value is 1GB.\n"})}),"\n",(0,i.jsxs)(t.p,{children:["When disk capacity ",(0,i.jsx)(t.strong,{children:"more than"})," ",(0,i.jsx)(t.code,{children:"storage_flood_stage_usage_percent"}),", ",(0,i.jsx)(t.strong,{children:"and"})," disk free capacity ",(0,i.jsx)(t.strong,{children:"less than"})," ",(0,i.jsx)(t.code,{children:"storage_flood_stage_left_capacity_bytes"}),", the following operations on this disk will be prohibited:"]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"Base/Cumulative Compaction"}),"\n",(0,i.jsx)(t.li,{children:"Data load"}),"\n",(0,i.jsx)(t.li,{children:"Clone Task (Usually occurs when the replica is repaired or balanced.)"}),"\n",(0,i.jsx)(t.li,{children:"Push Task (Occurs during the Loading phase of Hadoop import, and the file is downloaded. )"}),"\n",(0,i.jsx)(t.li,{children:"Alter Task (Schema Change or Rollup Task.)"}),"\n",(0,i.jsx)(t.li,{children:"Download Task (The Downloading phase of the recovery operation.)"}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"disk-capacity-release",children:"Disk Capacity Release"}),"\n",(0,i.jsx)(t.p,{children:"When the disk capacity is higher than High Watermark or even Flood Stage, many operations will be prohibited. At this time, you can try to reduce the disk usage and restore the system in the following ways."}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsx)(t.p,{children:"Delete table or partition"}),"\n",(0,i.jsxs)(t.p,{children:["By deleting tables or partitions, you can quickly reduce the disk space usage and restore the cluster.\n",(0,i.jsxs)(t.strong,{children:["Note: Only the ",(0,i.jsx)(t.code,{children:"DROP"})," operation can achieve the purpose of quickly reducing the disk space usage, the ",(0,i.jsx)(t.code,{children:"DELETE"})," operation cannot."]})]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"DROP TABLE tbl;\nALTER TABLE tbl DROP PARTITION p1;\n"})}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsx)(t.p,{children:"BE expansion"}),"\n",(0,i.jsx)(t.p,{children:"After backend expansion, data tablets will be automatically balanced to BE nodes with lower disk usage. The expansion operation will make the cluster reach a balanced state in a few hours or days depending on the amount of data and the number of nodes."}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsx)(t.p,{children:"Modify replica of a table or partition"}),"\n",(0,i.jsxs)(t.p,{children:["You can reduce the number of replica of a table or partition. For example, the default 3 replica can be reduced to 2 replica. Although this method reduces the reliability of the data, it can quickly reduce the disk usage rate and restore the cluster to normal.\nThis method is usually used in emergency recovery systems. Please restore the number of copies to 3 after reducing the disk usage rate by expanding or deleting data after recovery.",(0,i.jsx)(t.br,{}),"\nModifying the replica operation takes effect instantly, and the backends will automatically and asynchronously delete the redundant replica."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:'ALTER TABLE tbl MODIFY PARTITION p1 SET("replication_num" = "2");\n'})}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsx)(t.p,{children:"Delete unnecessary files"}),"\n",(0,i.jsx)(t.p,{children:"When the BE has crashed because the disk is full and cannot be started (this phenomenon may occur due to untimely detection of FE or BE), you need to delete some temporary files in the data directory to ensure that the BE process can start.\nFiles in the following directories can be deleted directly:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"log/: Log files in the log directory."}),"\n",(0,i.jsx)(t.li,{children:"snapshot/: Snapshot files in the snapshot directory."}),"\n",(0,i.jsx)(t.li,{children:"trash/ Trash files in the trash directory."}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsxs)(t.strong,{children:["This operation will affect ",(0,i.jsx)(t.a,{href:"/docs/2.0/admin-manual/data-admin/recyclebin",children:"Restore data from BE Recycle Bin"}),"."]})}),"\n",(0,i.jsxs)(t.p,{children:["If the BE can still be started, you can use ",(0,i.jsx)(t.code,{children:"ADMIN CLEAN TRASH ON(BackendHost:BackendHeartBeatPort);"})," to actively clean up temporary files. ",(0,i.jsx)(t.strong,{children:"all trash files"})," and expired snapshot files will be cleaned up, ",(0,i.jsx)(t.strong,{children:"This will affect the operation of restoring data from the trash bin"}),"."]}),"\n",(0,i.jsxs)(t.p,{children:["If you do not manually execute ",(0,i.jsx)(t.code,{children:"ADMIN CLEAN TRASH"}),", the system will still automatically execute the cleanup within a few minutes to tens of minutes.There are two situations as follows:"]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["If the disk usage does not reach 90% of the ",(0,i.jsx)(t.strong,{children:"Flood Stage"}),", expired trash files and expired snapshot files will be cleaned up. At this time, some recent files will be retained without affecting the recovery of data."]}),"\n",(0,i.jsxs)(t.li,{children:["If the disk usage has reached 90% of the ",(0,i.jsx)(t.strong,{children:"Flood Stage"}),", ",(0,i.jsx)(t.strong,{children:"all trash files"})," and expired snapshot files will be cleaned up, ",(0,i.jsx)(t.strong,{children:"This will affect the operation of restoring data from the trash bin"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:["The time interval for automatic execution can be changed by ",(0,i.jsx)(t.code,{children:"max_garbage_sweep_interval"})," and ",(0,i.jsx)(t.code,{children:"min_garbage_sweep_interval"})," in the configuration items."]}),"\n",(0,i.jsx)(t.p,{children:"When the recovery fails due to lack of trash files, the following results may be returned:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:'{"status": "Fail","msg": "can find tablet path in trash"}\n'})}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsx)(t.p,{children:"Delete data file (dangerous!!!)"}),"\n",(0,i.jsxs)(t.p,{children:["When none of the above operations can free up capacity, you need to delete data files to free up space. The data file is in the ",(0,i.jsx)(t.code,{children:"data/"})," directory of the specified data directory. To delete a tablet, you must first ensure that at least one replica of the tablet is normal, otherwise ",(0,i.jsx)(t.strong,{children:"deleting the only replica will result in data loss"}),"."]}),"\n",(0,i.jsx)(t.p,{children:"Suppose we want to delete the tablet with id 12345:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsxs)(t.p,{children:["Find the directory corresponding to Tablet, usually under ",(0,i.jsx)(t.code,{children:"data/shard_id/tablet_id/"}),". like:"]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.code,{children:"data/0/12345/"})}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsx)(t.p,{children:"Record the tablet id and schema hash. The schema hash is the name of the next-level directory of the previous step. The following is 352781111:"}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.code,{children:"data/0/12345/352781111"})}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsx)(t.p,{children:"Delete the data directory:"}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.code,{children:"rm -rf data/0/12345/"})}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsxs)(t.p,{children:["Delete tablet metadata refer to ",(0,i.jsx)(t.a,{href:"../trouble-shooting/tablet-meta-tool.md",children:"Tablet metadata management tool"})]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.code,{children:"./lib/meta_tool --operation=delete_header --root_path=/path/to/root_path --tablet_id=12345 --schema_hash= 352781111"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]})]})}function h(e={}){let{wrapper:t}={...(0,s.a)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},250065:function(e,t,n){n.d(t,{Z:function(){return l},a:function(){return r}});var a=n(667294);let i={},s=a.createContext(i);function r(e){let t=a.useContext(s);return a.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function l(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),a.createElement(s.Provider,{value:t},e.children)}}}]);