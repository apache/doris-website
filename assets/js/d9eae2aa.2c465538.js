"use strict";(self.webpackChunkdoris_website=self.webpackChunkdoris_website||[]).push([["189583"],{69472:function(e,n,s){s.r(n),s.d(n,{default:()=>h,frontMatter:()=>i,metadata:()=>t,assets:()=>c,toc:()=>l,contentTitle:()=>o});var t=JSON.parse('{"id":"ecosystem/doris-operator/on-alibaba","title":"Recommendations on Alibaba Cloud","description":"Alibaba ACK","source":"@site/docs/ecosystem/doris-operator/on-alibaba.md","sourceDirName":"ecosystem/doris-operator","slug":"/ecosystem/doris-operator/on-alibaba","permalink":"/docs/dev/ecosystem/doris-operator/on-alibaba","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"title":"Recommendations on Alibaba Cloud","language":"en"},"sidebar":"docs","previous":{"title":"Doris Kubernetes Operator","permalink":"/docs/dev/ecosystem/doris-operator/doris-operator-overview"},"next":{"title":"Recommendations on AWS","permalink":"/docs/dev/ecosystem/doris-operator/on-aws"}}'),r=s("785893"),a=s("250065");let i={title:"Recommendations on Alibaba Cloud",language:"en"},o=void 0,c={},l=[{value:"Alibaba ACK",id:"alibaba-ack",level:2},{value:"Already exists cluster",id:"already-exists-cluster",level:3},{value:"Create a new cluster",id:"create-a-new-cluster",level:3},{value:"Alibaba ACS",id:"alibaba-acs",level:2},{value:"Image repository",id:"image-repository",level:3},{value:"Be systemInitialization",id:"be-systeminitialization",level:3},{value:"Service",id:"service",level:3}];function d(e){let n={a:"a",admonition:"admonition",br:"br",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h2,{id:"alibaba-ack",children:"Alibaba ACK"}),"\n",(0,r.jsxs)(n.p,{children:["Alibaba Cloud Container Service ACK is a managed containerized service after purchasing an ECS instance, so you can obtain full access control permissions to adjust related system parameters. Use the instance image: Alibaba Cloud Linux 3. The current system parameters fully meet the requirements for running Doris. Those that do not meet the requirements can also be corrected in the container through the K8s privileged mode to ensure stable operation.",(0,r.jsx)(n.br,{}),"\n",(0,r.jsx)(n.strong,{children:"Alibaba Cloud ACK cluster, deployed using Doris Operator, most environmental requirements can be met by the ECS default configuration. If not met, Doris Operator can correct it by itself"}),". Users can also manually correct it, as follows:"]}),"\n",(0,r.jsx)(n.h3,{id:"already-exists-cluster",children:"Already exists cluster"}),"\n",(0,r.jsxs)(n.p,{children:["If the Container Service cluster has already been created, you can modify it by referring to this document: ",(0,r.jsx)(n.a,{href:"/docs/dev/install/preparation/os-checking",children:"Cluster Environment OS Checking"}),(0,r.jsx)(n.br,{}),"\nFocus on the BE startup parameter requirements:"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Disable and close swap: ",(0,r.jsx)(n.code,{children:"swapon --show"})," will not be output if it is not enabled"]}),"\n",(0,r.jsxs)(n.li,{children:["Check the maximum number of open file handles in the system ",(0,r.jsx)(n.code,{children:"ulimit -n"})]}),"\n",(0,r.jsxs)(n.li,{children:["Check and modify the number of virtual memory areas ",(0,r.jsx)(n.code,{children:"sysctl vm.max_map_count"})]}),"\n",(0,r.jsxs)(n.li,{children:["Whether transparent huge pages are closed ",(0,r.jsx)(n.code,{children:"cat /sys/kernel/mm/transparent_hugepage/enabled"})," contains never",(0,r.jsx)(n.br,{}),"\nThe default values of the corresponding parameters are as follows:"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"[root@iZj6c12a1czxk5oer9rbp8Z ~]# swapon --show\n[root@iZj6c12a1czxk5oer9rbp8Z ~]# ulimit -n\n65535\n[root@iZj6c12a1czxk5oer9rbp8Z ~]# sysctl vm.max_map_count\nvm.max_map_count = 262144\n[root@iZj6c12a1czxk5oer9rbp8Z ~]# cat /sys/kernel/mm/transparent_hugepage/enabled\n[always] madvise never\n"})}),"\n",(0,r.jsx)(n.h3,{id:"create-a-new-cluster",children:"Create a new cluster"}),"\n",(0,r.jsx)(n.p,{children:'If the cluster has not been purchased and created, you can click "Create Cluster" in the Alibaba Cloud Container Service ACK console to purchase it. You can adjust the configuration as needed. The above parameters can be added to the system adjustment script in "Instance Pre-customized Data" in the "Node Pool Configuration" step of creating a cluster.\nAfter the cluster is started, restart the node to complete the configuration. The reference script is as follows:'}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:'#!/bin/bash\nchmod +x /etc/rc.d/rc.local\necho "sudo systemctl stop firewalld.service" >> /etc/rc.d/rc.local\necho "sudo systemctl disable firewalld.service" >> /etc/rc.d/rc.local\necho "sysctl -w vm.max_map_count=2000000" >> /etc/rc.d/rc.local\necho "swapoff -a" >> /etc/rc.d/rc.local\ncurrent_limit=$(ulimit -n)\ndesired_limit=1000000\nconfig_file="/etc/security/limits.conf"\n if [ "$current_limit" -ne "$desired_limit" ]; then\n    echo "* soft nofile 1000000" >> "$config_file"\n    echo "* hard nofile 1000000" >> "$config_file"\nfi\n'})}),"\n",(0,r.jsx)(n.h2,{id:"alibaba-acs",children:"Alibaba ACS"}),"\n",(0,r.jsx)(n.p,{children:"The ACS service is a cloud computing service that uses K8s as the user interface to provide container computing resources, providing elastic computing resources that are billed on demand. Unlike the above ACK, you do not need to pay attention to the specific use of ECS.\nThe following points should be noted when using ACS:"}),"\n",(0,r.jsx)(n.h3,{id:"image-repository",children:"Image repository"}),"\n",(0,r.jsxs)(n.p,{children:["When using ACS, it is recommended to use the supporting Alibaba  ",(0,r.jsx)(n.a,{href:"https://www.alibabacloud.com/en/product/container-registry",children:"Container Registry"}),"(ACR). The personal and enterprise versions are enabled on demand."]}),"\n",(0,r.jsx)(n.p,{children:"After configuring the ACR and image transfer environment, you need to migrate the official image provided by Doris to the corresponding ACR."}),"\n",(0,r.jsx)(n.p,{children:"If you use a private ACR to enable authentication, you can refer to the following steps:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["You need to set a ",(0,r.jsx)(n.code,{children:"secret"})," of type ",(0,r.jsx)(n.code,{children:"docker-registry"})," in advance to configure the authentication information for accessing the image warehouse."]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"kubectl create secret docker-registry image-hub-secret --docker-server={your-server} --docker-username={your-username} --docker-password={your-pwd}\n"})}),"\n",(0,r.jsxs)(n.ol,{start:"2",children:["\n",(0,r.jsx)(n.li,{children:"Configure the secret using the above steps on DCR:"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"spec:\n  feSpec:\n    replicas: 1\n    image: crpi-4q6quaxa0ta96k7h-vpc.cn-hongkong.personal.cr.aliyuncs.com/selectdb-test/doris.fe-ubuntu:3.0.3\n    imagePullSecrets:\n    - name: image-hub-secret\n  beSpec:\n    replicas: 3\n    image: crpi-4q6quaxa0ta96k7h-vpc.cn-hongkong.personal.cr.aliyuncs.com/selectdb-test/doris.be-ubuntu:3.0.3\n    imagePullSecrets:\n    - name: image-hub-secret\n    systemInitialization:\n      initImage: crpi-4q6quaxa0ta96k7h-vpc.cn-hongkong.personal.cr.aliyuncs.com/selectdb-test/alpine:latest\n"})}),"\n",(0,r.jsx)(n.h3,{id:"be-systeminitialization",children:"Be systemInitialization"}),"\n",(0,r.jsxs)(n.p,{children:["Currently, Alibaba Cloud is gradually pushing the ability to enable privileged mode on fully managed ACS services (some regions may not be enabled yet, you can submit a work order to apply for the ability to be enabled).",(0,r.jsx)(n.br,{}),"\nThe Doris BE node startup requires some special environment parameters, such as Modify the number of virtual memory areas ",(0,r.jsx)(n.code,{children:"sysctl -w vm.max_map_count=2000000"}),(0,r.jsx)(n.br,{}),"\nSetting this parameter inside the container requires modifying the host configuration, so regular K8s clusters need to enable privileged mode in the pod. Operator adds ",(0,r.jsx)(n.code,{children:"InitContainer"})," to the BE pod through ",(0,r.jsx)(n.code,{children:"systemInitialization"})," to perform such operations."]}),"\n",(0,r.jsx)(n.admonition,{title:"Tip",type:"tip",children:(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"If the current cluster cannot use privileged mode, the BE node cannot be started"}),". You can choose ACK container service + host to deploy the cluster."]})}),"\n",(0,r.jsx)(n.h3,{id:"service",children:"Service"}),"\n",(0,r.jsx)(n.p,{children:"Since the ACS service is a cloud computing service that uses K8s as the user interface to provide container computing resources, it provides computing resources. Its nodes are virtual computing resources, and users do not need to pay attention to them. They are charged according to the amount of resources used, and can be expanded infinitely. That is, there is no physical concept of conventional nodes:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"$ kubectl get nodes\nNAME                            STATUS   ROLES   AGE   VERSION\nvirtual-kubelet-cn-hongkong-d   Ready    agent   27h   v1.31.1-aliyun.1\n"})}),"\n",(0,r.jsx)(n.p,{children:"Therefore, when deploying the Doris cluster, serviceType disables the NodePort mode and allows the use of ClusterIP and LB modes."}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"ClusterIP mode:"}),"\n",(0,r.jsxs)(n.p,{children:["ClusterIP modethe default network mode of Operator. For specific usage and access methods, please refer to ",(0,r.jsx)(n.a,{href:"https://kubernetes.io/docs/concepts/services-networking/service/#type-clusterip",children:"this document"})]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Load balancing mode:"}),"\n",(0,r.jsx)(n.p,{children:"can be configured as follows:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Configure LB access through the DCR service annotations provided by Operator. The steps are as follows:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["A CLB or NLB instance has been created through the load balancing console, and the instance is in the same region as the ACK cluster. If you haven't created one yet, see ",(0,r.jsx)(n.a,{href:"https://www.alibabacloud.com/help/en/slb/classic-load-balancer/user-guide/create-and-manage-a-clb-instance",children:"Create and manage a CLB instance"})," and ",(0,r.jsx)(n.a,{href:"https://www.alibabacloud.com/help/en/slb/network-load-balancer/user-guide/create-and-manage-an-nlb-instance",children:"Create and manage an NLB instance"}),"\u3002"]}),"\n",(0,r.jsx)(n.li,{children:"Through DCR configuration, the access annotations of the above LB are in the following format:"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'  feSpec:\n    replicas: 3\n    image: crpi-4q6quaxa0ta96k7h-vpc.cn-hongkong.personal.cr.aliyuncs.com/selectdb-test/doris.fe-ubuntu:3.0.3\n    service:\n      type: LoadBalancer\n      annotations:\n        service.beta.kubernetes.io/alibaba-cloud-loadbalancer-address-type: "intranet"\n'})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Host the LB service through the ACS console and generate a statefulset service bound to the corresponding resource control of FE or BE",(0,r.jsx)(n.br,{}),"\nThe steps are as follows:"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"serviceType is ClusterIP (default policy)"}),"\n",(0,r.jsxs)(n.li,{children:["You can create a load balancing service through the Alibaba Cloud console interface: Container Compute Service ACS -> Cluster List -> Cluster -> Service, and use the ",(0,r.jsx)(n.code,{children:"Create"})," button."]}),"\n",(0,r.jsxs)(n.li,{children:["Select the newly created LB in the interface for creating ",(0,r.jsx)(n.code,{children:"service"}),", which will be bound to ",(0,r.jsx)(n.code,{children:"service"})," and will also be deregistered when the ",(0,r.jsx)(n.code,{children:"service"})," is deregistered. However, this ",(0,r.jsx)(n.code,{children:"service"})," is not controlled by Doris Operator."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]})]})}function h(e={}){let{wrapper:n}={...(0,a.a)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},250065:function(e,n,s){s.d(n,{Z:function(){return o},a:function(){return i}});var t=s(667294);let r={},a=t.createContext(r);function i(e){let n=t.useContext(a);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);