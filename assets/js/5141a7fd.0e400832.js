"use strict";(self.webpackChunkdoris_website=self.webpackChunkdoris_website||[]).push([["430453"],{279663:function(e,t,n){n.r(t),n.d(t,{default:()=>h,frontMatter:()=>l,metadata:()=>s,assets:()=>o,toc:()=>r,contentTitle:()=>c});var s=JSON.parse('{"id":"query-acceleration/optimization-technology-principle/statistics","title":"Statistics","description":"Starting from version 2.0, Doris integrated Cost-Based Optimization (CBO) capabilities into its optimizer. Statistics are the cornerstone of CBO, and their accuracy directly determines the accuracy of cost estimation, which is crucial for selecting the optimal execution plan. This document serves as a guide to statistical usage for unreleased development version, focusing on the collection and management methods, relevant configuration options, and frequently asked questions.","source":"@site/docs/query-acceleration/optimization-technology-principle/statistics.md","sourceDirName":"query-acceleration/optimization-technology-principle","slug":"/query-acceleration/optimization-technology-principle/statistics","permalink":"/docs/dev/query-acceleration/optimization-technology-principle/statistics","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"title":"Statistics","language":"en"},"sidebar":"docs","previous":{"title":"TOPN Query Optimization","permalink":"/docs/dev/query-acceleration/optimization-technology-principle/topn-optimization"},"next":{"title":"AI Function","permalink":"/docs/dev/ai/ai-function-overview"}}'),i=n("785893"),a=n("250065");let l={title:"Statistics",language:"en"},c=void 0,o={},r=[{value:"Collection of Statistics",id:"collection-of-statistics",level:2},{value:"Manual Collection",id:"manual-collection",level:3},{value:"Automatic Collection",id:"automatic-collection",level:3},{value:"External Table Collection",id:"external-table-collection",level:3},{value:"Statistics Job Management",id:"statistics-job-management",level:2},{value:"Viewing Statistics Jobs",id:"viewing-statistics-jobs",level:3},{value:"Viewing Statistics Tasks",id:"viewing-statistics-tasks",level:3},{value:"Viewing Statistics",id:"viewing-statistics",level:3},{value:"Viewing Table Statistics Overview",id:"viewing-table-statistics-overview",level:3},{value:"Killing Statistics Jobs",id:"killing-statistics-jobs",level:3},{value:"Deleting Statistics",id:"deleting-statistics",level:3},{value:"Session Variables and Configuration Options",id:"session-variables-and-configuration-options",level:2},{value:"Session Variables",id:"session-variables",level:3},{value:"FE Configuration",id:"fe-configuration",level:3},{value:"FAQs",id:"faqs",level:2},{value:"Q1: How can I check if statistics have been collected for a table and if the content is correct?",id:"q1-how-can-i-check-if-statistics-have-been-collected-for-a-table-and-if-the-content-is-correct",level:3},{value:"Q2: Why are statistics not being automatically collected for a table?",id:"q2-why-are-statistics-not-being-automatically-collected-for-a-table",level:3},{value:"Q3: Why are statistics not available for some columns?",id:"q3-why-are-statistics-not-available-for-some-columns",level:3},{value:"Q4: Error: &quot;Stats table not available, please make sure your cluster status is normal&quot;",id:"q4-error-stats-table-not-available-please-make-sure-your-cluster-status-is-normal",level:3},{value:"Q5: How can I address the issue of untimely statistics collection?",id:"q5-how-can-i-address-the-issue-of-untimely-statistics-collection",level:3},{value:"Q6: How can I address excessive resource usage during automatic collection?",id:"q6-how-can-i-address-excessive-resource-usage-during-automatic-collection",level:3}];function d(e){let t={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,a.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.p,{children:"Starting from version 2.0, Doris integrated Cost-Based Optimization (CBO) capabilities into its optimizer. Statistics are the cornerstone of CBO, and their accuracy directly determines the accuracy of cost estimation, which is crucial for selecting the optimal execution plan. This document serves as a guide to statistical usage for unreleased development version, focusing on the collection and management methods, relevant configuration options, and frequently asked questions."}),"\n",(0,i.jsx)(t.h2,{id:"collection-of-statistics",children:"Collection of Statistics"}),"\n",(0,i.jsx)(t.p,{children:"Doris enables the automatic sampling collection of internal tables by default. Therefore, in most cases, users don't need to pay attention to the collection of statistical information. Doris collects statistics at the column level for each table. The information collected includes:"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{children:"Info of Statistics"}),(0,i.jsx)(t.th,{children:"Description"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"row_count"}),(0,i.jsx)(t.td,{children:"Total number of rows"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"data_size"}),(0,i.jsx)(t.td,{children:"Total data size of the column"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"avg_size_byte"}),(0,i.jsx)(t.td,{children:"Average data size per row for the column"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"ndv"}),(0,i.jsx)(t.td,{children:"Number of distinct values"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"min"}),(0,i.jsx)(t.td,{children:"Minimum value"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"max"}),(0,i.jsx)(t.td,{children:"Maximum value"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"null_count"}),(0,i.jsx)(t.td,{children:"Number of null values"})]})]})]}),"\n",(0,i.jsx)(t.p,{children:"Currently, the system only supports collecting statistics for columns of basic data types, including BOOLEAN, TINYINT, SMALLINT, INT, BIGINT, LARGEINT, FLOAT, DOUBLE, DATE, DATETIME, STRING, VARCHAR, TEXT, among others."}),"\n",(0,i.jsx)(t.p,{children:"Columns of complex types, such as JSONB, VARIANT, MAP, STRUCT, ARRAY, HLL, BITMAP, TIME, TIMEV2, are skipped."}),"\n",(0,i.jsxs)(t.p,{children:["Statistics can be collected manually or automatically, and the results are stored in the ",(0,i.jsx)(t.code,{children:"internal.__internal_schema.column_statistics"})," table. The following sections detail these two collection methods."]}),"\n",(0,i.jsx)(t.h3,{id:"manual-collection",children:"Manual Collection"}),"\n",(0,i.jsx)(t.p,{children:"Doris allows users to manually trigger the collection and update of statistics by submitting an ANALYZE statement."}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.strong,{children:"1. Syntax"})}),"\n",(0,i.jsxs)(t.p,{children:["Please refer to SQL manual ",(0,i.jsx)(t.a,{href:"../../sql-manual/sql-statements/statistics/ANALYZE",children:"ANALYZE"})]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.strong,{children:"2. Examples"})}),"\n",(0,i.jsxs)(t.p,{children:["Collect statistics for all columns in the ",(0,i.jsx)(t.code,{children:"lineitem"})," table:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"ANALYZE TABLE lineitem;\n"})}),"\n",(0,i.jsxs)(t.p,{children:["Collect statistics for all columns in all tables in the ",(0,i.jsx)(t.code,{children:"tpch100"})," database:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"ANALYZE DATABASE tpch100;\n"})}),"\n",(0,i.jsxs)(t.p,{children:["Collect statistics for the ",(0,i.jsx)(t.code,{children:"l_orderkey"})," and ",(0,i.jsx)(t.code,{children:"l_linenumber"})," columns in the ",(0,i.jsx)(t.code,{children:"lineitem"})," table by sampling 100,000 rows (note: the correct syntax should be used ",(0,i.jsx)(t.code,{children:"WITH SAMPLE ROWS"})," or ",(0,i.jsx)(t.code,{children:"WITH SAMPLE PERCENT"}),"):"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"ANALYZE TABLE lineitem WITH SAMPLE ROWS 100000;\n"})}),"\n",(0,i.jsx)(t.h3,{id:"automatic-collection",children:"Automatic Collection"}),"\n",(0,i.jsxs)(t.p,{children:["Automatic collection is supported from version 2.0.3 onwards and is enabled by default throughout the day. Users can control the feature's activation or deactivation by setting the ",(0,i.jsx)(t.code,{children:"ENABLE_AUTO_ANALYZE"})," variable:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"SET GLOBAL ENABLE_AUTO_ANALYZE = TRUE; // Enable automatic collection  \nSET GLOBAL ENABLE_AUTO_ANALYZE = FALSE; // Disable automatic collection\n"})}),"\n",(0,i.jsxs)(t.p,{children:["When enabled, a background thread periodically scans all tables in the ",(0,i.jsx)(t.code,{children:"InternalCatalog"})," within the cluster. For tables requiring statistics collection, the system automatically creates and executes collection jobs without manual intervention."]}),"\n",(0,i.jsxs)(t.p,{children:["To avoid excessive resource usage for collection wide tables' statistics, tables with more than 300 columns are not automatically collected by default. Users can adjust this threshold by modifying the session variable ",(0,i.jsx)(t.code,{children:"auto_analyze_table_width_threshold"}),":"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"SET GLOBAL auto_analyze_table_width_threshold = 350;\n"})}),"\n",(0,i.jsxs)(t.p,{children:["The default polling interval for automatic collection is 5 minutes (adjustable via the ",(0,i.jsx)(t.code,{children:"auto_check_statistics_in_minutes"})," configuration in ",(0,i.jsx)(t.code,{children:"fe.conf"}),"). The first iteration starts 5 minutes after cluster startup. After all tables requiring collection are processed, the background thread sleeps for 5 minutes before starting the next iteration. Therefore, there is no guarantee that a table will have its statistics collected within 5 minutes, as the time to iterate through all tables can vary based on the number and size of tables."]}),"\n",(0,i.jsx)(t.p,{children:"When a table is polled, the system first determines if statistical collection is required. If so, a collection job is created and executed; otherwise, the table is skipped. Statistics collection is required if:"}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsx)(t.p,{children:"The table has columns without statistics."}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsxs)(t.p,{children:["The table's health is below the threshold (default 90, adjustable via ",(0,i.jsx)(t.code,{children:"table_stats_health_threshold"}),"). Health indicates the percentage of data that has remained unchanged since the last statistics collection: 100 indicates no change; 0 indicates all changes; a health below 90 indicates significant deviation in current statistics, necessitating re-collection."]}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsx)(t.p,{children:"For internal tables, the data has changed, but no statistical information has been collected within the last 24 hours"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:["To reduce background job overhead and improve collection speed, automatic collection uses sampling by default, sampling 4,194,304 (",(0,i.jsx)(t.code,{children:"2^22"}),") rows. Users can adjust the sampling size by modifying ",(0,i.jsx)(t.code,{children:"huge_table_default_sample_rows"})," for more accurate data distribution information."]}),"\n",(0,i.jsxs)(t.p,{children:["To prevent automatic collection jobs from interfering with business operations, users can specify the execution window for automatic collection based on their requirements by setting ",(0,i.jsx)(t.code,{children:"auto_analyze_start_time"})," and ",(0,i.jsx)(t.code,{children:"auto_analyze_end_time"}),":"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:'SET GLOBAL auto_analyze_start_time = "03:00:00"; // Set the start time to 3 AM  \nSET GLOBAL auto_analyze_end_time = "14:00:00"; // Set the end time to 2 PM\n'})}),"\n",(0,i.jsx)(t.h3,{id:"external-table-collection",children:"External Table Collection"}),"\n",(0,i.jsx)(t.p,{children:"External tables typically include Hive, Iceberg, JDBC, and other types."}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsx)(t.p,{children:"Manual Collection: Hive, Iceberg, and JDBC tables support manual statistics collection. Hive tables support both full and sampled collection, while Iceberg and JDBC tables only support full collection. Other external table types do not support manual collection."}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsx)(t.p,{children:"Automatic Collection: Currently, only Hive tables are supported."}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"External Catalogs do not participate in automatic column statistics collection by default because they often contain large amounts of historical data, which could consume excessive resources during automatic collection. In cases where there is indeed a need, you can enable or disable automatic column statistics collection for an external Catalog by setting its properties:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"ALTER CATALOG external_catalog SET PROPERTIES ('enable.auto.analyze'='true'); // Enable automatic column statistics collection\nALTER CATALOG external_catalog SET PROPERTIES ('enable.auto.analyze'='false'); // Disable automatic column statistics collection\n"})}),"\n",(0,i.jsx)(t.p,{children:"If the granularity of controlling the entire Catalog is too large, we also support enable and disable column statistical collection at the table level."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:'ALTER TABLE <table_name> SET ("auto_analyze_policy" = "enable"); // Enable automatic collection of column statistical for this table (the priority is higher than the enable.auto.analyze property of the Catalog).\nALTER TABLE <table_name> SET ("auto_analyze_policy" = "disable"); // Disnable automatic collection of column statistical for this table (the priority is higher than the enable.auto.analyze property of the Catalog).\nALTER TABLE <table_name> SET ("auto_analyze_policy" = "base_on_catalog"); // It is determined by the enable.auto.analyze property of the table\'s Catalog.\n'})}),"\n",(0,i.jsxs)(t.p,{children:["External tables do not have the concept of health. When automatic collection column statistic is enabled for a Catalog/Table, the system defaults to collecting statistics for an external table at most once every 24 hours to avoid frequent collection. You can adjust the minimum collection interval for external tables using the ",(0,i.jsx)(t.code,{children:"external_table_auto_analyze_interval_in_millis"})," variable."]}),"\n",(0,i.jsx)(t.p,{children:"By default, external tables do not collect column statistics, the system only attempts to obtain table's row count information. The methods for collecting row count information for different external tables are as follows."}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.strong,{children:"1. For Hive Tables:"})}),"\n",(0,i.jsxs)(t.p,{children:["Doris first attempts to retrieve ",(0,i.jsx)(t.code,{children:"numRows"})," or ",(0,i.jsx)(t.code,{children:"totalSize"})," information from the Hive table's Parameters:"]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsxs)(t.p,{children:["If ",(0,i.jsx)(t.code,{children:"numRows"})," is found, its value is used as the table's row count."]}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsxs)(t.p,{children:["If ",(0,i.jsx)(t.code,{children:"numRows"})," is not found but ",(0,i.jsx)(t.code,{children:"totalSize"})," is available, the row count is estimated based on the table's schema and ",(0,i.jsx)(t.code,{children:"totalSize"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsxs)(t.p,{children:["If ",(0,i.jsx)(t.code,{children:"totalSize"})," is also unavailable, by default, the system will estimate the number of rows based on the file size corresponding to the Hive table and its Schema. If there are concerns that obtaining the file size may consume excessive resources, this function can be disabled by setting the following variables."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"SET GLOBAL enable_get_row_count_from_file_list = FALSE\n"})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.strong,{children:"2. For Iceberg Tables:"})}),"\n",(0,i.jsxs)(t.p,{children:["Doris calls the Iceberg snapshot API to retrieve ",(0,i.jsx)(t.code,{children:"total-records"})," and ",(0,i.jsx)(t.code,{children:"total-position-deletes"})," information to calculate the table's row count."]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.strong,{children:"3. For Paimon Tables:"})}),"\n",(0,i.jsx)(t.p,{children:"Doris calls Paimon's scan API to obtain the number of rows contained in each Split and calculate the row count of the table by summing up the rows of the Splits."}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.strong,{children:"4. For JDBC Tables:"})}),"\n",(0,i.jsx)(t.p,{children:"Doris sends SQL of reading table statistics to remote database to get table row count. This can only be achieved when the remote database has collected the row count information of the table. Currently, Doris supports retrieving the row count of tables in MySQL, Oracle, PostgreSQL and SQLServer."}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.strong,{children:"5. For Other External Tables:"})}),"\n",(0,i.jsx)(t.p,{children:"Automatic row count acquisition and estimation are currently not supported."}),"\n",(0,i.jsxs)(t.p,{children:["Users can view the estimated row count for external tables using the following command (see ",(0,i.jsx)(t.code,{children:"Viewing Table Statistics Overview"})," for more detail):"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"SHOW table stats table_name;\n"})}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["If ",(0,i.jsx)(t.code,{children:"row_count"})," displays as ",(0,i.jsx)(t.code,{children:"-1"}),", row count information could not be obtained or the table is empty."]}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"statistics-job-management",children:"Statistics Job Management"}),"\n",(0,i.jsx)(t.h3,{id:"viewing-statistics-jobs",children:"Viewing Statistics Jobs"}),"\n",(0,i.jsxs)(t.p,{children:["Use ",(0,i.jsx)(t.code,{children:"SHOW ANALYZE"})," to view information about statistics collection jobs. Currently, the system retains information for only 20,000 historical jobs. Note that only information for asynchronous jobs can be viewed using this command; synchronous jobs (using ",(0,i.jsx)(t.code,{children:"WITH SYNC"}),") do not retain historical job information."]}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.strong,{children:"1. Syntax"}),":"]}),"\n",(0,i.jsxs)(t.p,{children:["Please refer to SQL manual ",(0,i.jsx)(t.a,{href:"../../sql-manual/sql-statements/statistics/SHOW-ANALYZE",children:"SHOW ANALYZE"})]}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.strong,{children:"2. Output"}),":"]}),"\n",(0,i.jsx)(t.p,{children:"Includes the following columns:"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{children:"Column Name"}),(0,i.jsx)(t.th,{children:"Description"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"job_id"}),(0,i.jsx)(t.td,{children:"Statistics job ID"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"catalog_name"}),(0,i.jsx)(t.td,{children:"Catalog name"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"db_name"}),(0,i.jsx)(t.td,{children:"Database name"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"tbl_name"}),(0,i.jsx)(t.td,{children:"Table name"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"col_name"}),(0,i.jsx)(t.td,{children:"List of column names (index_name:column_name)"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"job_type"}),(0,i.jsx)(t.td,{children:"Job type"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"analysis_type"}),(0,i.jsx)(t.td,{children:"Statistics type"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"message"}),(0,i.jsx)(t.td,{children:"Job information"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"state"}),(0,i.jsx)(t.td,{children:"Job state"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"progress"}),(0,i.jsx)(t.td,{children:"Job progress"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"schedule_type"}),(0,i.jsx)(t.td,{children:"Scheduling type"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"start_time"}),(0,i.jsx)(t.td,{children:"Job start time"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"end_time"}),(0,i.jsx)(t.td,{children:"Job end time"})]})]})]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.strong,{children:"3. Example:"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"mysql show analyze 245073\\G;\n*************************** 1. row ***************************\n              job_id: 93021\n        catalog_name: internal\n             db_name: tpch\n            tbl_name: region\n            col_name: [region:r_regionkey,region:r_comment,region:r_name]\n            job_type: MANUAL\n       analysis_type: FUNDAMENTALS\n             message: \n               state: FINISHED\n            progress: 3 Finished  |  0 Failed  |  0 In Progress  |  3 Total\n       schedule_type: ONCE\n          start_time: 2024-07-11 15:15:00\n            end_time: 2024-07-11 15:15:33\n"})}),"\n",(0,i.jsx)(t.h3,{id:"viewing-statistics-tasks",children:"Viewing Statistics Tasks"}),"\n",(0,i.jsx)(t.p,{children:"Each collection job can contain one or more tasks, with each task corresponding to the collection of a single column. Users can view the completion status of statistics collection for each column using the following command."}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.strong,{children:"1. Syntax:"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"SHOW ANALYZE TASK STATUS [job_id]\n"})}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.strong,{children:"2. Example:"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"mysql> show analyze task status 93021;\n+---------+-------------+------------+---------+------------------------+-----------------+----------+\n| task_id | col_name    | index_name | message | last_state_change_time | time_cost_in_ms | state    |\n+---------+-------------+------------+---------+------------------------+-----------------+----------+\n| 93022   | r_regionkey | region     |         | 2024-07-11 15:15:33    | 32883           | FINISHED |\n| 93023   | r_comment   | region     |         | 2024-07-11 15:15:33    | 32883           | FINISHED |\n| 93024   | r_name      | region     |         | 2024-07-11 15:15:33    | 32883           | FINISHED |\n+---------+-------------+------------+---------+------------------------+-----------------+----------+\n"})}),"\n",(0,i.jsx)(t.h3,{id:"viewing-statistics",children:"Viewing Statistics"}),"\n",(0,i.jsxs)(t.p,{children:["Users can view collected column statistics using the ",(0,i.jsx)(t.code,{children:"SHOW COLUMN STATS"})," command."]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.strong,{children:"1. Syntax:"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"SHOW COLUMN [cached] STATS table_name [ (column_name [, ...]) ];\n"})}),"\n",(0,i.jsx)(t.p,{children:"Where:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.code,{children:"cached"}),": Displays statistics currently cached in the FE memory."]}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.code,{children:"table_name"}),": Target table for which statistics were collected, can be in the form ",(0,i.jsx)(t.code,{children:"db_name.table_name"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.code,{children:"column_name"}),": Specified target column, must exist in ",(0,i.jsx)(t.code,{children:"table_name"}),", multiple column names separated by commas. If unspecified, displays information for all columns."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.strong,{children:"2. Example:"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"mysql> show column stats region (r_regionkey)\\G\n*************************** 1. row ***************************\n  column_name: r_regionkey\n   index_name: region\n        count: 5.0\n          ndv: 5.0\n     num_null: 0.0\n    data_size: 20.0\navg_size_byte: 4.0\n          min: 0\n          max: 4\n       method: FULL\n         type: FUNDAMENTALS\n      trigger: MANUAL\n  query_times: 0\n updated_time: 2024-07-11 15:15:33\n1 row in set (0.36 sec)\n"})}),"\n",(0,i.jsx)(t.h3,{id:"viewing-table-statistics-overview",children:"Viewing Table Statistics Overview"}),"\n",(0,i.jsxs)(t.p,{children:["Use ",(0,i.jsx)(t.code,{children:"SHOW TABLE STATS"})," to view an overview of table statistics collection."]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.strong,{children:"1. Syntax:"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"SHOW TABLE STATS table_name;\n"})}),"\n",(0,i.jsxs)(t.p,{children:["Where: ",(0,i.jsx)(t.code,{children:"table_name"}),": Target table name, can be in the form ",(0,i.jsx)(t.code,{children:"db_name.table_name"}),"."]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.strong,{children:"2. Output:"})}),"\n",(0,i.jsx)(t.p,{children:"Includes the following columns:"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{children:"Column Name"}),(0,i.jsx)(t.th,{children:"Description"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"updated_rows"}),(0,i.jsx)(t.td,{children:"Number of rows updated in the table since the last ANALYZE"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"query_times"}),(0,i.jsx)(t.td,{children:"Reserved column, for recording the number of queries on the table in future versions"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"row_count"}),(0,i.jsx)(t.td,{children:"Number of rows in the table (may not reflect the exact count at command execution)"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"updated_time"}),(0,i.jsx)(t.td,{children:"Time of the last statistics update"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"columns"}),(0,i.jsx)(t.td,{children:"Columns for which statistics have been collected"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"trigger"}),(0,i.jsx)(t.td,{children:"Method by which statistics were triggered"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"new_partition"}),(0,i.jsx)(t.td,{children:"Whether there are new partitions with first-time data imports"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"user_inject"}),(0,i.jsx)(t.td,{children:"Whether statistics were manually injected by the user"})]})]})]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.strong,{children:"3. Example:"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"mysql> show column stats region (r_regionkey)\\G\n*************************** 1. row ***************************\n  column_name: r_regionkey\n   index_name: region\n        count: 5.0\n          ndv: 5.0\n     num_null: 0.0\n    data_size: 20.0\navg_size_byte: 4.0\n          min: 0\n          max: 4\n       method: FULL\n         type: FUNDAMENTALS\n      trigger: MANUAL\n  query_times: 0\n updated_time: 2024-07-11 15:15:33\n1 row in set (0.36 sec)\n"})}),"\n",(0,i.jsx)(t.h3,{id:"killing-statistics-jobs",children:"Killing Statistics Jobs"}),"\n",(0,i.jsxs)(t.p,{children:["Use ",(0,i.jsx)(t.code,{children:"KILL ANALYZE"})," to terminate a currently running asynchronous statistics job."]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.strong,{children:"1. Syntax:"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"KILL ANALYZE job_id;\n"})}),"\n",(0,i.jsxs)(t.p,{children:["Where: ",(0,i.jsx)(t.code,{children:"job_id"}),": The ID of the statistics job. This is the value returned when executing an asynchronous statistics collection with ",(0,i.jsx)(t.code,{children:"ANALYZE"})," or obtained using the ",(0,i.jsx)(t.code,{children:"SHOW ANALYZE"})," statement."]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.strong,{children:"2. Example:"})}),"\n",(0,i.jsx)(t.p,{children:"Terminate the statistics job with ID 52357."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"mysql> KILL ANALYZE 52357;\n"})}),"\n",(0,i.jsx)(t.h3,{id:"deleting-statistics",children:"Deleting Statistics"}),"\n",(0,i.jsx)(t.p,{children:"If a Catalog, Database, or Table is deleted, users do not need to manually delete its statistics as the background process will periodically clean up this information."}),"\n",(0,i.jsx)(t.p,{children:"However, for tables that still exist, the system does not automatically clear their statistics. In this case, users need to manually delete them using the following syntax:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"DROP STATS table_name\n"})}),"\n",(0,i.jsx)(t.h2,{id:"session-variables-and-configuration-options",children:"Session Variables and Configuration Options"}),"\n",(0,i.jsx)(t.h3,{id:"session-variables",children:"Session Variables"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{children:"Session Variable"}),(0,i.jsx)(t.th,{children:"Description"}),(0,i.jsx)(t.th,{children:"Default Value"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"auto_analyze_start_time"}),(0,i.jsx)(t.td,{children:"Start time for automatic statistics collection"}),(0,i.jsx)(t.td,{children:"0:00:00"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"auto_analyze_end_time"}),(0,i.jsx)(t.td,{children:"End time for automatic statistics collection"}),(0,i.jsx)(t.td,{children:"23:59:59"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"enable_auto_analyze"}),(0,i.jsx)(t.td,{children:"Whether to enable automatic collection functionality"}),(0,i.jsx)(t.td,{children:"TRUE"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"huge_table_default_sample_rows"}),(0,i.jsx)(t.td,{children:"Number of rows to sample for large tables"}),(0,i.jsx)(t.td,{children:"4194304"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"table_stats_health_threshold"}),(0,i.jsx)(t.td,{children:"Value range 0-100, indicating the percentage of data updated since the last statistics collection (100 - table_stats_health_threshold)% at which statistics are considered outdated"}),(0,i.jsx)(t.td,{children:"90"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"auto_analyze_table_width_threshold"}),(0,i.jsx)(t.td,{children:"Controls the maximum table width for automatic statistics collection, tables exceeding this column count do not participate in automatic statistics collection"}),(0,i.jsx)(t.td,{children:"300"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"enable_get_row_count_from_file_list"}),(0,i.jsx)(t.td,{children:"Whether to estimate row counts for Hive tables based on file sizes"}),(0,i.jsx)(t.td,{children:"FALSE (TRUE by default after 2.1.5)"})]})]})]}),"\n",(0,i.jsx)(t.h3,{id:"fe-configuration",children:"FE Configuration"}),"\n",(0,i.jsx)(t.admonition,{title:"Note",type:"info",children:(0,i.jsx)(t.p,{children:"The following FE configuration options typically do not require special attention."})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{children:"FE Configuration Option"}),(0,i.jsx)(t.th,{children:"Description"}),(0,i.jsx)(t.th,{children:"Default Value"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"analyze_record_limit"}),(0,i.jsx)(t.td,{children:"Controls the number of persistent rows for statistics job execution records"}),(0,i.jsx)(t.td,{children:"20000"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"stats_cache_size"}),(0,i.jsx)(t.td,{children:"Number of statistics entries cached on the FE side"}),(0,i.jsx)(t.td,{children:"500000"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"statistics_simultaneously_running_task_num"}),(0,i.jsx)(t.td,{children:"Number of asynchronous statistics jobs that can run simultaneously"}),(0,i.jsx)(t.td,{children:"3"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"statistics_sql_mem_limit_in_bytes"}),(0,i.jsx)(t.td,{children:"Controls the amount of BE memory each statistics SQL can occupy"}),(0,i.jsx)(t.td,{children:"2L * 1024 * 1024 (2GiB)"})]})]})]}),"\n",(0,i.jsx)(t.h2,{id:"faqs",children:"FAQs"}),"\n",(0,i.jsx)(t.h3,{id:"q1-how-can-i-check-if-statistics-have-been-collected-for-a-table-and-if-the-content-is-correct",children:"Q1: How can I check if statistics have been collected for a table and if the content is correct?"}),"\n",(0,i.jsxs)(t.p,{children:["First, execute ",(0,i.jsx)(t.code,{children:"show column stats table_name"})," to see if there are any statistical outputs."]}),"\n",(0,i.jsxs)(t.p,{children:["Next, execute ",(0,i.jsx)(t.code,{children:"show column cached stats table_name"})," to check if the statistics for the table are loaded into the cache."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"mysql> show column stats test_table\\G\nEmpty set (0.02 sec)\n\nmysql> show column cached stats test_table\\G\nEmpty set (0.00 sec)\n"})}),"\n",(0,i.jsxs)(t.p,{children:["The empty result indicates that there are currently no statistics for the ",(0,i.jsx)(t.code,{children:"test_table"}),". If statistics exist, the result will be similar to the following:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"mysql> show column cached stats mvTestDup;\n+-------------+------------+-------+------+----------+-----------+---------------+------+------+--------+--------------+---------+-------------+---------------------+\n| column_name | index_name | count | ndv  | num_null | data_size | avg_size_byte | min  | max  | method | type         | trigger | query_times | updated_time        |\n+-------------+------------+-------+------+----------+-----------+---------------+------+------+--------+--------------+---------+-------------+---------------------+\n| key1        | mvTestDup  | 6.0   | 4.0  | 0.0      | 48.0      | 8.0           | 1    | 1001 | FULL   | FUNDAMENTALS | MANUAL  | 0           | 2024-07-22 10:53:25 |\n| key2        | mvTestDup  | 6.0   | 4.0  | 0.0      | 48.0      | 8.0           | 2    | 2001 | FULL   | FUNDAMENTALS | MANUAL  | 0           | 2024-07-22 10:53:25 |\n| value2      | mvTestDup  | 6.0   | 4.0  | 0.0      | 24.0      | 4.0           | 4    | 4001 | FULL   | FUNDAMENTALS | MANUAL  | 0           | 2024-07-22 10:53:25 |\n| value1      | mvTestDup  | 6.0   | 4.0  | 0.0      | 24.0      | 4.0           | 3    | 3001 | FULL   | FUNDAMENTALS | MANUAL  | 0           | 2024-07-22 10:53:25 |\n| mv_key1     | mv1        | 6.0   | 4.0  | 0.0      | 48.0      | 8.0           | 1    | 1001 | FULL   | FUNDAMENTALS | MANUAL  | 0           | 2024-07-22 10:53:25 |\n| value3      | mvTestDup  | 6.0   | 4.0  | 0.0      | 24.0      | 4.0           | 5    | 5001 | FULL   | FUNDAMENTALS | MANUAL  | 0           | 2024-07-22 10:53:25 |\n+-------------+------------+-------+------+----------+-----------+---------------+------+------+--------+--------------+---------+-------------+---------------------+\n6 rows in set (0.00 sec)\n"})}),"\n",(0,i.jsx)(t.p,{children:"If statistics exist, you can manually execute SQL queries to verify their accuracy."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"Select count(1), ndv(col1), min(col1), max(col1) from table\n"})}),"\n",(0,i.jsxs)(t.p,{children:["If the errors in ",(0,i.jsx)(t.code,{children:"count"})," and ",(0,i.jsx)(t.code,{children:"ndv"})," are within an order of magnitude, the accuracy is generally acceptable."]}),"\n",(0,i.jsx)(t.h3,{id:"q2-why-are-statistics-not-being-automatically-collected-for-a-table",children:"Q2: Why are statistics not being automatically collected for a table?"}),"\n",(0,i.jsx)(t.p,{children:"First, check if automatic collection is enabled:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:'Show variables like "enable_auto_analyze";  // If false, set it to true:  \n\nSet global enable_auto_analyze = true\n'})}),"\n",(0,i.jsxs)(t.p,{children:["If it's already true, check the number of columns in the table. If it exceeds the ",(0,i.jsx)(t.code,{children:"auto_analyze_table_width_threshold"}),", the table will not participate in automatic collection. Modify this value to be greater than the current number of columns in the table:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:'Show variables like "auto_analyze_table_width_threshold"  \n\n// If the value is less than the width of the table, you can modify it:\n\nSet global auto_analyze_table_width_threshold=350\n'})}),"\n",(0,i.jsxs)(t.p,{children:["If the number of columns does not exceed the threshold, execute ",(0,i.jsx)(t.code,{children:"show auto analyze"})," to check if there are other collection tasks running (in the running state). Since automatic collection is executed serially by a single thread, the execution cycle may be long as it polls all databases and tables."]}),"\n",(0,i.jsx)(t.h3,{id:"q3-why-are-statistics-not-available-for-some-columns",children:"Q3: Why are statistics not available for some columns?"}),"\n",(0,i.jsx)(t.p,{children:"Currently, the system only supports collecting statistics for columns of basic data types. For complex types such as JSONB, VARIANT, MAP, STRUCT, ARRAY, HLL, BITMAP, TIME, and TIMEV2, the system skips them."}),"\n",(0,i.jsx)(t.h3,{id:"q4-error-stats-table-not-available-please-make-sure-your-cluster-status-is-normal",children:'Q4: Error: "Stats table not available, please make sure your cluster status is normal"'}),"\n",(0,i.jsx)(t.p,{children:"This error typically indicates that the internal statistics table is in an unhealthy state."}),"\n",(0,i.jsx)(t.p,{children:"First, check if all BEs (Backend) in the cluster are in a normal state and ensure they are all functioning correctly."}),"\n",(0,i.jsxs)(t.p,{children:["Next, execute the following statement to retrieve all ",(0,i.jsx)(t.code,{children:"tabletId"}),"s (first column of the output):"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"show tablets from internal.__internal_schema.column_statistics;\n"})}),"\n",(0,i.jsxs)(t.p,{children:["Then, check each tablet's status using its ",(0,i.jsx)(t.code,{children:"tablet_id"}),":"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"ADMIN DIAGNOSE TABLET tablet_id\n"})}),"\n",(0,i.jsx)(t.p,{children:"If any tablets are found to be abnormal, repair them first before re-collecting statistics."}),"\n",(0,i.jsx)(t.h3,{id:"q5-how-can-i-address-the-issue-of-untimely-statistics-collection",children:"Q5: How can I address the issue of untimely statistics collection?"}),"\n",(0,i.jsxs)(t.p,{children:["The interval for automatic collection is uncertain and depends on the number and size of tables in the system. In urgent cases, manually execute an ",(0,i.jsx)(t.code,{children:"analyze"})," operation on the table."]}),"\n",(0,i.jsxs)(t.p,{children:["If automatic collection is not triggered after importing large amounts of data, consider adjusting the ",(0,i.jsx)(t.code,{children:"table_stats_health_threshold"})," parameter. Its default value is 90, meaning that automatic collection is triggered when more than 10% (100 - 90) of the table's data changes. You can increase this value, for example, to 95, so that statistics are recollected when more than 5% of the table's data changes."]}),"\n",(0,i.jsx)(t.h3,{id:"q6-how-can-i-address-excessive-resource-usage-during-automatic-collection",children:"Q6: How can I address excessive resource usage during automatic collection?"}),"\n",(0,i.jsx)(t.p,{children:"Automatic collection uses sampling and does not require full table scans, and the tasks are executed serially by a single thread. Usually, system resource usage is manageable and does not impact normal query tasks."}),"\n",(0,i.jsx)(t.p,{children:"For some special tables, such as those with many partitions or large individual tablets, memory usage may be higher."}),"\n",(0,i.jsx)(t.p,{children:"It is recommended to plan the number of tablets reasonably when creating tables to avoid creating oversized tablets. If the tablet structure is not easily adjustable, consider enabling automatic collection or manually collecting statistics for large tables during off-peak hours to avoid impacting business operations. In the Doris 3.x series, we will optimize for such scenarios."})]})}function h(e={}){let{wrapper:t}={...(0,a.a)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},250065:function(e,t,n){n.d(t,{Z:function(){return c},a:function(){return l}});var s=n(667294);let i={},a=s.createContext(i);function l(e){let t=s.useContext(a);return s.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function c(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),s.createElement(a.Provider,{value:t},e.children)}}}]);