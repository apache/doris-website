"use strict";(self.webpackChunkdoris_website=self.webpackChunkdoris_website||[]).push([["356712"],{99804:function(e,s,t){t.r(s),t.d(s,{default:()=>u,frontMatter:()=>a,metadata:()=>n,assets:()=>l,toc:()=>d,contentTitle:()=>o});var n=JSON.parse('{"id":"query-acceleration/performance-tuning-overview/diagnostic-tools","title":"Diagnostic Tools","description":"Efficient and effective performance diagnostic tools are crucial for database system tuning,","source":"@site/versioned_docs/version-2.1/query-acceleration/performance-tuning-overview/diagnostic-tools.md","sourceDirName":"query-acceleration/performance-tuning-overview","slug":"/query-acceleration/performance-tuning-overview/diagnostic-tools","permalink":"/docs/2.1/query-acceleration/performance-tuning-overview/diagnostic-tools","draft":false,"unlisted":false,"tags":[],"version":"2.1","lastUpdatedAt":1770477659000,"frontMatter":{"title":"Diagnostic Tools","language":"en","description":"Efficient and effective performance diagnostic tools are crucial for database system tuning,"},"sidebar":"docs","previous":{"title":"Tuning Overview","permalink":"/docs/2.1/query-acceleration/performance-tuning-overview/tuning-overview"},"next":{"title":"Analysis Tools","permalink":"/docs/2.1/query-acceleration/performance-tuning-overview/analysis-tools"}}'),i=t("785893"),r=t("250065");let a={title:"Diagnostic Tools",language:"en",description:"Efficient and effective performance diagnostic tools are crucial for database system tuning,"},o=void 0,l={},d=[{value:"Overview",id:"overview",level:2},{value:"Doris Manager Logs",id:"doris-manager-logs",level:2},{value:"Audit Log",id:"audit-log",level:2},{value:"Slow Query Analysis Example",id:"slow-query-analysis-example",level:3},{value:"audit_log System Table",id:"audit_log-system-table",level:2},{value:"Summary",id:"summary",level:2}];function c(e){let s={code:"code",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,r.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(s.h2,{id:"overview",children:"Overview"}),"\n",(0,i.jsx)(s.p,{children:"Efficient and effective performance diagnostic tools are crucial for database system tuning, as they determine whether problematic business SQL queries can be quickly identified, and subsequently, performance bottlenecks can be rapidly pinpointed and resolved, ensuring that the database system meets its Service Level Agreements (SLAs)."}),"\n",(0,i.jsxs)(s.p,{children:["Currently, Doris considers SQL queries with execution times exceeding 5 seconds as slow SQL by default. This threshold can be configured via ",(0,i.jsx)(s.code,{children:"config.qe_slow_log_ms"}),". Doris currently offers the following three diagnostic channels to help quickly identify slow SQL queries with performance issues:"]}),"\n",(0,i.jsx)(s.h2,{id:"doris-manager-logs",children:"Doris Manager Logs"}),"\n",(0,i.jsxs)(s.p,{children:["The log module in Doris Manager provides a slow SQL filtering function. Users can view slow SQL by selecting the ",(0,i.jsx)(s.code,{children:"fe.audit.log"})," on a specific FE node. By simply entering ",(0,i.jsx)(s.code,{children:"slow_query"})," in the search box, the historical slow SQL information of the current system will be displayed on the page, as shown in the figure below:"]}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.img,{alt:"Doris Manager Monitoring and Logging",src:t(193753).Z+"",width:"2560",height:"1384"})}),"\n",(0,i.jsx)(s.h2,{id:"audit-log",children:"Audit Log"}),"\n",(0,i.jsxs)(s.p,{children:["Currently, Doris FE provides four types of Audit Logs, including ",(0,i.jsx)(s.code,{children:"slow_query"}),", ",(0,i.jsx)(s.code,{children:"query"}),", ",(0,i.jsx)(s.code,{children:"load"}),", and ",(0,i.jsx)(s.code,{children:"stream_load"}),". Besides accessing the logs through the log page on the cluster where the Manager service is installed and deployed, Audit Logs can also be directly obtained by accessing the ",(0,i.jsx)(s.code,{children:"fe/log/fe.audit.log"})," file on the node where FE is located."]}),"\n",(0,i.jsxs)(s.p,{children:["By directly searching for the ",(0,i.jsx)(s.code,{children:"slow_query"})," tag in ",(0,i.jsx)(s.code,{children:"fe.audit.log"}),", you can quickly filter out slow-executing SQL queries, as shown below:"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-sql",children:"2024-07-18 11:23:13,042 [slow_query] |Client=127.0.0.1:63510|User=root|Ctl=internal|Db=tpch_sf1000|State=EOF|ErrorCode=0|ErrorMessage=|Time(ms)=11603|ScanBytes=236667379712|ScanRows=13649979418|ReturnRows=100|StmtId=1689|QueryId=91ff336304f14182-9ca537eee75b3856|IsQuery=true|isNereids=true|feIp=172.21.0.10|Stmt=select     c_name,     c_custkey,     o_orderkey,     o_orderdate,     o_totalprice,     sum(l_quantity) from     customer,     orders,     lineitem where     o_orderkey  in  (         select             l_orderkey         from             lineitem         group  by             l_orderkey  having                 sum(l_quantity)  >  300     )     and  c_custkey  =  o_custkey     and  o_orderkey  =  l_orderkey group  by     c_name,     c_custkey,     o_orderkey,     o_orderdate,     o_totalprice order  by     o_totalprice  desc,     o_orderdate limit  100|CpuTimeMS=918556|ShuffleSendBytes=3267419|ShuffleSendRows=89668|SqlHash=b4e1de9f251214a30188180f37907f7d|peakMemoryBytes=38720935552|SqlDigest=f23c7a7ecff61da33f537b2699e9b053|cloudClusterName=UNKNOWN|TraceId=|WorkloadGroup=normal|FuzzyVariables=|scanBytesFromLocalStorage=0|scanBytesFromRemoteStorage=0\n2024-07-18 11:23:33,043 [slow_query] |Client=127.0.0.1:26672|User=root|Ctl=internal|Db=tpch_sf1000|State=EOF|ErrorCode=0|ErrorMessage=|Time(ms)=8978|ScanBytes=334985555968|ScanRows=10717654374|ReturnRows=100|StmtId=1815|QueryId=6e1fae453cb04d9a-b1e5f94d9cea1885|IsQuery=true|isNereids=true|feIp=172.21.0.10|Stmt=select     s_name,     count(*) as numwait from     supplier,     lineitem l1,     orders,     nation where     s_suppkey = l1.l_suppkey     and o_orderkey = l1.l_orderkey     and o_orderstatus = 'F'     and l1.l_receiptdate > l1.l_commitdate     and exists (         select             *         from             lineitem l2         where                 l2.l_orderkey = l1.l_orderkey           and l2.l_suppkey <> l1.l_suppkey     )     and not exists (         select             *         from             lineitem l3         where                 l3.l_orderkey = l1.l_orderkey           and l3.l_suppkey <> l1.l_suppkey           and l3.l_receiptdate > l3.l_commitdate     )     and s_nationkey = n_nationkey     and n_name = 'SAUDI ARABIA' group by     s_name order by     numwait desc,     s_name limit 100|CpuTimeMS=990127|ShuffleSendBytes=59208164|ShuffleSendRows=3651504|SqlHash=f8a30e4182d72cce3eff6cb385005b1f|peakMemoryBytes=10495660672|SqlDigest=fec5a7136f9375aa968a4de971b994da|cloudClusterName=UNKNOWN|TraceId=|WorkloadGroup=normal|FuzzyVariables=|scanBytesFromLocalStorage=0|scanBytesFromRemoteStorage=0\n2024-07-18 11:23:41,044 [slow_query] |Client=127.0.0.1:26684|User=root|Ctl=internal|Db=tpch_sf1000|State=EOF|ErrorCode=0|ErrorMessage=|Time(ms)=8514|ScanBytes=334986551296|ScanRows=10717654374|ReturnRows=100|StmtId=1833|QueryId=4f91483464ce4aa8-beeed7dcb8675bc8|IsQuery=true|isNereids=true|feIp=172.21.0.10|Stmt=select     s_name,     count(*) as numwait from     supplier,     lineitem l1,     orders,     nation where     s_suppkey = l1.l_suppkey     and o_orderkey = l1.l_orderkey     and o_orderstatus = 'F'     and l1.l_receiptdate > l1.l_commitdate     and exists (         select             *         from             lineitem l2         where                 l2.l_orderkey = l1.l_orderkey           and l2.l_suppkey <> l1.l_suppkey     )     and not exists (         select             *         from             lineitem l3         where                 l3.l_orderkey = l1.l_orderkey           and l3.l_suppkey <> l1.l_suppkey           and l3.l_receiptdate > l3.l_commitdate     )     and s_nationkey = n_nationkey     and n_name = 'SAUDI ARABIA' group by     s_name order by     numwait desc,     s_name limit 100|CpuTimeMS=925841|ShuffleSendBytes=59223190|ShuffleSendRows=3651602|SqlHash=f8a30e4182d72cce3eff6cb385005b1f|peakMemoryBytes=10505123104|SqlDigest=fec5a7136f9375aa968a4de971b994da|cloudClusterName=UNKNOWN|TraceId=|WorkloadGroup=normal|FuzzyVariables=|scanBytesFromLocalStorage=0|scanBytesFromRemoteStorage=0\n2024-07-18 11:23:49,044 [slow_query] |Client=127.0.0.1:10748|User=root|Ctl=internal|Db=tpch_sf1000|State=EOF|ErrorCode=0|ErrorMessage=|Time(ms)=8660|ScanBytes=334987673600|ScanRows=10717654374|ReturnRows=100|StmtId=1851|QueryId=4599cb1bab204f80-ac430dd78b45e3da|IsQuery=true|isNereids=true|feIp=172.21.0.10|Stmt=select     s_name,     count(*) as numwait from     supplier,     lineitem l1,     orders,     nation where     s_suppkey = l1.l_suppkey     and o_orderkey = l1.l_orderkey     and o_orderstatus = 'F'     and l1.l_receiptdate > l1.l_commitdate     and exists (         select             *         from             lineitem l2         where                 l2.l_orderkey = l1.l_orderkey           and l2.l_suppkey <> l1.l_suppkey     )     and not exists (         select             *         from             lineitem l3         where                 l3.l_orderkey = l1.l_orderkey           and l3.l_suppkey <> l1.l_suppkey           and l3.l_receiptdate > l3.l_commitdate     )     and s_nationkey = n_nationkey     and n_name = 'SAUDI ARABIA' group by     s_name order by     numwait desc,     s_name limit 100|CpuTimeMS=932664|ShuffleSendBytes=59223178|ShuffleSendRows=3651991|SqlHash=f8a30e4182d72cce3eff6cb385005b1f|peakMemoryBytes=10532849344|SqlDigest=fec5a7136f9375aa968a4de971b994da|cloudClusterName=UNKNOWN|TraceId=|WorkloadGroup=normal|FuzzyVariables=|scanBytesFromLocalStorage=0|scanBytesFromRemoteStorage=0\n"})}),"\n",(0,i.jsxs)(s.p,{children:["The slow SQL obtained through ",(0,i.jsx)(s.code,{children:"fe.audit.log"})," allows users to easily access detailed information such as execution time, number of rows scanned, number of rows returned, and the SQL statement itself, laying the foundation for further reproducing and locating performance issues."]}),"\n",(0,i.jsxs)(s.p,{children:["Additionally, the Audit Log includes a ",(0,i.jsx)(s.code,{children:"SqlDigest"})," field (e.g., ",(0,i.jsx)(s.code,{children:"SqlDigest=..."})," in the example above). This field is a hash value generated from the structure of the SQL statement (with specific parameter values removed). By aggregating and analyzing ",(0,i.jsx)(s.code,{children:"SqlDigest"})," in ",(0,i.jsx)(s.code,{children:"slow_query"}),', you can identify "patterns" of slow queries. This means that even if specific SQL statements differ slightly due to parameters, their ',(0,i.jsx)(s.code,{children:"SqlDigest"})," will be identical as long as the structure is the same."]}),"\n",(0,i.jsxs)(s.p,{children:["Using ",(0,i.jsx)(s.code,{children:"SqlDigest"}),', users can determine which SQL patterns appear most frequently or consume the most time, allowing them to prioritize optimization for these "high-frequency" or "high-latency" patterns. This approach significantly improves the efficiency of slow query optimization by avoiding the inefficiency of analyzing individual SQL statements one by one.']}),"\n",(0,i.jsxs)(s.p,{children:["It is important to note that ",(0,i.jsx)(s.code,{children:"SqlDigest"})," itself is just a hash value and is not directly readable. Once the slow query pattern to be optimized is identified, you need to refer to the ",(0,i.jsx)(s.code,{children:"Stmt"})," field in the Audit Log to get the specific SQL statement content corresponding to that pattern. Furthermore, the ",(0,i.jsx)(s.code,{children:"QueryId"})," field can be used to retrieve detailed Profile information for the query (Profile retrieval and analysis will be detailed in subsequent sections) for in-depth performance analysis and optimization."]}),"\n",(0,i.jsx)(s.h3,{id:"slow-query-analysis-example",children:"Slow Query Analysis Example"}),"\n",(0,i.jsxs)(s.p,{children:["Taking the 4 slow query logs in the ",(0,i.jsx)(s.code,{children:"fe.audit.log"})," above as an example, we can observe:"]}),"\n",(0,i.jsxs)(s.ol,{children:["\n",(0,i.jsxs)(s.li,{children:["The first log (",(0,i.jsx)(s.code,{children:"Time(ms)=11603"}),") has a ",(0,i.jsx)(s.code,{children:"SqlDigest"})," of ",(0,i.jsx)(s.code,{children:"f23c7a7ecff61da33f537b2699e9b053"}),"."]}),"\n",(0,i.jsxs)(s.li,{children:["The subsequent three logs (",(0,i.jsx)(s.code,{children:"Time(ms)=8978"}),", ",(0,i.jsx)(s.code,{children:"8514"}),", ",(0,i.jsx)(s.code,{children:"8660"}),") all have the ",(0,i.jsx)(s.code,{children:"SqlDigest"})," of ",(0,i.jsx)(s.code,{children:"fec5a7136f9375aa968a4de971b994da"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(s.p,{children:["This indicates that the latter three slow queries belong to the same SQL pattern (structurally identical), although their specific execution times (",(0,i.jsx)(s.code,{children:"Time(ms)"}),") and details differ slightly."]}),"\n",(0,i.jsxs)(s.p,{children:["In real-world optimization scenarios, if we find that a certain ",(0,i.jsx)(s.code,{children:"SqlDigest"})," (such as ",(0,i.jsx)(s.code,{children:"fec5a7136f9375aa968a4de971b994da"}),") appears repeatedly in the slow query logs, or accounts for a high proportion of the total execution time, we should prioritize optimizing this pattern."]}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.strong,{children:"Recommended Optimization Steps:"})}),"\n",(0,i.jsxs)(s.ol,{children:["\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Identify Business Logic"}),": By examining the ",(0,i.jsx)(s.code,{children:"Stmt"})," field in any log entry of this pattern:"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-sql",children:"select     s_name,     count(*) as numwait from     supplier,     lineitem l1,     orders,     nation where ...\n"})}),"\n",(0,i.jsx)(s.p,{children:"We can identify the specific SQL logic."}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Deep Analysis"}),": Use the ",(0,i.jsx)(s.code,{children:"QueryId"})," (e.g., ",(0,i.jsx)(s.code,{children:"6e1fae453cb04d9a-b1e5f94d9cea1885"}),") from the log to retrieve the corresponding Query Profile in Doris. The Profile helps analyze whether the issue is due to excessive data scanning, prolonged Join operations, or other reasons, enabling targeted optimization strategies (such as adding indexes, optimizing SQL writing, or adjusting table structures)."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.p,{children:"Once the issue with this pattern is resolved, all slow queries belonging to this pattern will be improved."}),"\n",(0,i.jsx)(s.h2,{id:"audit_log-system-table",children:"audit_log System Table"}),"\n",(0,i.jsxs)(s.p,{children:["Starting from Doris version 2.1, the ",(0,i.jsx)(s.code,{children:"audit_log"})," system table is provided under the ",(0,i.jsx)(s.code,{children:"__internal_schema"})," database for users to view the execution status of SQL queries. Before using it, the global configuration ",(0,i.jsx)(s.code,{children:"set global enable_audit_plugin=true"}),"; needs to be enabled (this switch is disabled by default)."]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-sql",children:"mysql> use __internal_schema;\nReading table information for completion of table and column names\nYou can turn off this feature to get a quicker startup with -A\n\nDatabase changed\nmysql> show tables;\n+-----------------------------+\n| Tables_in___internal_schema |\n+-----------------------------+\n| audit_log                   |\n| column_statistics           |\n| histogram_statistics        |\n| partition_statistics        |\n+-----------------------------+\n4 rows in set (0.00 sec)\n\nmysql> desc audit_log;\n+-------------------+--------------+------+-------+---------+-------+\n| Field             | Type         | Null | Key   | Default | Extra |\n+-------------------+--------------+------+-------+---------+-------+\n| query_id          | varchar(48)  | Yes  | true  | NULL    |       |\n| time              | datetime     | Yes  | true  | NULL    |       |\n| client_ip         | varchar(128) | Yes  | true  | NULL    |       |\n| user              | varchar(128) | Yes  | false | NULL    | NONE  |\n| catalog           | varchar(128) | Yes  | false | NULL    | NONE  |\n| db                | varchar(128) | Yes  | false | NULL    | NONE  |\n| state             | varchar(128) | Yes  | false | NULL    | NONE  |\n| error_code        | int          | Yes  | false | NULL    | NONE  |\n| error_message     | text         | Yes  | false | NULL    | NONE  |\n| query_time        | bigint       | Yes  | false | NULL    | NONE  |\n| scan_bytes        | bigint       | Yes  | false | NULL    | NONE  |\n| scan_rows         | bigint       | Yes  | false | NULL    | NONE  |\n| return_rows       | bigint       | Yes  | false | NULL    | NONE  |\n| stmt_id           | bigint       | Yes  | false | NULL    | NONE  |\n| is_query          | tinyint      | Yes  | false | NULL    | NONE  |\n| frontend_ip       | varchar(128) | Yes  | false | NULL    | NONE  |\n| cpu_time_ms       | bigint       | Yes  | false | NULL    | NONE  |\n| sql_hash          | varchar(128) | Yes  | false | NULL    | NONE  |\n| sql_digest        | varchar(128) | Yes  | false | NULL    | NONE  |\n| peak_memory_bytes | bigint       | Yes  | false | NULL    | NONE  |\n| stmt              | text         | Yes  | false | NULL    | NONE  |\n+-------------------+--------------+------+-------+---------+-------+\n"})}),"\n",(0,i.jsxs)(s.p,{children:["Through the ",(0,i.jsx)(s.code,{children:"audit_log"})," internal table, users can query detailed SQL execution information and perform detailed statistical analysis such as slow query filtering."]}),"\n",(0,i.jsx)(s.h2,{id:"summary",children:"Summary"}),"\n",(0,i.jsxs)(s.p,{children:["Doris Manager logs, audit logs, and the ",(0,i.jsx)(s.code,{children:"audit_log"})," system table provide capabilities such as automatic or manual filtering of slow SQL queries, as well as fine-grained statistical analysis of SQL execution information. These tools offer powerful support for systematic performance diagnosis and tuning."]})]})}function u(e={}){let{wrapper:s}={...(0,r.a)(),...e.components};return s?(0,i.jsx)(s,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},193753:function(e,s,t){t.d(s,{Z:function(){return n}});let n=t.p+"assets/images/doris-manage-trace-log-2-4fea8cd5ea110510eca737115b1a2d77.png"},250065:function(e,s,t){t.d(s,{Z:function(){return o},a:function(){return a}});var n=t(667294);let i={},r=n.createContext(i);function a(e){let s=n.useContext(r);return n.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function o(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),n.createElement(r.Provider,{value:s},e.children)}}}]);