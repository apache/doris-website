"use strict";(self.webpackChunkdoris_website=self.webpackChunkdoris_website||[]).push([["721630"],{910669:function(e,n,i){i.r(n),i.d(n,{default:()=>h,frontMatter:()=>t,metadata:()=>s,assets:()=>o,toc:()=>l,contentTitle:()=>d});var s=JSON.parse('{"id":"admin-manual/cluster-management/upgrade","title":"Upgrading Cluster","description":"Doris provides the capability for rolling upgrades, enabling step-by-step upgrades of FE and BE nodes, minimizing downtime,","source":"@site/versioned_docs/version-3.x/admin-manual/cluster-management/upgrade.md","sourceDirName":"admin-manual/cluster-management","slug":"/admin-manual/cluster-management/upgrade","permalink":"/docs/3.x/admin-manual/cluster-management/upgrade","draft":false,"unlisted":false,"tags":[],"version":"3.x","lastUpdatedAt":1770477659000,"frontMatter":{"title":"Upgrading Cluster","language":"en","description":"Doris provides the capability for rolling upgrades, enabling step-by-step upgrades of FE and BE nodes, minimizing downtime,"},"sidebar":"docs","previous":{"title":"TPC-DS Benchmark","permalink":"/docs/3.x/benchmark/tpcds"},"next":{"title":"Elastic Scaling","permalink":"/docs/3.x/admin-manual/cluster-management/elastic-expansion"}}'),r=i("785893"),a=i("250065");let t={title:"Upgrading Cluster",language:"en",description:"Doris provides the capability for rolling upgrades, enabling step-by-step upgrades of FE and BE nodes, minimizing downtime,"},d=void 0,o={},l=[{value:"Version Compatibility",id:"version-compatibility",level:2},{value:"Upgrade Precautions",id:"upgrade-precautions",level:2},{value:"Metadata Compatibility Testing",id:"metadata-compatibility-testing",level:2},{value:"Upgrade Steps",id:"upgrade-steps",level:2},{value:"Step 1: Disable Replica Repair and Balance Functions",id:"step-1-disable-replica-repair-and-balance-functions",level:3},{value:"Step 2: Upgrade BE Nodes",id:"step-2-upgrade-be-nodes",level:3},{value:"Step 3: Upgrade FE Nodes",id:"step-3-upgrade-fe-nodes",level:3},{value:"Step 4: Enable Replica Repair and Balance Functions",id:"step-4-enable-replica-repair-and-balance-functions",level:3}];function c(e){let n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:"Doris provides the capability for rolling upgrades, enabling step-by-step upgrades of FE and BE nodes, minimizing downtime, and ensuring the system remains operational during the upgrade process."}),"\n",(0,r.jsx)(n.h2,{id:"version-compatibility",children:"Version Compatibility"}),"\n",(0,r.jsx)(n.p,{children:'Doris versioning consists of three components: the first digit represents a major milestone version, the second digit indicates a feature version, and the third digit corresponds to a bug fix. New features are not introduced in bug fix versions. For example, in Doris version 2.1.3, "2" indicates the second milestone version, "1" represents the feature version under this milestone, and "3" denotes the third bug fix for this feature version.'}),"\n",(0,r.jsx)(n.p,{children:"During version upgrades, the following rules apply:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Three-digit versions:"})," Versions with the same first two digits can be directly upgraded across three-digit versions. For example, version 2.1.3 can be directly upgraded to version 2.1.7."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Two-digit and one-digit versions:"})," Cross-version upgrades for two-digit versions are not recommended due to compatibility concerns. It is advised to upgrade sequentially through each two-digit version. For example, upgrading from version 3.0 to 3.3 should follow the sequence 3.0 -> 3.1 -> 3.2 -> 3.3."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["The detailed version information can be found in the ",(0,r.jsx)(n.a,{href:"https://doris.apache.org/community/release-versioning",children:"versioning rules"}),"."]}),"\n",(0,r.jsx)(n.h2,{id:"upgrade-precautions",children:"Upgrade Precautions"}),"\n",(0,r.jsx)(n.p,{children:"When performing an upgrade, pay attention to the following:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Behavioral changes between versions:"})," Review the Release Notes before upgrading to identify compatibility issues."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Add retry mechanisms for tasks in the cluster:"})," Nodes are restarted sequentially during upgrades. Ensure that retry mechanisms are in place for query tasks and Stream Load import jobs to avoid task failures. Routine Load jobs using flink-doris-connector or spark-doris-connector already include retry mechanisms in their code and do not require additional logic."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Disable replica repair and balance functions:"})," Disable these functions during the upgrade process. Regardless of the upgrade outcome, re-enable these functions after the upgrade is complete."]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"metadata-compatibility-testing",children:"Metadata Compatibility Testing"}),"\n",(0,r.jsxs)(n.admonition,{title:"Note",type:"caution",children:[(0,r.jsx)(n.p,{children:"In a production environment, it is recommended to configure at least three FE nodes for high availability. If there is only one FE node, metadata compatibility testing must be performed before upgrading. Metadata compatibility is critical as incompatibility may cause upgrade failures and data loss. It is recommended to conduct metadata compatibility tests before each upgrade, keeping in mind the following:"}),(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Perform metadata compatibility testing on a development machine or BE node whenever possible to avoid using FE nodes."}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"If testing must be conducted on an FE node, use a non-Master node and stop the original FE process."}),"\n"]}),"\n"]})]}),"\n",(0,r.jsx)(n.p,{children:"Before upgrading, conduct metadata compatibility testing to prevent failures caused by metadata incompatibility."}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Backup metadata information:"})}),"\n",(0,r.jsx)(n.p,{children:"Before starting the upgrade, back up the metadata of the Master FE node."}),"\n",(0,r.jsxs)(n.p,{children:["Use the ",(0,r.jsx)(n.code,{children:"show frontends"})," command and refer to the ",(0,r.jsx)(n.code,{children:"IsMaster"})," column to identify the Master FE node. FE metadata can be hot-backed up without stopping the FE node. By default, FE metadata is stored in the ",(0,r.jsx)(n.code,{children:"fe/doris-meta"})," directory. This can be confirmed via the ",(0,r.jsx)(n.code,{children:"meta_dir"})," parameter in the ",(0,r.jsx)(n.code,{children:"fe.conf"})," configuration file."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsxs)(n.strong,{children:["Modify the ",(0,r.jsx)(n.code,{children:"fe.conf"})," configuration file of the test FE node:"]})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"vi ${DORIS_NEW_HOME}/conf/fe.conf\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Modify the following port information, ensuring all ports are different from those in the production environment, and update the ",(0,r.jsx)(n.code,{children:"clusterID"})," parameter:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"...\n## modify port\nhttp_port = 18030\nrpc_port = 19020\nquery_port = 19030\narrow_flight_sql_port = 19040\nedit_log_port = 19010\n\n## modify clusterIP\nclusterId=<a_new_clusterIP, such as 123456>\n...\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Copy the backed-up Master FE metadata to the new compatibility testing environment."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"cp ${DORIS_OLD_HOME}/fe/doris-meta/* ${DORIS_NEW_HOME}/fe/doris-meta\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Edit the ",(0,r.jsx)(n.code,{children:"VERSION"})," file in the copied metadata directory to update the ",(0,r.jsx)(n.code,{children:"cluster_id"})," to a new cluster IP, for example, change it to ",(0,r.jsx)(n.code,{children:"123456"})," as shown in the example:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"vi ${DORIS_NEW_HOME}/fe/doris-meta/image/VERSION\nclusterId=123456\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Start the FE process in the testing environment."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"sh ${DORIS_NEW_HOME}/bin/start_fe.sh --daemon --metadata_failure_recovery\n"})}),"\n",(0,r.jsxs)(n.p,{children:["For versions earlier than 2.0.2, add the ",(0,r.jsx)(n.code,{children:"metadata_failure_recovery"})," parameter to the ",(0,r.jsx)(n.code,{children:"fe.conf"})," file before starting the FE process:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'echo "metadata_failure_recovery=true" >> ${DORIS_NEW_HOME}/conf/fe.conf\nsh ${DORIS_NEW_HOME}/bin/start_fe.sh --daemon \n'})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Verify that the FE process has started successfully by connecting to the current FE using the MySQL command. For example, use the query port ",(0,r.jsx)(n.code,{children:"19030"})," as mentioned above:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"mysql -uroot -P19030 -h127.0.0.1\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"upgrade-steps",children:"Upgrade Steps"}),"\n",(0,r.jsx)(n.p,{children:"The detailed process for the upgrade is as follows:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Disable replica repair and balance functions"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Upgrade BE nodes"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Upgrade FE nodes"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Enable replica repair and balance functions"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"During the upgrade process, the principle of upgrading BE nodes first, followed by upgrading FE nodes, should be followed. When upgrading FE, upgrade the Observer FE and Follower FE nodes first, and then upgrade the Master FE node."}),"\n",(0,r.jsxs)(n.admonition,{title:"Note",type:"caution",children:[(0,r.jsxs)(n.p,{children:["In general, only the ",(0,r.jsx)(n.code,{children:"/bin"})," and ",(0,r.jsx)(n.code,{children:"/lib"})," directories under the FE directory and the ",(0,r.jsx)(n.code,{children:"/bin"})," and ",(0,r.jsx)(n.code,{children:"/lib"})," directories under the BE directory need to be upgraded."]}),(0,r.jsxs)(n.p,{children:["For versions 2.0.2 and later, a ",(0,r.jsx)(n.code,{children:"custom_lib/"})," directory has been added under the FE and BE deployment paths (if it doesn't exist, it can be manually created). The ",(0,r.jsx)(n.code,{children:"custom_lib/"})," directory is used to store some user-defined third-party jar files, such as ",(0,r.jsx)(n.code,{children:"hadoop-lzo-*.jar"}),", ",(0,r.jsx)(n.code,{children:"orai18n.jar"}),", etc. This directory does not need to be replaced during the upgrade."]})]}),"\n",(0,r.jsx)(n.h3,{id:"step-1-disable-replica-repair-and-balance-functions",children:"Step 1: Disable Replica Repair and Balance Functions"}),"\n",(0,r.jsx)(n.p,{children:"During the upgrade process, nodes will be restarted, which may trigger unnecessary cluster balancing and replica repair logic. Disable these functions first using the following command:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:'admin set frontend config("disable_balance" = "true");\nadmin set frontend config("disable_colocate_balance" = "true");\nadmin set frontend config("disable_tablet_scheduler" = "true");\n'})}),"\n",(0,r.jsx)(n.h3,{id:"step-2-upgrade-be-nodes",children:"Step 2: Upgrade BE Nodes"}),"\n",(0,r.jsx)(n.admonition,{title:"Note:",type:"info",children:(0,r.jsx)(n.p,{children:"To ensure the safety of your data, please use 3 replicas to store your data to avoid data loss caused by upgrade mistakes or failures."})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"In a multi-replica cluster, you can choose to stop the process on one BE node and perform a gradual upgrade:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"sh ${DORIS_OLD_HOME}/be/bin/stop_be.sh\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Rename the ",(0,r.jsx)(n.code,{children:"/bin"})," and ",(0,r.jsx)(n.code,{children:"/lib"})," directories in the BE directory:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"mv ${DORIS_OLD_HOME}/be/bin ${DORIS_OLD_HOME}/be/bin_back\nmv ${DORIS_OLD_HOME}/be/lib ${DORIS_OLD_HOME}/be/lib_back\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Copy the new version's ",(0,r.jsx)(n.code,{children:"/bin"})," and ",(0,r.jsx)(n.code,{children:"/lib"})," directories to the original BE directory:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"cp -r ${DORIS_NEW_HOME}/be/bin ${DORIS_OLD_HOME}/be/bin\ncp -r ${DORIS_NEW_HOME}/be/lib ${DORIS_OLD_HOME}/be/lib\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Start the BE node:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"sh ${DORIS_OLD_HOME}/be/bin/start_be.sh --daemon\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Connect to the cluster and check the node information:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"show backends\\G\n"})}),"\n",(0,r.jsxs)(n.p,{children:["If the BE node's ",(0,r.jsx)(n.code,{children:"alive"})," status is ",(0,r.jsx)(n.code,{children:"true"})," and the ",(0,r.jsx)(n.code,{children:"Version"})," value is the new version, the node has been successfully upgraded."]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"step-3-upgrade-fe-nodes",children:"Step 3: Upgrade FE Nodes"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"In a multi-FE node setup, select a non-Master node for the upgrade and stop it first:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"sh ${DORIS_OLD_HOME}/fe/bin/stop_fe.sh\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Rename the ",(0,r.jsx)(n.code,{children:"/bin"}),", ",(0,r.jsx)(n.code,{children:"/lib"}),", and ",(0,r.jsx)(n.code,{children:"/mysql_ssl_default_certificate"})," directories in the FE directory:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"mv ${DORIS_OLD_HOME}/fe/bin ${DORIS_OLD_HOME}/fe/bin_back\nmv ${DORIS_OLD_HOME}/fe/lib ${DORIS_OLD_HOME}/fe/lib_back\nmv ${DORIS_OLD_HOME}/fe/mysql_ssl_default_certificate ${DORIS_OLD_HOME}/fe/mysql_ssl_default_certificate_back\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Copy the new version's ",(0,r.jsx)(n.code,{children:"/bin"}),", ",(0,r.jsx)(n.code,{children:"/lib"}),", and ",(0,r.jsx)(n.code,{children:"/mysql_ssl_default_certificate"})," directories to the original FE directory:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"cp -r ${DORIS_NEW_HOME}/fe/bin ${DORIS_OLD_HOME}/fe/bin\ncp -r ${DORIS_NEW_HOME}/fe/lib ${DORIS_OLD_HOME}/fe/lib\ncp -r ${DORIS_NEW_HOME}/fe/mysql_ssl_default_certificate ${DORIS_OLD_HOME}/fe/mysql_ssl_default_certificate\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Start the FE node:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"sh ${DORIS_OLD_HOME}/fe/bin/start_fe.sh --daemon\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Connect to the cluster and check the node information:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"show frontends\\G\n"})}),"\n",(0,r.jsxs)(n.p,{children:["If the FE node's ",(0,r.jsx)(n.code,{children:"alive"})," status is ",(0,r.jsx)(n.code,{children:"true"})," and the ",(0,r.jsx)(n.code,{children:"Version"})," value is the new version, the node has been successfully upgraded."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Complete the upgrade of the other FE nodes in sequence, and finally upgrade the Master node."}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"step-4-enable-replica-repair-and-balance-functions",children:"Step 4: Enable Replica Repair and Balance Functions"}),"\n",(0,r.jsxs)(n.p,{children:["After the upgrade is complete and all BE nodes' status is ",(0,r.jsx)(n.code,{children:"Alive"}),", enable the cluster's replica repair and balance functions:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:'admin set frontend config("disable_balance" = "false");\nadmin set frontend config("disable_colocate_balance" = "false");\nadmin set frontend config("disable_tablet_scheduler" = "false");\n'})})]})}function h(e={}){let{wrapper:n}={...(0,a.a)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},250065:function(e,n,i){i.d(n,{Z:function(){return d},a:function(){return t}});var s=i(667294);let r={},a=s.createContext(r);function t(e){let n=s.useContext(a);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:t(e.components),s.createElement(a.Provider,{value:n},e.children)}}}]);