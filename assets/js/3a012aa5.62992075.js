"use strict";(self.webpackChunkdoris_website=self.webpackChunkdoris_website||[]).push([["146497"],{689143:function(e,n,s){s.r(n),s.d(n,{default:()=>u,frontMatter:()=>o,metadata:()=>t,assets:()=>c,toc:()=>l,contentTitle:()=>a});var t=JSON.parse('{"id":"admin-manual/auth/integrations/aws-authentication-and-authorization","title":"AWS authentication and authorization","description":"Doris supports accessing AWS service resources through two authentication methods: \u200B\u200BIAM User\u200B\u200B and \u200B\u200BAssumed Role\u200B\u200B.","source":"@site/versioned_docs/version-3.x/admin-manual/auth/integrations/aws-authentication-and-authorization.md","sourceDirName":"admin-manual/auth/integrations","slug":"/admin-manual/auth/integrations/aws-authentication-and-authorization","permalink":"/docs/3.x/admin-manual/auth/integrations/aws-authentication-and-authorization","draft":false,"unlisted":false,"tags":[],"version":"3.x","lastUpdatedAt":1770477659000,"frontMatter":{"title":"AWS authentication and authorization","language":"en","description":"Doris supports accessing AWS service resources through two authentication methods: \u200B\u200BIAM User\u200B\u200B and \u200B\u200BAssumed Role\u200B\u200B."},"sidebar":"docs","previous":{"title":"Encryption and Masking Function ","permalink":"/docs/3.x/admin-manual/auth/encryption-function"},"next":{"title":"How Apache Doris IAM Assume Role work","permalink":"/docs/3.x/admin-manual/auth/integrations/aws-iam-role"}}'),r=s("785893"),i=s("250065");let o={title:"AWS authentication and authorization",language:"en",description:"Doris supports accessing AWS service resources through two authentication methods: \u200B\u200BIAM User\u200B\u200B and \u200B\u200BAssumed Role\u200B\u200B."},a="Authentication Methods Overview",c={},l=[{value:"IAM User Authentication",id:"iam-user-authentication",level:2},{value:"Step1 Create an IAM User and configure policies",id:"step1-create-an-iam-user-and-configure-policies",level:3},{value:"Step2 Use doris features with access/secret key pair via SQL",id:"step2-use-doris-features-with-accesssecret-key-pair-via-sql",level:3},{value:"S3 Load",id:"s3-load",level:4},{value:"TVF",id:"tvf",level:4},{value:"External Catalog",id:"external-catalog",level:4},{value:"Storage Vault",id:"storage-vault",level:4},{value:"Export",id:"export",level:4},{value:"Repository",id:"repository",level:4},{value:"Resource",id:"resource",level:4},{value:"Assumed Role Authentication",id:"assumed-role-authentication",level:2},{value:"Step1 Prerequisites",id:"step1-prerequisites",level:3},{value:"Step2 Configure Permissions for Source Account IAM Role (EC2 Instance Role)",id:"step2-configure-permissions-for-source-account-iam-role-ec2-instance-role",level:3},{value:"Step3 Configure Trust Policy and Permissions for Target Account IAM Role",id:"step3-configure-trust-policy-and-permissions-for-target-account-iam-role",level:3},{value:"Step4 Use doris features with Assumed Role via SQL, according to <code>role_arn</code> and <code>external_id</code> fields",id:"step4-use-doris-features-with-assumed-role-via-sql-according-to-role_arn-and-external_id-fields",level:3},{value:"S3 Load",id:"s3-load-1",level:4},{value:"TVF",id:"tvf-1",level:4},{value:"External Catalog",id:"external-catalog-1",level:4},{value:"Storage Vault",id:"storage-vault-1",level:4},{value:"Export",id:"export-1",level:4},{value:"Repository",id:"repository-1",level:4},{value:"Resource",id:"resource-1",level:4},{value:"AWS EKS Cluster IAM Role Authentication and Authorization",id:"aws-eks-cluster-iam-role-authentication-and-authorization",level:3},{value:"Bucket Policy Authentication and Authorization",id:"bucket-policy-authentication-and-authorization",level:3},{value:"Best Practices for Authentication Methods",id:"best-practices-for-authentication-methods",level:3},{value:"FAQ",id:"faq",level:3},{value:"1. How to set AWS SDK DEBUG level logs for BE and Recycler?",id:"1-how-to-set-aws-sdk-debug-level-logs-for-be-and-recycler",level:4},{value:"2.After setting AWS SDK DEBUG level logs, the following error appears in be.log/recycler.log:",id:"2after-setting-aws-sdk-debug-level-logs-the-following-error-appears-in-belogrecyclerlog",level:4}];function d(e){let n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul","your-bucket":"your-bucket","your-prefix":"your-prefix",...(0,i.a)(),...e.components},t=n["your-bucket"],o=n["your-prefix"];return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(n.p,{children:["Doris supports accessing AWS service resources through two authentication methods: \u200B\u200B",(0,r.jsx)(n.code,{children:"IAM User"}),"\u200B\u200B and ",(0,r.jsx)(n.code,{children:"\u200B\u200BAssumed Role"}),"\u200B\u200B. This article explains how to configure security credentials for both methods and use Doris features to interact with AWS services."]}),"\n",(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"authentication-methods-overview",children:"Authentication Methods Overview"})}),"\n",(0,r.jsx)(n.h2,{id:"iam-user-authentication",children:"IAM User Authentication"}),"\n",(0,r.jsxs)(n.p,{children:["Doris enables access to external data sources by configuring ",(0,r.jsx)(n.code,{children:"AWS IAM User"})," credentials(equal to ",(0,r.jsx)(n.code,{children:"access_key"})," and ",(0,r.jsx)(n.code,{children:"secret_key"}),"), below are the detailed configuration steps(for more information, refer to the AWS doc ",(0,r.jsx)(n.a,{href:"https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users.html",children:"IAM users"}),"):"]}),"\n",(0,r.jsx)(n.h3,{id:"step1-create-an-iam-user-and-configure-policies",children:"Step1 Create an IAM User and configure policies"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Login to the ",(0,r.jsx)(n.code,{children:"AWS Console"})," and create an ",(0,r.jsx)(n.code,{children:"IAM User"}),"\u200B"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:s(622756).Z+"",width:"1280",height:"567"})}),"\n",(0,r.jsxs)(n.ol,{start:"2",children:["\n",(0,r.jsx)(n.li,{children:"Enter the IAM User name and attach policies directly\u200B"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:s(378198).Z+"",width:"1280",height:"635"})}),"\n",(0,r.jsxs)(n.ol,{start:"3",children:["\n",(0,r.jsx)(n.li,{children:"Define AWS resource policies in the policy editor\u200B\u200B, below are read/write policy templates for accessing an S3 bucket"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:s(285612).Z+"",width:"1280",height:"588"})}),"\n",(0,r.jsx)(n.p,{children:"S3 read policy template\u200B,applies to Doris features requiring read/list access, e.g: S3 Load, TVF, External Catalog"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Notes: "})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsxs)(n.strong,{children:["Replace ",(0,r.jsxs)(t,{children:[" and ",(0,r.jsx)(o,{children:" with actual values."})]})]})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Avoid adding extra / separators."})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n    "Version": "2012-10-17",\n    "Statement": [\n        {\n            "Effect": "Allow",\n            "Action": [\n              "s3:GetObject",\n              "s3:GetObjectVersion",\n            ],\n            "Resource": "arn:aws:s3:::<your-bucket>/your-prefix/*"\n        },\n        {\n            "Effect": "Allow",\n            "Action": [\n                "s3:ListBucket",\n                "s3:GetBucketLocation"\n            ],\n            "Resource": "arn:aws:s3:::<your-bucket>"\n        }    \n    ]\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"S3 write policy template\u200B\u200B (Applies to Doris features requiring read/write access, e.g: Export, Storage Vault, Repository)"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Notes: "})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsxs)(n.strong,{children:["Replace ",(0,r.jsx)(n.code,{children:"your-bucket"})," and ",(0,r.jsx)(n.code,{children:"your-prefix"})," with actual values."]})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsxs)(n.strong,{children:["Avoid adding extra ",(0,r.jsx)(n.code,{children:"/"})," separators."]})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n    "Version": "2012-10-17",\n    "Statement": [\n        {\n            "Effect": "Allow",\n            "Action": [\n              "s3:PutObject",\n              "s3:GetObject",\n              "s3:GetObjectVersion",\n              "s3:DeleteObject",\n              "s3:DeleteObjectVersion",\n              "s3:AbortMultipartUpload",      \n              "s3:ListMultipartUploadParts"\n            ],\n            "Resource": "arn:aws:s3:::<your-bucket>/<your-prefix>/*"\n        },\n        {\n            "Effect": "Allow",\n            "Action": [\n                "s3:ListBucket",\n                "s3:GetBucketLocation",\n                "s3:GetBucketVersioning",\n                "s3:GetLifecycleConfiguration"\n            ],\n            "Resource": "arn:aws:s3:::<your-bucket>"\n        }    \n    ]\n}\n'})}),"\n",(0,r.jsxs)(n.ol,{start:"4",children:["\n",(0,r.jsx)(n.li,{children:"After successfully creating the IAM User, create access/secret key pair"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:s(808504).Z+"",width:"1280",height:"518"})}),"\n",(0,r.jsx)(n.h3,{id:"step2-use-doris-features-with-accesssecret-key-pair-via-sql",children:"Step2 Use doris features with access/secret key pair via SQL"}),"\n",(0,r.jsxs)(n.p,{children:["After completing all configurations in Step 1, you will obtain ",(0,r.jsx)(n.code,{children:"access_key"})," and ",(0,r.jsx)(n.code,{children:"secret_key"}),". Use these credentials to access doris features as shown in the following examples:"]}),"\n",(0,r.jsx)(n.h4,{id:"s3-load",children:"S3 Load"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-SQL",children:'  LOAD LABEL s3_load_2022_04_01\n  (\n      DATA INFILE("s3://your_bucket_name/s3load_example.csv")\n      INTO TABLE test_s3load\n      COLUMNS TERMINATED BY ","\n      FORMAT AS "CSV"\n      (user_id, name, age)\n  )\n  WITH S3\n  (\n      "provider" = "S3",\n      "s3.endpoint" = "s3.us-east-1.amazonaws.com",\n      "s3.region" = "us-east-1",\n      "s3.access_key" = "<your-access-key>",\n      "s3.secret_key" = "<your-secrety-key>"\n  )\n  PROPERTIES\n  (\n      "timeout" = "3600"\n  );\n'})}),"\n",(0,r.jsx)(n.h4,{id:"tvf",children:"TVF"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-SQL",children:"  SELECT * FROM S3 (\n      'uri' = 's3://your_bucket/path/to/tvf_test/test.parquet',\n      'format' = 'parquet',\n      's3.endpoint' = 's3.us-east-1.amazonaws.com',\n      's3.region' = 'us-east-1',\n      \"s3.access_key\" = \"<your-access-key>\",\n      \"s3.secret_key\"=\"<your-secret-key>\"\n  )\n"})}),"\n",(0,r.jsx)(n.h4,{id:"external-catalog",children:"External Catalog"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-SQL",children:"  CREATE CATALOG iceberg_catalog PROPERTIES (\n      'type' = 'iceberg',\n      'iceberg.catalog.type' = 'hadoop',\n      'warehouse' = 's3://your_bucket/dir/key',\n      's3.endpoint' = 's3.us-east-1.amazonaws.com',\n      's3.region' = 'us-east-1',\n      \"s3.access_key\" = \"<your-access-key>\",\n      \"s3.secret_key\"=\"<your-secret-key>\"\n  );\n"})}),"\n",(0,r.jsx)(n.h4,{id:"storage-vault",children:"Storage Vault"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-SQL",children:'CREATE STORAGE VAULT IF NOT EXISTS s3_demo_vault\nPROPERTIES (\n    "type" = "S3",\n    "s3.endpoint" = "s3.us-east-1.amazonaws.com",\n    "s3.region" = "us-east-1",\n    "s3.bucket" = "<your-bucket>",\n    "s3.access_key" = "<your-access-key>",\n    "s3.secret_key"="<your-secret-key>",\n    "s3.root.path" = "s3_demo_vault_prefix",\n    "provider" = "S3",\n    "use_path_style" = "false"\n);\n'})}),"\n",(0,r.jsx)(n.h4,{id:"export",children:"Export"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-SQL",children:'EXPORT TABLE s3_test TO "s3://your_bucket/a/b/c" \nPROPERTIES (\n    "column_separator"="\\\\x07", \n    "line_delimiter" = "\\\\x07"\n) WITH S3 (\n    "s3.endpoint" = "s3.us-east-1.amazonaws.com",\n    "s3.region" = "us-east-1",\n    "s3.access_key" = "<your-access-key>",\n    "s3.secret_key"="<your-secret-key>",\n)\n'})}),"\n",(0,r.jsx)(n.h4,{id:"repository",children:"Repository"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-SQL",children:'CREATE REPOSITORY `s3_repo`\nWITH S3\nON LOCATION "s3://your_bucket/s3_repo"\nPROPERTIES\n(\n    "s3.endpoint" = "s3.us-east-1.amazonaws.com",\n    "s3.region" = "us-east-1",\n    "s3.access_key" = "<your-access-key>",\n    "s3.secret_key"="<your-secret-key>"\n);\n'})}),"\n",(0,r.jsx)(n.h4,{id:"resource",children:"Resource"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-SQL",children:'CREATE RESOURCE "remote_s3"\nPROPERTIES\n(\n    "s3.endpoint" = "s3.us-east-1.amazonaws.com",\n    "s3.region" = "us-east-1",\n    "s3.bucket" = "<your-bucket>",\n    "s3.access_key" = "<your-access-key>",\n    "s3.secret_key"="<your-secret-key>"\n);\n'})}),"\n",(0,r.jsxs)(n.p,{children:["You can specify different IAM User credentials (",(0,r.jsx)(n.code,{children:"access_key"})," and ",(0,r.jsx)(n.code,{children:"secret_key"}),") across different business logic to implement access control for external data."]}),"\n",(0,r.jsx)(n.h2,{id:"assumed-role-authentication",children:"Assumed Role Authentication"}),"\n",(0,r.jsxs)(n.p,{children:["Assumed Role allows accessing external data sources by assuming an AWS IAM Role(for details, refer to AWS documentation ",(0,r.jsx)(n.a,{href:"https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_manage-assume.html",children:"assume role"}),"), the following diagram illustrates the configuration workflow:"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:s(214010).Z+"",width:"5600",height:"2800"})}),"\n",(0,r.jsx)(n.p,{children:"Terminology:"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"Source Account"}),": The AWS account initiating the Assume Role action (where Doris FE/BE EC2 instances reside);"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"Target Account"}),": The AWS account owning the target S3 bucket;"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"ec2_role"}),": A role created in the source account, attached to EC2 instances running Doris FE/BE;"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"bucket_role"}),": A role created in the target account with permissions to access the target bucket;"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Notes: "})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"The source and target accounts can be the same AWS account;"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsxs)(n.strong,{children:["Ensure All EC2 instances which Doris FE/BE deployed have been attached on ",(0,r.jsx)(n.code,{children:"ec_role\u200B"}),"\u200B, especially during scaling operations."]})}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"\u200B\u200BMore detailed configuration steps are as follows:\u200B"}),"\n",(0,r.jsx)(n.h3,{id:"step1-prerequisites",children:"Step1 Prerequisites"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Ensure the source account has created an ",(0,r.jsx)(n.code,{children:"ec2_role"})," and attached it to all ",(0,r.jsx)(n.code,{children:"EC2 instances"})," running Doris FE/BE;"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Ensure the target account has created a ",(0,r.jsx)(n.code,{children:"bucket_role"})," and corresponding bucket;"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["After attaching ",(0,r.jsx)(n.code,{children:"ec2_role"})," to ",(0,r.jsx)(n.code,{children:"EC2 instances"}),", you can find the ",(0,r.jsx)(n.code,{children:"role_arn"})," as shown below:"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:s(682778).Z+"",width:"1280",height:"522"})}),"\n",(0,r.jsx)(n.h3,{id:"step2-configure-permissions-for-source-account-iam-role-ec2-instance-role",children:"Step2 Configure Permissions for Source Account IAM Role (EC2 Instance Role)"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Log in to the ",(0,r.jsx)(n.a,{href:"https://us-east-1.console.aws.amazon.com/iamv2/home#/home",children:"AWS IAM Console"}),",navigate to \u200B\u200B",(0,r.jsx)(n.code,{children:"Access management"})," > ",(0,r.jsx)(n.code,{children:"Roles"}),"\uFF1B"]}),"\n",(0,r.jsx)(n.li,{children:"Find the EC2 instance role and click its name;"}),"\n",(0,r.jsxs)(n.li,{children:["On the role details page, go to the \u200B\u200B",(0,r.jsx)(n.code,{children:"Permissions"}),"\u200B\u200B tab, click \u200B\u200B",(0,r.jsx)(n.code,{children:"Add permissions"}),"\u200B\u200B, then select ",(0,r.jsx)(n.code,{children:"\u200B\u200BCreate inline policy"}),"\u200B\u200B;"]}),"\n",(0,r.jsxs)(n.li,{children:["In the \u200B\u200B",(0,r.jsx)(n.code,{children:"Specify permissions\u200B\u200B section"}),", switch to the ",(0,r.jsx)(n.code,{children:"\u200B\u200BJSON"}),"\u200B\u200B tab, paste the following policy, and click \u200B\u200B",(0,r.jsx)(n.code,{children:"Review policy"}),"\u200B\u200B:"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:s(897045).Z+"",width:"1280",height:"601"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-JSON",children:'{\n    "Version": "2012-10-17",\n    "Statement": [\n        {\n            "Effect": "Allow",\n            "Action": ["sts:AssumeRole"],\n            "Resource": "*"\n        }\n    ]\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"step3-configure-trust-policy-and-permissions-for-target-account-iam-role",children:"Step3 Configure Trust Policy and Permissions for Target Account IAM Role"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Log in ",(0,r.jsx)(n.a,{href:"https://us-east-1.console.aws.amazon.com/iamv2/home#/home",children:"AWS IAM Console"}),", navigate to \u200B\u200BAccess management > Roles\u200B\u200B, find the target role (bucket_role), and click its name;"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Go to the ",(0,r.jsx)(n.code,{children:"\u200B\u200BTrust relationships"}),"\u200B\u200B tab, click ",(0,r.jsx)(n.code,{children:"\u200B\u200BEdit trust policy"}),"\u200B\u200B, and paste the following JSON (replace <ec2_iam_role_arn> with your EC2 instance role ARN). Click \u200B\u200BUpdate policy"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:s(38772).Z+"",width:"1280",height:"634"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsxs)(n.strong,{children:["Note: The ",(0,r.jsx)(n.code,{children:"ExternalId"})," in the ",(0,r.jsx)(n.code,{children:"Condition"})," section is an optional string parameter used to distinguish scenarios where multiple source users need to assume the same role. If configured, include it in the corresponding Doris SQL statements. For a detailed explanation of ExternalId, refer to ",(0,r.jsx)(n.a,{href:"https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_common-scenarios_third-party.html",children:"aws doc"})]})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-JSON",children:'{\n    "Version": "2012-10-17",\n    "Statement": [\n        {\n            "Effect": "Allow",\n            "Principal": {\n                "AWS": "<ec2_iam_role_arn>"\n            },\n            "Action": "sts:AssumeRole",\n            "Condition": {\n                "StringEquals": {\n                    "sts:ExternalId": "1001"\n                }\n            }\n        }\n    ]\n}\n'})}),"\n",(0,r.jsxs)(n.ol,{start:"3",children:["\n",(0,r.jsxs)(n.li,{children:["On the role details page, go to the \u200B\u200B",(0,r.jsx)(n.code,{children:"Permissions"}),"\u200B\u200B tab, click ",(0,r.jsx)(n.code,{children:"\u200B\u200BAdd permissions"}),"\u200B\u200B, then select ",(0,r.jsx)(n.code,{children:"\u200B\u200BCreate inline policy"}),"\u200B\u200B. In the ",(0,r.jsx)(n.code,{children:"\u200B\u200BJSON"}),"\u200B\u200B tab, paste one of the following policies based on your requirements;"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:s(375386).Z+"",width:"1280",height:"636"})}),"\n",(0,r.jsx)(n.p,{children:"S3 read policy template\u200B,applies to Doris features requiring read/list access, e.g: S3 Load, TVF, External Catalog"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Notes: "})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsxs)(n.strong,{children:["Replace ",(0,r.jsx)(n.code,{children:"your-bucket"})," and ",(0,r.jsx)(n.code,{children:"your-prefix"})," with actual values."]})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsxs)(n.strong,{children:["Avoid adding extra ",(0,r.jsx)(n.code,{children:"/"})," separators."]})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n    "Version": "2012-10-17",\n    "Statement": [\n        {\n            "Effect": "Allow",\n            "Action": [\n              "s3:GetObject",\n              "s3:GetObjectVersion"\n            ],\n            "Resource": "arn:aws:s3:::<bucket>/<prefix>/*"\n        },\n        {\n            "Effect": "Allow",\n            "Action": [\n                "s3:ListBucket",\n                "s3:GetBucketLocation"\n            ],\n            "Resource": "arn:aws:s3:::<bucket>",\n        }\n    ]\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"S3 write policy template\u200B\u200B (Applies to Doris features requiring read/write access, e.g: Export, Storage Vault, Repository)"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Notes: "})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsxs)(n.strong,{children:["Replace ",(0,r.jsx)(n.code,{children:"your-bucket"})," and ",(0,r.jsx)(n.code,{children:"your-prefix"})," with actual values."]})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsxs)(n.strong,{children:["Avoid adding extra ",(0,r.jsx)(n.code,{children:"/"})," separators."]})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n    "Version": "2012-10-17",\n    "Statement": [\n        {\n            "Effect": "Allow",\n            "Action": [\n              "s3:PutObject",\n              "s3:GetObject",\n              "s3:GetObjectVersion",\n              "s3:DeleteObject",\n              "s3:DeleteObjectVersion",\n              "s3:AbortMultipartUpload",      \n              "s3:ListMultipartUploadParts"\n            ],\n            "Resource": "arn:aws:s3:::<bucket>/<prefix>/*"\n        },\n        {\n            "Effect": "Allow",\n            "Action": [\n                "s3:ListBucket",\n                "s3:GetBucketLocation"\n            ],\n            "Resource": "arn:aws:s3:::<bucket>"\n        }\n    ]\n}\n'})}),"\n",(0,r.jsxs)(n.h3,{id:"step4-use-doris-features-with-assumed-role-via-sql-according-to-role_arn-and-external_id-fields",children:["Step4 Use doris features with Assumed Role via SQL, according to ",(0,r.jsx)(n.code,{children:"role_arn"})," and ",(0,r.jsx)(n.code,{children:"external_id"})," fields"]}),"\n",(0,r.jsxs)(n.p,{children:["After completing the above configurations, obtain the target account's ",(0,r.jsx)(n.code,{children:"role_arn"})," and ",(0,r.jsx)(n.code,{children:"external_id"})," (if applicable).\nUse these parameters in doris SQL statements as shown below:"]}),"\n",(0,r.jsx)(n.p,{children:"Common important key parameters:\u200B\u200B"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:'"s3.role_arn" = "<your-bucket-role-arn>",\n"s3.external_id" = "<your-external-id>"      -- option parameter\n'})}),"\n",(0,r.jsx)(n.h4,{id:"s3-load-1",children:"S3 Load"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-SQL",children:'  LOAD LABEL s3_load_2022_04_01\n  (\n      DATA INFILE("s3://your_bucket_name/s3load_example.csv")\n      INTO TABLE test_s3load\n      COLUMNS TERMINATED BY ","\n      FORMAT AS "CSV"\n      (user_id, name, age)\n  )\n  WITH S3\n  (\n      "provider" = "S3",\n      "s3.endpoint" = "s3.us-east-1.amazonaws.com",\n      "s3.region" = "us-east-1",\n      "s3.role_arn" = "<your-bucket-role-arn>",\n      "s3.external_id" = "<your-external-id>"      -- option parameter\n  )\n  PROPERTIES\n  (\n      "timeout" = "3600"\n  );\n'})}),"\n",(0,r.jsx)(n.h4,{id:"tvf-1",children:"TVF"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-SQL",children:'  SELECT * FROM S3 (\n      "uri" = "s3://your_bucket/path/to/tvf_test/test.parquet",\n      "format" = "parquet",\n      "s3.endpoint" = "s3.us-east-1.amazonaws.com",\n      "s3.region" = "us-east-1",\n      "s3.role_arn" = "<your-bucket-role-arn>",\n      "s3.external_id" = "<your-external-id>"      -- option parameter\n  )\n'})}),"\n",(0,r.jsx)(n.h4,{id:"external-catalog-1",children:"External Catalog"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-SQL",children:'  CREATE CATALOG iceberg_catalog PROPERTIES (\n      "type" = "iceberg",\n      "iceberg.catalog.type" = "hadoop",\n      "warehouse" = "s3://your_bucket/dir/key",\n      "s3.endpoint" = "s3.us-east-1.amazonaws.com",\n      "s3.region" = "us-east-1",\n      "s3.role_arn" = "<your-bucket-role-arn>",\n      "s3.external_id" = "<your-external-id>"      -- option parameter\n  );\n'})}),"\n",(0,r.jsx)(n.h4,{id:"storage-vault-1",children:"Storage Vault"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-SQL",children:'CREATE STORAGE VAULT IF NOT EXISTS s3_demo_vault\nPROPERTIES (\n    "type" = "S3",\n    "s3.endpoint" = "s3.us-east-1.amazonaws.com",\n    "s3.region" = "us-east-1",\n    "s3.bucket" = "<your-bucket>",\n    "s3.role_arn" = "<your-bucket-role-arn>",\n    "s3.external_id" = "<your-external-id>",            -- option parameter\n    "s3.root.path" = "s3_demo_vault_prefix",\n    "provider" = "S3",\n    "use_path_style" = "false"\n);\n'})}),"\n",(0,r.jsx)(n.h4,{id:"export-1",children:"Export"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-SQL",children:'EXPORT TABLE s3_test TO "s3://your_bucket/a/b/c" \nPROPERTIES (\n    "column_separator"="\\\\x07", \n    "line_delimiter" = "\\\\x07"\n) WITH S3 (\n    "s3.endpoint" = "s3.us-east-1.amazonaws.com",\n    "s3.region" = "us-east-1",\n    "s3.role_arn" = "<your-bucket-role-arn>",\n    "s3.external_id" = "<your-external-id>"\n)\n'})}),"\n",(0,r.jsx)(n.h4,{id:"repository-1",children:"Repository"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-SQL",children:'CREATE REPOSITORY `s3_repo`\nWITH S3\nON LOCATION "s3://your_bucket/s3_repo"\nPROPERTIES\n(\n    "s3.endpoint" = "s3.us-east-1.amazonaws.com",\n    "s3.region" = "us-east-1",\n    "s3.role_arn" = "<your-bucket-role-arn>",\n    "s3.external_id" = "<your-external-id>"\n);\n'})}),"\n",(0,r.jsx)(n.h4,{id:"resource-1",children:"Resource"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-SQL",children:'CREATE RESOURCE "remote_s3"\nPROPERTIES\n(\n    "s3.endpoint" = "s3.us-east-1.amazonaws.com",\n    "s3.region" = "us-east-1",\n    "s3.bucket" = "<your-bucket>",\n    "s3.role_arn" = "<your-bucket-role-arn>",\n    "s3.external_id" = "<your-external-id>"\n);\n'})}),"\n",(0,r.jsx)(n.h3,{id:"aws-eks-cluster-iam-role-authentication-and-authorization",children:"AWS EKS Cluster IAM Role Authentication and Authorization"}),"\n",(0,r.jsx)(n.p,{children:"For applications (such as Apache Doris) running in an Amazon EKS cluster that need to be granted AWS Identity and Access Management (IAM) permissions, Amazon EKS provides the following two primary methods:"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"1.IAM Roles for Service Accounts (IRSA)\u200B"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"2. EKS Pod Identity\u200B"})}),"\n",(0,r.jsx)(n.p,{children:"Both methods require correct configuration of the IAM Role, corresponding trust policy, and IAM policy in the EKS cluster. For specific configuration methods, please refer to the AWS official documentation:"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.a,{href:"https://docs.aws.amazon.com/eks/latest/userguide/service-accounts.html#service-accounts-iam",children:"Granting AWS Identity and Access Management permissions to workloads on Amazon Elastic Kubernetes Service clusters"})}),"\n",(0,r.jsxs)(n.p,{children:["Doris FE/BE supports automatically detecting and obtaining credentials via the ",(0,r.jsx)(n.code,{children:"AWSCredentialsProviderChain"})," method."]}),"\n",(0,r.jsx)(n.h3,{id:"bucket-policy-authentication-and-authorization",children:"Bucket Policy Authentication and Authorization"}),"\n",(0,r.jsx)(n.p,{children:"For Doris machines deployed using IAM Roles, import, export, and TVF scenarios also support using Amazon S3 bucket policies to control access to objects in AWS S3 buckets. This allows restricting access to the object bucket only to users associated with the EC2 machine. The specific steps are as follows:"}),"\n",(0,r.jsx)(n.p,{children:"1\u3001Set the Bucket Policy for the target bucket."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n    "Version": "2012-10-17",\n    "Statement": [\n        {\n            "Effect": "Allow",\n            "Principal": {\n                "AWS": [\n                    "arn:aws:iam::111122223333:root"\n                ]\n            },\n            "Action": [\n                "s3:PutObject",\n                "s3:GetObject",\n                "s3:GetObjectVersion",\n                "s3:DeleteObject",\n                "s3:DeleteObjectVersion",\n                "s3:AbortMultipartUpload",\n                "s3:ListMultipartUploadParts"\n            ],\n            "Resource": "arn:aws:s3:::<bucket>/<prefix>/*"\n        },\n        {\n            "Effect": "Allow",\n            "Principal": {\n                "AWS": [\n                    "arn:aws:iam::111122223333:root"\n                ]\n            },\n            "Action": [\n                "s3:ListBucket",\n                "s3:GetBucketLocation"\n            ],\n            "Resource": "arn:aws:s3:::<bucket>",\n        }\n    ]\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Please replace ",(0,r.jsx)(n.code,{children:"arn:aws:iam::111122223333:root"})," with the ARN of the account or Role bound to the EC2 machine."]}),"\n",(0,r.jsx)(n.p,{children:"2\u3001Use the corresponding SQL syntax for data access. Authentication credentials are automatically detected, no manual AK/SK or ARN configuration required."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:'  SELECT * FROM S3 (\n      "uri" = "s3://your_bucket/path/to/tvf_test/test.parquet",\n      "format" = "parquet",\n      "s3.endpoint" = "s3.us-east-1.amazonaws.com",\n      "s3.region" = "us-east-1"\n  )\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Doris FE/BE supports automatically detecting and obtaining credentials via the ",(0,r.jsx)(n.code,{children:"AWSCredentialsProviderChain"})," method."]}),"\n",(0,r.jsxs)(n.p,{children:["Reference documentation: ",(0,r.jsx)(n.a,{href:"https://docs.aws.amazon.com/zh_cn/AmazonS3/latest/userguide/example-bucket-policies.html",children:"Bucket Policy"})]}),"\n",(0,r.jsx)(n.h3,{id:"best-practices-for-authentication-methods",children:"Best Practices for Authentication Methods"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{style:{textAlign:"left"},children:"Authentication Method"}),(0,r.jsx)(n.th,{style:{textAlign:"left"},children:"Applicable Scenarios"}),(0,r.jsx)(n.th,{children:"Advantages"}),(0,r.jsx)(n.th,{children:"Disadvantages"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:"AK/SK Authentication"}),(0,r.jsx)(n.td,{style:{textAlign:"left"},children:"Import/Export/StorageVault scenarios with privately deployed, security-controlled storage or non-AWS S3 object storage."}),(0,r.jsx)(n.td,{children:"Simple configuration, supports object storage compatible with AWS S3."}),(0,r.jsx)(n.td,{children:"Risk of secret key leakage; manual key rotation required."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:"IAM Role Authentication"}),(0,r.jsx)(n.td,{style:{textAlign:"left"},children:"Import/Export/StorageVault scenarios on AWS S3 public cloud with high-security requirements."}),(0,r.jsx)(n.td,{children:"High security, automatic AWS credential rotation, centralized permission configuration."}),(0,r.jsx)(n.td,{children:"Complex Bucket Policy/Trust configuration process."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:"Bucket Policy Authentication"}),(0,r.jsx)(n.td,{style:{textAlign:"left"},children:"Import/Export/StorageVault scenarios on AWS S3 public cloud with a small number of buckets"}),(0,r.jsx)(n.td,{children:"Moderate configuration complexity, adheres to the principle of least privilege, automatically detects AWS credentials."}),(0,r.jsx)(n.td,{children:"Permission configuration is scattered across various bucket policies."})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"faq",children:"FAQ"}),"\n",(0,r.jsx)(n.h4,{id:"1-how-to-set-aws-sdk-debug-level-logs-for-be-and-recycler",children:"1. How to set AWS SDK DEBUG level logs for BE and Recycler?"}),"\n",(0,r.jsx)(n.p,{children:"Configure aws_log_level=5 in be.conf and doris_cloud.conf, then restart the processes to apply the changes."}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Type: int32"}),"\n",(0,r.jsxs)(n.li,{children:["Description: Log level for AWS SDK\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"   Off = 0,\n   Fatal = 1,\n   Error = 2,\n   Warn = 3,\n   Info = 4,\n   Debug = 5,\n   Trace = 6\n"})}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"Default value: 2"}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"2after-setting-aws-sdk-debug-level-logs-the-following-error-appears-in-belogrecyclerlog",children:"2.After setting AWS SDK DEBUG level logs, the following error appears in be.log/recycler.log:"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.code,{children:"OpenSSL SSL_connect: Connection reset by peer in connection to sts.me-south-1.amazonaws.com:443 "})}),"\n",(0,r.jsx)(n.p,{children:"Check whether the AWS VPC network configuration or firewall port settings have issues preventing access to the STS service in the corresponding AWS region (verify connectivity via telnet host:port)."})]})}function u(e={}){let{wrapper:n}={...(0,i.a)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},214010:function(e,n,s){s.d(n,{Z:function(){return t}});let t=s.p+"assets/images/assumed_role_flow-75befacf1e4eb2092b43247ff5ea2deb.png"},622756:function(e,n,s){s.d(n,{Z:function(){return t}});let t=s.p+"assets/images/create_iam_user-2f5798289db11561f58996f843a57007.png"},682778:function(e,n,s){s.d(n,{Z:function(){return t}});let t=s.p+"assets/images/ec2_instance-8a07fa1579df9c49f28d1afeb8b43320.png"},378198:function(e,n,s){s.d(n,{Z:function(){return t}});let t=s.p+"assets/images/iam_user_attach_policy1-82e3e146a7e676f875e6b8ec7a976eb8.png"},285612:function(e,n,s){s.d(n,{Z:function(){return t}});let t=s.p+"assets/images/iam_user_attach_policy2-3dd286ac1d3849842ffc68dbe63ff671.png"},808504:function(e,n,s){s.d(n,{Z:function(){return t}});let t=s.p+"assets/images/iam_user_create_ak_sk-6085deeaca04ff0daec92673dda55f45.png"},897045:function(e,n,s){s.d(n,{Z:function(){return t}});let t=s.p+"assets/images/source_role_permission-39ded5d47d26095cb01555e8fd159001.png"},375386:function(e,n,s){s.d(n,{Z:function(){return t}});let t=s.p+"assets/images/target_role_permission2-62b5c0254e966762f0c5f299499b6bdd.png"},38772:function(e,n,s){s.d(n,{Z:function(){return t}});let t=s.p+"assets/images/target_role_trust_policy-86ffe376e4663a12a675419bfb4e6e70.png"},250065:function(e,n,s){s.d(n,{Z:function(){return a},a:function(){return o}});var t=s(667294);let r={},i=t.createContext(r);function o(e){let n=t.useContext(i);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);