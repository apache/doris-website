"use strict";(self.webpackChunkdoris_website=self.webpackChunkdoris_website||[]).push([["315890"],{820531:function(e,n,i){i.r(n),i.d(n,{default:()=>h,frontMatter:()=>c,metadata:()=>t,assets:()=>d,toc:()=>o,contentTitle:()=>a});var t=JSON.parse('{"id":"query-acceleration/distinct-counts/bitmap-precise-deduplication","title":"BITMAP Precise Deduplication","description":"This document explains how to achieve precise deduplication using the Bitmap type.","source":"@site/versioned_docs/version-3.x/query-acceleration/distinct-counts/bitmap-precise-deduplication.md","sourceDirName":"query-acceleration/distinct-counts","slug":"/query-acceleration/distinct-counts/bitmap-precise-deduplication","permalink":"/docs/3.x/query-acceleration/distinct-counts/bitmap-precise-deduplication","draft":false,"unlisted":false,"tags":[],"version":"3.x","lastUpdatedAt":1770477659000,"frontMatter":{"title":"BITMAP Precise Deduplication","language":"en","description":"This document explains how to achieve precise deduplication using the Bitmap type."},"sidebar":"docs","previous":{"title":"High-Concurrency Point Query Optimization","permalink":"/docs/3.x/query-acceleration/high-concurrent-point-query"},"next":{"title":"HLL Approximate Deduplication","permalink":"/docs/3.x/query-acceleration/distinct-counts/hll-approximate-deduplication"}}'),s=i("785893"),r=i("250065");let c={title:"BITMAP Precise Deduplication",language:"en",description:"This document explains how to achieve precise deduplication using the Bitmap type."},a="BITMAP Precise Deduplication",d={},o=[{value:"Implementation of Count Distinct",id:"implementation-of-count-distinct",level:2},{value:"Use Cases",id:"use-cases",level:3},{value:"Use BITMAP for Precise Deduplication",id:"use-bitmap-for-precise-deduplication",level:2},{value:"Table Creation",id:"table-creation",level:3},{value:"Data Import",id:"data-import",level:3},{value:"Querying Data",id:"querying-data",level:3}];function l(e){let n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.a)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"bitmap-precise-deduplication",children:"BITMAP Precise Deduplication"})}),"\n",(0,s.jsx)(n.p,{children:"This document explains how to achieve precise deduplication using the Bitmap type."}),"\n",(0,s.jsxs)(n.p,{children:["Bitmap is an efficient bitmap indexing technique that uses bits to indicate the presence of corresponding data. It is particularly suitable for scenarios requiring efficient set operations (e.g., union, intersection) and is highly memory-efficient. Using Bitmap for precise deduplication offers the following benefits over ",(0,s.jsx)(n.code,{children:"COUNT DISTINCT"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Improved query speed."}),"\n",(0,s.jsx)(n.li,{children:"Reduced memory/disk usage."}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"implementation-of-count-distinct",children:"Implementation of Count Distinct"}),"\n",(0,s.jsxs)(n.p,{children:["Traditional precise deduplication relies on ",(0,s.jsx)(n.code,{children:"COUNT DISTINCT"}),". Consider the following example where deduplication is performed on the ",(0,s.jsx)(n.code,{children:"name"})," column:"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"id"}),(0,s.jsx)(n.th,{children:"name"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"1"}),(0,s.jsx)(n.td,{children:"bob"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"2"}),(0,s.jsx)(n.td,{children:"alex"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"3"}),(0,s.jsx)(n.td,{children:"jack"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"4"}),(0,s.jsx)(n.td,{children:"tom"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"5"}),(0,s.jsx)(n.td,{children:"bob"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"6"}),(0,s.jsx)(n.td,{children:"alex"})]})]})]}),"\n",(0,s.jsxs)(n.p,{children:["When Doris executes the query ",(0,s.jsx)(n.code,{children:"SELECT COUNT(DISTINCT name) FROM t"}),", the process involves:"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Grouping by the ",(0,s.jsx)(n.code,{children:"name"})," column for stage-one deduplication."]}),"\n",(0,s.jsx)(n.li,{children:"Shuffling the grouped data."}),"\n",(0,s.jsx)(n.li,{children:"Performing stage-two deduplication and finally counting the distinct names."}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"The process can be visualized as follows:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"        Scan                              1st Group By                       2nd Group By                     Count \n  +---------------+                   +------------+                       +------------+                +------------+ \n  | id  | name    |                   |   name     |                       |   name     |                | count(name)| \n  +-----+---------+                   +------------+                       +------------+                +------------+ \n  |  1  |   bob   |  ---------------\x3e |    bob     |                       |    bob     |    -------\x3e    |     4      | \n  |  2  |   alex  |                   |    alex    |                       |    alex    |                +------------+ \n  |  5  |   bob   |                   +------------+                       |    jack    | \n  |  6  |   alex  |                                                        |    tom     | \n  +---------------+                                                        +------------+ \n                                                        ----------------\x3e \n                                           \n                                           \n  +---------------+                   +------------+ \n  | id  | name    |                   |   name     | \n  +-----+---------+  ---------------\x3e +------------+ \n  |  3  |  jack   |                   |    jack    | \n  |  4  |   tom   |                   |    tom     | \n  +-----+---------+                   +------------+\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Since ",(0,s.jsx)(n.code,{children:"COUNT DISTINCT"})," requires storing detailed data and performing shuffling, query performance slows down as the dataset grows. Using Bitmap for precise deduplication addresses the performance issues of ",(0,s.jsx)(n.code,{children:"COUNT DISTINCT"})," in large datasets."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"use-cases",children:"Use Cases"}),"\n",(0,s.jsxs)(n.p,{children:["In large-scale data scenarios, the cost of deduplication using ",(0,s.jsx)(n.code,{children:"COUNT DISTINCT"})," increases significantly, resulting in slower queries. Bitmap-based precise deduplication addresses these performance bottlenecks by mapping detailed data to bits. While sacrificing the flexibility of raw data, Bitmap greatly enhances computational efficiency. Consider using Bitmap in the following scenarios:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Query Acceleration"}),": Bitmap utilizes bitwise operations for computation, offering excellent performance."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Storage Compression"}),": Bitmap compresses detailed data into bits, significantly reducing resource consumption on disk and in memory."]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["However, Bitmap can only perform precise deduplication on data types such as ",(0,s.jsx)(n.code,{children:"TINYINT"}),", ",(0,s.jsx)(n.code,{children:"SMALLINT"}),", ",(0,s.jsx)(n.code,{children:"INT"}),", and ",(0,s.jsx)(n.code,{children:"BIGINT"}),". For other data types, a global dictionary must be constructed. Doris implements precise deduplication using ",(0,s.jsx)(n.code,{children:"RoaringBitmap"}),". For more details, refer to ",(0,s.jsx)(n.a,{href:"https://roaringbitmap.org/",children:"RoaringBitmap"}),"."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"use-bitmap-for-precise-deduplication",children:"Use BITMAP for Precise Deduplication"}),"\n",(0,s.jsx)(n.h3,{id:"table-creation",children:"Table Creation"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["When using Bitmap for deduplication, set the target column type to ",(0,s.jsx)(n.code,{children:"BITMAP"})," in the table creation statement and specify ",(0,s.jsx)(n.code,{children:"BITMAP_UNION"})," as the aggregate function."]}),"\n",(0,s.jsx)(n.li,{children:"Columns of type Bitmap cannot be used as key columns."}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Create an aggregate table ",(0,s.jsx)(n.code,{children:"test_bitmap"}),". The ",(0,s.jsx)(n.code,{children:"id"})," column represents the user ID, and the ",(0,s.jsx)(n.code,{children:"uv"})," column is of type ",(0,s.jsx)(n.code,{children:"BITMAP"}),", using the aggregate function ",(0,s.jsx)(n.code,{children:"BITMAP_UNION"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"CREATE TABLE test_bitmap(\n        dt DATE,\n        id INT,\n        name CHAR(10),\n        province CHAR(10),\n        os CHAR(10),\n        uv BITMAP BITMAP_UNION\n)\nAGGREGATE KEY (dt, id, name, province, os)\nDISTRIBUTED BY HASH(id) BUCKETS 10;\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"data-import",children:"Data Import"}),"\n",(0,s.jsxs)(n.p,{children:["Here is a sample dataset (",(0,s.jsx)(n.code,{children:"test_bitmap.csv"}),") that can be imported using Stream Load:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"2022-05-05,10001,Test 01,Beijing,windows \n2022-05-05,10002,Test 01,Beijing,linux \n2022-05-05,10003,Test 01,Beijing,macos \n2022-05-05,10004,Test 01,Hebei,windows \n2022-05-06,10001,Test 01,Shanghai,windows \n2022-05-06,10002,Test 01,Shanghai,linux \n2022-05-06,10003,Test 01,Jiangsu,macos \n2022-05-06,10004,Test 01,Shaanxi,windows\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Stream Load Command"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'curl --location-trusted -u root: -H "label:label_test_bitmap_load" \\\n    -H "column_separator:," \\\n    -H "columns:dt,id,name,province,os, uv=to_bitmap(id)" -T test_bitmap.csv http://fe_IP:8030/api/demo/test_bitmap/_stream_load\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"querying-data",children:"Querying Data"}),"\n",(0,s.jsxs)(n.p,{children:["Bitmap columns cannot directly return raw values. Instead, use the ",(0,s.jsx)(n.code,{children:"BITMAP_UNION_COUNT"})," aggregate function for queries."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Total UV Calculation"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"SELECT BITMAP_UNION_COUNT(uv) FROM test_bitmap;\n+---------------------+\n| BITMAP_UNION_COUNT(`uv`) |\n+---------------------+\n|                   4 |\n+---------------------+\n"})}),"\n",(0,s.jsx)(n.p,{children:"Equivalent to:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"SELECT COUNT(DISTINCT id) FROM test_bitmap;\n+----------------------+\n| COUNT(DISTINCT `id`) |\n+----------------------+\n|                    4 |\n+----------------------+\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Daily UV Calculation"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"SELECT dt, BITMAP_UNION_COUNT(uv) FROM test_bitmap GROUP BY dt;\n+------------+---------------------+\n| dt         | BITMAP_UNION_COUNT |\n+------------+---------------------+\n| 2022-05-05 |                   4 |\n| 2022-05-06 |                   4 |\n+------------+---------------------+\n"})})]})}function h(e={}){let{wrapper:n}={...(0,r.a)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},250065:function(e,n,i){i.d(n,{Z:function(){return a},a:function(){return c}});var t=i(667294);let s={},r=t.createContext(s);function c(e){let n=t.useContext(r);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:c(e.components),t.createElement(r.Provider,{value:n},e.children)}}}]);