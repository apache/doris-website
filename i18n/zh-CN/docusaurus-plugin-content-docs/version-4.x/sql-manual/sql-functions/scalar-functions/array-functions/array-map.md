---
{
    "title": "ARRAY_MAP",
    "language": "zh-CN",
    "description": "对数组中的元素应用 lambda 表达式，返回一个新数组。函数会为数组中的每个元素应用 lambda 表达式，返回对应的结果。"
}
---

## array_map

<version since="2.0.0">

</version>

## 描述

对数组中的元素应用 lambda 表达式，返回一个新数组。函数会为数组中的每个元素应用 lambda 表达式，返回对应的结果。

## 语法

```sql
array_map(lambda, ARRAY<T> arr1, [ARRAY<T> arr2, ...])
```

### 参数

- `lambda`：lambda 表达式，用于定义转换规则
- `arr1, arr2, ...`：ARRAY<T> 类型，要转换的数组。支持一个或多个数组参数。

**T 支持的类型：**
- 数值类型：TINYINT、SMALLINT、INT、BIGINT、LARGEINT、FLOAT、DOUBLE、DECIMAL
- 字符串类型：CHAR、VARCHAR、STRING
- 日期时间类型：DATE、DATETIME、DATEV2、DATETIMEV2
- 布尔类型：BOOLEAN
- IP 类型：IPV4、IPV6
- 复杂类型：ARRAY、MAP、STRUCT

### 返回值

返回类型：ARRAY<R>

返回值含义：
- 返回一个与输入数组等长的新数组，每个位置的值为对应元素应用 lambda 表达式后的结果
- NULL：如果输入数组为 NULL

使用说明：
- lambda 表达式中参数个数需与数组参数个数一致
- 当有多个数组参数时，所有数组的长度必须一致
- lambda 可以用任意标量表达式，不能用聚合函数
- lambda 表达式可以调用其他高阶函数，但需要返回类型兼容
- 对数组元素中的 null 值：null 元素会传递给 lambda 表达式处理，lambda 可以判断 null 值

**查询示例：**

对数组中的每个元素进行平方运算：
```sql
SELECT array_map(x -> x * x, [1, 2, 3, 4, 5]);
+------------------------------------------+
| array_map(x -> x * x, [1, 2, 3, 4, 5]) |
+------------------------------------------+
| [1, 4, 9, 16, 25]                       |
+------------------------------------------+
```

对浮点数数组中的每个元素进行四舍五入：
```sql
SELECT array_map(x -> round(x), [1.1, 2.7, 3.3, 4.9, 5.5]);
+--------------------------------------------------+
| array_map(x -> round(x), [1.1, 2.7, 3.3, 4.9, 5.5]) |
+--------------------------------------------------+
| [1, 3, 3, 5, 6]                                 |
+--------------------------------------------------+
```

对字符串数组中的每个元素进行长度计算：
```sql
SELECT array_map(x -> length(x), ['a', 'bb', 'ccc', 'dddd', 'eeeee']);
+--------------------------------------------------+
| array_map(x -> length(x), ['a', 'bb', 'ccc', 'dddd', 'eeeee']) |
+--------------------------------------------------+
| [1, 2, 3, 4, 5]                                 |
+--------------------------------------------------+
```

对包含 null 的数组进行处理：
```sql
SELECT array_map(x -> x is not null, [1, null, 3, null, 5]);
+--------------------------------------------------+
| array_map(x -> x is not null, [1, null, 3, null, 5]) |
+--------------------------------------------------+
| [1, 0, 1, 0, 1]                                 |
+--------------------------------------------------+
```

多数组参数示例，对两个数组的对应元素进行相加：
```sql
SELECT array_map((x, y) -> x + y, [1, 2, 3, 4, 5], [10, 20, 30, 40, 50]);
+--------------------------------------------------+
| array_map((x, y) -> x + y, [1, 2, 3, 4, 5], [10, 20, 30, 40, 50]) |
+--------------------------------------------------+
| [11, 22, 33, 44, 55]                             |
+--------------------------------------------------+
```

嵌套数组处理，对每个子数组进行长度计算：
```sql
SELECT array_map(x -> size(x), [[1,2],[3,4,5],[6],[7,8,9,10]]);
+--------------------------------------------------+
| array_map(x -> size(x), [[1,2],[3,4,5],[6],[7,8,9,10]]) |
+--------------------------------------------------+
| [2, 3, 1, 4]                                     |
+--------------------------------------------------+
```

map 类型处理，提取每个 map 中 key 为 'a' 的值：
```sql
SELECT array_map(x -> x['a'], [{'a':1,'b':2}, {'a':3,'b':4}, {'a':5,'b':6}]);
+--------------------------------------------------+
| array_map(x -> x['a'], [{'a':1,'b':2}, {'a':3,'b':4}, {'a':5,'b':6}]) |
+--------------------------------------------------+
| [1, 3, 5]                                        |
+--------------------------------------------------+
```

参数数量错误会报错：
```sql
SELECT array_map();
ERROR 1105 (HY000): errCode = 2, detailMessage = Can not found function 'array_map' which has 0 arity. Candidate functions are: [array_map(Expression, Expression...)]
```

lambda 表达式中参数个数和数组参数个数不一致报错：
```sql
SELECT array_map(x -> x > 0, [1,2,3], [4,5,6], [7,8,9]);
ERROR 1105 (HY000): errCode = 2, detailMessage = lambda x -> (x > 0) arguments' size is not equal parameters' size
```

传入非数组类型时会报错：
```sql
SELECT array_map(x -> x * 2, 'not_an_array');
ERROR 1105 (HY000): errCode = 2, detailMessage = Can not find the compatibility function signature: array_map(Expression, VARCHAR(12))
```

### Keywords

ARRAY, MAP, ARRAY_MAP
