---
{
    "title": "BM25 文本检索打分",
    "language": "zh-CN"
}
---

## 概述

BM25（Best Matching 25）是一种基于概率的文本相关性评分算法，广泛应用于全文搜索引擎中。Doris的BM25实现为倒排索引查询提供了相关性评分功能，帮助用户按相关度排序搜索结果。

## BM25算法原理

### 核心公式

BM25的核心评分公式为：

```
Score = IDF × (tf × (k1 + 1)) / (tf + k1 × (1 - b + b × |d|/avgdl))
```

其中：
- **tf** (term frequency): 词项在文档中的出现频率
- **IDF** (Inverse Document Frequency): 逆文档频率
- **|d|**: 当前文档的长度（词数）
- **avgdl**: 集合中所有文档的平均长度
- **k1, b**: 算法调节参数

### 参数说明

| 参数 | 默认值 | 含义 | 数据库中的表示 |
|------|--------|------|---------------|
| k1 | 1.2 | 控制tf饱和度的参数。值越大，tf的影响越大 | 固定参数，不可配置 |
| b | 0.75 | 控制文档长度归一化的参数。0表示不考虑文档长度，1表示完全归一化 | 固定参数，不可配置 |
| boost | 1.0 | 查询增强因子 | 固定参数，不可配置 |

### 统计信息计算

**IDF计算公式：**

```
IDF = log(1 + (总文档数 - 包含该词的文档数 + 0.5) / (包含该词的文档数 + 0.5))
```

**平均文档长度（avgdl）：**

```
avgdl = 总词数 / 总文档数
```

## 功能特性和限制

### 支持的索引类型

- ✅ **Tokenized索引**：预定义分词器和自定义分词器
- ❌ **非Tokenized索引**：不分词索引

:::tip 注意
与Elasticsearch不同，Doris的BM25评分仅适用于分词索引，不分词索引主要用于精确匹配，不提供相关性评分。
:::

### 支持的查询类型

- MATCH_ANY
- MATCH_ALL
- MATCH_PHRASE
- MATCH_PHRASE_PREFIX

### 查询下推限制

1. select后project必须存在score()函数
2. where条件后filter必须包含match查询条件
3. 必须是topn查询，并且order by后必须是score列

## 使用方法

### 基本查询语法

```sql
SELECT *, score() as score
FROM search_demo
WHERE content MATCH_ANY 'search query'
ORDER BY score DESC
LIMIT 10;
```

## 注意事项

1. **分数范围**：BM25分数没有固定的上下界，分数的相对大小比绝对值更有意义
2. **空查询**：如果查询词项在集合中不存在，将返回0分
3. **文档长度影响**：较短的文档在包含查询词项时通常获得更高分数
4. **查询词项数量**：多词项查询的分数是各词项分数的组合（相加）

## 常见问题

**Q: 为什么不分词索引类型字段无法使用BM25评分？**

A: Doris的设计中，不分词索引字段主要用于精确匹配，不进行分词，因此不适用BM25评分。

**Q: 如何提高查询性能？**

A:
- 确保查询模式符合下推优化条件
- 使用合适的LIMIT，避免不必要的大结果集
- 确保查询条件都正确过倒排索引

**Q: 分数为0是什么原因？**

A:
- 查询词项在文档中不存在，或者文档长度信息缺失
- 可能没有正确虚拟列下推，需要结合explain分析查看
