---
{
    'title': 'Apache Doris 在蔚来汽车的应用',
    'summary': '蔚来（纽约证券交易所代码：NIO）是设计高端智能电动汽车市场的领先公司. NIO 成立于 2014 年 11 月，设计、开发、联合制造和销售高端智能电动汽车，并不断推动自动驾驶、数字技术、电动动力总成和电池领域的创新,Doris作为统一OLAP数仓,Doris在运营平台上的实践',
    'date': '2022-11-28',
    'author': '唐怀东',
    'tags': ['最佳实践'],
}
---

<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->


# Apache Doris 在蔚来汽车的应用

![NIO](/images/NIO_kv.png)

>导读：本次分享的题目是Apache Doris在蔚来汽车的应用，主要包括以下几大部分：
>1. 蔚来
>2. OLAP在蔚来的发展
>3. Doris作为统一OLAP数仓
>4. Doris在运营平台上的实践
>5. 经验总结

作者：唐怀东，蔚来汽车 数据团队负责人

## 蔚来

蔚来（纽约证券交易所代码：NIO）是设计高端智能电动汽车市场的领先公司。 NIO 成立于 2014 年 11 月，设计、开发、联合制造和销售高端智能电动汽车，并不断推动自动驾驶、数字技术、电动动力总成和电池领域的创新。

## OLAP在蔚来的发展

首先，让我们来一起回顾OLAP在蔚来汽车的发展。

### 1. 2017年引入Apache Druid

在当时可选择的OLAP存储和查询引擎并不多，比较常见的有Apache Druid、Apache Kylin。我们优先引入Druid的原因是以前有使用经验，而Kylin预计算虽然具有极高的查询效率优势，但是：

- Kylin底层最合适和最优的存储是HBase，之前公司并未引入，会额外增加运维的工作。

- Kylin对各种维度和指标进行预计算，如果维度和维度取值非常多，会有维度爆炸的问题，对存储造成非常大的压力。

Druid的优势很明显，支持实时和离线数据接入，列式存储，高并发，查询效率非常高。其缺点也比较明显：

- 未使用标准协议例如JDBC，使用门槛高
- Join的支持较弱
- 精确去重的效率低，性能会随之下降。整体性能要分场景去考虑，这也是我们后期去选型其他OLAP的原因
- 运维成本高，不同的组件有不同的安装方式和不同的依赖；数据导入还要考虑和Hadoop集成以及JAR包的依赖

### 2. 2019年引入TiDB

**TiDB是一个OLTP+OLAP的成熟引擎，同样是优点、缺点分明：**

优势：

- OLTP数据库，更新友好。
- 支持明细和聚合，有指标计算和数据看板展示，还支持明细数据查询
- 支持标准SQL，使用成本低
- 运维成本低

劣势：
- 它不是一个独立的OLAP。TiFlash依赖于OLTP，会增加存储。其OLAP能力稍显不足
- 整体性能要分场景去衡量

### 3. 2021年引入Doris

自2021年起，我们正式引入了Apache Doris。在系统选型过程中，产品的性能、SQL语法、系统兼容性、学习以及运维成本等多方面因素是我们最为关心的部分。经过深入调研、层层对比以下几个系统后，我们得出了如下结论：

**我们重点关注的Doris，其优点完全满足我们的诉求：**

- 支持高并发查询（我们最关心的一点）
- 同时支持实时和离线数据
- 支持明细和聚合
- Uniq模型支持更新
- 物化视图的能力能极大的加速查询效率
- 兼容MySQL协议，所以开发和使用成本比较低
- 性能完全满足我们的要求
- 运维成本比较低

**Clickhouse，我们之前也调研过，也尝试想去使用它。其单机性能极强，但是缺点明显:**

- 我们明确需要的场景下，它的多表join支持的稍微差一些
- 并发度比较低
- 运维成本极高

凭借多种性能优势，Apache Doris比较理想地替代了Druid和TiDB。而Clickhouse在我们的业务上并不能很好的适配，让我们最终走向了Apache Doris。

## Doris作为统一OLAP数仓

![NIO](/images/olap.png)

这张图基本上就是从数据源到数据接入、数据计算、数据仓库、数据服务以及应用。

### 1. 数据源

蔚来的场景下，数据源不仅仅指业务系统的数据，还有埋点数据、设备数据、车辆数据等等。数据会通过一种接入方式接入到大数据平台。

### 2. 数据接入

对于一些业务系统的数据，可以开启CDC捕捉变化的数据，然后转换成一个数据流存储到Kafka，接续再进行流式的计算。某些只能通过批量的方式的数据会直接进入到我们的分布式存储。

### 3. 数据计算

我们没有采用流批一体，采用的是Lambda架构。
我们本身的业务决定了我们的Lambda架构是离线和实时分成了两条路径：
- 部分数据是流式的。
- 部分数据能够存储到数据流里，一些历史数据不会存储到Kafka。
- 有些场景数据要求高精准度。为了保证数据的准确性，一个离线的pipeline将会把整个数据重新计算和刷新。

### 4. 数据仓库

数据计算到数仓，这两条线路我们没有采用Flink或Spark Doris Connector。我们用Routine Load来连接Apache Doris和Flink，用Broker Load连接Doris和Spark。 由Spark批量生成的数据，会备份到Hive供其他场景使用。这样每计算一次，就同时供多个场景去使用，大大提升了效率。Flink的情况也诸如此类。

### 5. 数据服务

Doris后面是One Service。通过注册数据源或灵活配置的方式，自动生成API，对API进行流量的控制和权限的控制，灵活性大大提高。并借助于k8s serverless方案，整个服务非常灵活和丰富。

### 6. 数据应用

应用层中我们主要是部署一些报表应用和其他的一些服务。

我们主要有两类使用场景：
- 面向用户，类似于互联网，我们有很多用户的场景，包括看板和指标
- 面向车，车的数据通过这种方式进入到Doris，通过一定的聚合之后，Doris数据体量在几十亿级别。但总体性能仍然可以满足我们的要求。

## Doris在运营平台上的实践

### 1. CDP Architecture

![NIO](/images/cdp.png)

接下来我来介绍Doris在运营平台上的实践。这是我们的真实使用场景。如今互联网公司普遍会做自己的CDP，它一般包括几个模块：
- 标签，是最基础的部分。
- 圈人，基于标签，按照一定逻辑将人圈选出来。
- 洞察，针对圈定的人群，了解人群分布、特点。
- 触达，利用例如短信、电话、声音、APP通知、IM等方式触达到用户，并配合流量控制。
- 效果分析，提升运营平台的完整性，有动作、有效果、有反馈。

Doris在这里面起到了最重要的作用，包括：标签存储、人群存储、效果分析。
标签分为基础标签和用户行为的基础数据，在此基础之上，我们可以灵活自定义其他标签。从实效性来看，标签还分为实时的标签和离线的标签。

### 2. CDP存储选型的考量点
我们从5个维度去考量CDP存储的选型。

**(1) 离线和实时统一
如前所述标签有离线标签，有实时标签。目前我们是准实时的场景。对于有些数据，准实时已足够满足我们的需求，大量的标签还是离线的标签，采用的方式就是Doris的Routine Load和Broker Load。

| **场景** | **需求** | **Apache Doris功能点** |
| --- | --- | --- |
| 实时标签 | 数据实时更新 | Routine Load |
| 离线标签 | 高效大批量导入 | Broker Load |
| 流批统一 | 实时历险数据存储统一 | Routine Load 和 Broker Load 更新同一张表的不同列 |

另外同一张表上，不同列更新的频率也是不一样的。例如用户的基础标签，我们对用户的身份需要实时的更新，因为用户的身份是时刻变化的。T+1的更新不能满足我们的需求。有些标签离线，例如用户的性别、年龄等基础标签，T+1更新足以满足我们的标准。基础用户的原子标签放在一张表中带来的维护成本很低。当后期自定义标签时，表的数量会大大减少，这样对于整体性能的提升有极大好处。

**(2) 高效圈选**

用户运营有了标签，第二步就是圈人，圈选就是根据标签的不同组合，把符合标签条件的所有人筛选出来，这时会有不同标签条件组合的查询、这个查询在Doris引入向量化之后有比较明显的提升。

| **场景** | **需求** | **Apache Doris功能点** |
| --- | --- | --- |
| 复杂条件圈选 | 高效的支持多条件圈选 | SIMD的优化 |

**(3) 高效聚合**

前面提到的用户洞察或群体洞察以及效果分析统计，需要对数据做统计分析，并不是单一的按用户ID获取标签的这种简单场景。其读取的数据量和查询效率，对我们这个标签的分布、群体的分布、效果分析的统计都有很大的影响。在这里，体现到的Doris的功能特点是：
- 第一是数据分片，我们按时间把数据分片，分析统计就会极大的减少数据量，可以极大的加速查询和分析的效率。
- 第二是节点聚合，然后再收集做统一的聚合。
- 第三是向量化加速，向量化引擎对性能提升非常显著。

| **场景** | **需求** | **Apache Doris功能点** |
| --- | --- | --- |
| 标签值的分布 | 每天都需要更新所有标签，需要快速高效统计  | 数据分片，减少数据传输和计算 |
| 群体的分布 | 同上 | 存算统一，每个节点先聚合 |
| 效果分析的统计值 | 同上 | SIMD提速  |

**(4) 多表关联**

我们的CDP可能和业内常见的CDP场景不太一样，因为有些场景的CDP标签是提前预估完成的，不存在自定义标签。只做原子标签，或者说用户基础行为数据的统计，这样可以把灵活性留给使用CDP的用户，根据自己的业务场景去自定义标签。底层的数据是分散在不同的数据库表里，如果做自定义的标签的建设，势必需要做表的关联。
我们选择Doris一个非常重要的原因，就是多表关联的能力。通过性能测试，Doris目前能够满足我们的要求。而且Doris为用户提供了非常强大的能力。因为标签是动态的。

| **场景** | **需求** | **Apache Doris功能点** |
| --- | --- | --- |
| 群体的特征分布 | 统计群体在某个特征下的分布 | 多表关联 |
| Single Tag | Display tags |  |

**(5) 联邦查询**

用户触达成功与否我们会记录到TiDB。用户运营中的通知，可能只影响用户体验，如果涉及到钱例如发放积分或优惠券，任务执行就要做到不重不漏，这种OLTP场景用TiDB比较合适。
做效果分析，需要了解运营计划执行到什么程度，是否达成目标，其分布情况等等。需要把任务执行情况和人群圈选相结合才能进行分析，就会用到Doris和TiDB的关联，外表关联进行查询。
我们设想标签体量比较小，保存到es可能比较合适，然而ES不能满足我们的需求，后面会解释其原因。

| **场景** | **需求** | **Apache Doris功能点** |
| --- | --- | --- |
| 效果分析关联任务执行明细 | Doris数据关联TiDB数据 | 关联外表进行查询 |
| 人群标签关联行为聚合数据 | Doris数据关联Elasticsearch数据 |

## 经验和总结

1. **bitmap**. 我们的体量无法充分发挥其效率。如果体量达到一定程度，用bitmap会有很好的性能提升。例如计算UV场景，Id全集大于5000万，可以考虑bitmap聚合。

2. **ES外表。单表查询下效率比较理想。** 

3. **分批更新列**. 为了减少表的数量和提升join表的性能，设计表尽量精简尽量聚合，相同类型的事实都放在一起。但相同类型的字段可能更新频率不同，有些字段需要天级更新，有些字段可能需要小时级更新，单独更新某一列就是一个明显的诉求。Doris聚合模型单独更新某些列的解决方案是使用REPLACE_IF_NOT_NULL。注意:用null替换原来的非null值是做不到的,可以把所有的null替换成有意义的默认值，例如unknown。

4. **在线服务**. Doris同一份数据同时服务在线离线场景，对资源隔离的要求比较高，目前还存在进一步优化的空间。
