(window.webpackJsonp=window.webpackJsonp||[]).push([[317],{885:function(t,e,a){"use strict";a.r(e);var s=a(33),n=Object(s.a)({},(function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"doris-on-es"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#doris-on-es"}},[t._v("#")]),t._v(" Doris On ES")]),t._v(" "),a("p",[t._v("Doris-On-ES将Doris的分布式查询规划能力和ES(Elasticsearch)的全文检索能力相结合，提供更完善的OLAP分析场景解决方案：")]),t._v(" "),a("ol",[a("li",[t._v("ES中的多index分布式Join查询")]),t._v(" "),a("li",[t._v("Doris和ES中的表联合查询，更复杂的全文检索过滤")]),t._v(" "),a("li",[t._v("ES keyword类型字段的聚合查询：适用于index 频繁发生变化、单个分片文档数量千万级以上且该字段基数(cardinality)非常大")])]),t._v(" "),a("p",[t._v("本文档主要介绍该功能的实现原理、使用方式等。")]),t._v(" "),a("h2",{attrs:{id:"名词解释"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#名词解释"}},[t._v("#")]),t._v(" 名词解释")]),t._v(" "),a("ul",[a("li",[t._v("FE：Frontend，Doris 的前端节点。负责元数据管理和请求接入。")]),t._v(" "),a("li",[t._v("BE：Backend，Doris 的后端节点。负责查询执行和数据存储。")]),t._v(" "),a("li",[t._v("Elasticsearch(ES)：目前最流行的开源分布式搜索引擎。")]),t._v(" "),a("li",[t._v("DataNode：ES的数据存储与计算节点。")]),t._v(" "),a("li",[t._v("MasterNode：ES的Master节点，管理元数据、节点、数据分布等。")]),t._v(" "),a("li",[t._v("scroll：ES内置的数据集游标特性，用来对数据进行流式扫描和过滤。")])]),t._v(" "),a("h2",{attrs:{id:"如何使用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#如何使用"}},[t._v("#")]),t._v(" 如何使用")]),t._v(" "),a("h3",{attrs:{id:"创建外表"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建外表"}},[t._v("#")]),t._v(" 创建外表")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('CREATE EXTERNAL TABLE `es_table` (\n  `id` bigint(20) COMMENT "",\n  `k1` bigint(20) COMMENT "",\n  `k2` datetime COMMENT "",\n  `k3` varchar(20) COMMENT "",\n  `k4` varchar(100) COMMENT "",\n  `k5` float COMMENT ""\n) ENGINE=ELASTICSEARCH\nPARTITION BY RANGE(`id`)\n()\nPROPERTIES (\n"host" = "http://192.168.0.1:8200,http://192.168.0.2:8200",\n"user" = "root",\n"password" = "root",\n"index" = "tindex”,\n"type" = "doc"\n);\n')])])]),a("p",[t._v("参数说明：")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("参数")]),t._v(" "),a("th",[t._v("说明")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("host")]),t._v(" "),a("td",[t._v("ES集群连接地址，可指定一个或多个，Doris通过这个地址获取到ES版本号、index的shard分布信息")])]),t._v(" "),a("tr",[a("td",[t._v("user")]),t._v(" "),a("td",[t._v("开启basic认证的ES集群的用户名，需要确保该用户有访问: /_cluster/state/_nodes/http等路径权限和对index的读权限")])]),t._v(" "),a("tr",[a("td",[t._v("password")]),t._v(" "),a("td",[t._v("对应用户的密码信息")])]),t._v(" "),a("tr",[a("td",[t._v("index")]),t._v(" "),a("td",[t._v("Doris中的表对应的ES的index名字，可以是alias")])]),t._v(" "),a("tr",[a("td",[t._v("type")]),t._v(" "),a("td",[t._v("指定index的type，默认是_doc")])]),t._v(" "),a("tr",[a("td",[t._v("transport")]),t._v(" "),a("td",[t._v("内部保留，默认为http")])])])]),t._v(" "),a("h3",{attrs:{id:"查询"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#查询"}},[t._v("#")]),t._v(" 查询")]),t._v(" "),a("h4",{attrs:{id:"基本条件过滤"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#基本条件过滤"}},[t._v("#")]),t._v(" 基本条件过滤")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("select * from es_table where k1 > 1000 and k3 ='term' or k4 like 'fu*z_'\n")])])]),a("h4",{attrs:{id:"扩展的esquery-sql语法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#扩展的esquery-sql语法"}},[t._v("#")]),t._v(" 扩展的esquery sql语法")]),t._v(" "),a("p",[t._v("通过"),a("code",[t._v("esquery")]),t._v("函数将一些无法用sql表述的ES query如match、geoshape等下推给ES进行过滤处理，"),a("code",[t._v("esquery")]),t._v("的第一个列名参数用于关联"),a("code",[t._v("index")]),t._v("，第二个参数是ES的基本"),a("code",[t._v("Query DSL")]),t._v("的json表述，使用花括号"),a("code",[t._v("{}")]),t._v("包含，json的"),a("code",[t._v("root key")]),t._v("有且只能有一个，如match、geo_shape、bool等")]),t._v(" "),a("p",[t._v("match查询：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('select * from es_table where esquery(k4, \'{\n        "match": {\n           "k4": "doris on elasticsearch"\n        }\n    }\');\n')])])]),a("p",[t._v("geo相关查询：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('select * from es_table where esquery(k4, \'{\n      "geo_shape": {\n         "location": {\n            "shape": {\n               "type": "envelope",\n               "coordinates": [\n                  [\n                     13,\n                     53\n                  ],\n                  [\n                     14,\n                     52\n                  ]\n               ]\n            },\n            "relation": "within"\n         }\n      }\n   }\');\n')])])]),a("p",[t._v("bool查询：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('select * from es_table where esquery(k4, \' {\n         "bool": {\n            "must": [\n               {\n                  "terms": {\n                     "k1": [\n                        11,\n                        12\n                     ]\n                  }\n               },\n               {\n                  "terms": {\n                     "k2": [\n                        100\n                     ]\n                  }\n               }\n            ]\n         }\n      }\');\n')])])]),a("h2",{attrs:{id:"原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#原理"}},[t._v("#")]),t._v(" 原理")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("+----------------------------------------------+\n|                                              |\n| Doris      +------------------+              |\n|            |       FE         +--------------+-------+\n|            |                  |  Request Shard Location\n|            +--+-------------+-+              |       |\n|               ^             ^                |       |\n|               |             |                |       |\n|  +-------------------+ +------------------+  |       |\n|  |            |      | |    |             |  |       |\n|  | +----------+----+ | | +--+-----------+ |  |       |\n|  | |      BE       | | | |      BE      | |  |       |\n|  | +---------------+ | | +--------------+ |  |       |\n+----------------------------------------------+       |\n   |        |          | |        |         |          |\n   |        |          | |        |         |          |\n   |    HTTP SCROLL    | |    HTTP SCROLL   |          |\n+-----------+---------------------+------------+       |\n|  |        v          | |        v         |  |       |\n|  | +------+--------+ | | +------+-------+ |  |       |\n|  | |               | | | |              | |  |       |\n|  | |   DataNode    | | | |   DataNode   +<-----------+\n|  | |               | | | |              | |  |       |\n|  | |               +<--------------------------------+\n|  | +---------------+ | | |--------------| |  |       |\n|  +-------------------+ +------------------+  |       |\n|   Same Physical Node                         |       |\n|                                              |       |\n|           +-----------------------+          |       |\n|           |                       |          |       |\n|           |      MasterNode       +<-----------------+\n| ES        |                       |          |\n|           +-----------------------+          |\n+----------------------------------------------+\n\n\n")])])]),a("ol",[a("li",[a("p",[t._v("创建ES外表后，FE会请求建表指定的主机，获取所有节点的HTTP端口信息以及index的shard分布信息等，如果请求失败会顺序遍历host列表直至成功或完全失败")])]),t._v(" "),a("li",[a("p",[t._v("查询时，会根据FE得到的一些节点信息和index的元数据信息，生成查询计划并发给对应的BE节点")])]),t._v(" "),a("li",[a("p",[t._v("BE节点会根据"),a("code",[t._v("就近原则")]),t._v("即优先请求本地部署的ES节点，BE通过"),a("code",[t._v("HTTP Scroll")]),t._v("方式流式的从ES index的每个分片中并发的获取数据")])]),t._v(" "),a("li",[a("p",[t._v("计算完结果后，返回给client端")])])]),t._v(" "),a("h2",{attrs:{id:"push-down-operations"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#push-down-operations"}},[t._v("#")]),t._v(" Push-Down operations")]),t._v(" "),a("p",[a("code",[t._v("Doris On Elasticsearch")]),t._v("一个重要的功能就是过滤条件的下推: 过滤条件下推给ES，这样只有真正满足条件的数据才会被返回，能够显著的提高查询性能和降低Doris和Elasticsearch的CPU、memory、IO利用率")]),t._v(" "),a("p",[t._v("下面的操作符(Operators)会被优化成如下下推filters:")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("SQL syntax")]),t._v(" "),a("th",{staticStyle:{"text-align":"center"}},[t._v("ES 5.x+ syntax")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("=")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("term query")])]),t._v(" "),a("tr",[a("td",[t._v("in")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("terms query")])]),t._v(" "),a("tr",[a("td",[t._v("> , < , >= , ⇐")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("range")])]),t._v(" "),a("tr",[a("td",[t._v("and")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("bool.filter")])]),t._v(" "),a("tr",[a("td",[t._v("or")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("bool.should")])]),t._v(" "),a("tr",[a("td",[t._v("not")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("bool.must_not")])]),t._v(" "),a("tr",[a("td",[t._v("not in")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("bool.must_not + terms")])]),t._v(" "),a("tr",[a("td",[t._v("esquery")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("ES Query DSL")])])])]),t._v(" "),a("h2",{attrs:{id:"其他说明"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#其他说明"}},[t._v("#")]),t._v(" 其他说明")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("ES的版本要求")]),t._v(" "),a("p",[t._v("ES主版本大于5，ES在2.x之前和5.x之后数据的扫描方式不同，目前支持5.x之后的")])]),t._v(" "),a("li",[a("p",[t._v("是否支持X-Pack认证的ES集群")]),t._v(" "),a("p",[t._v("支持所有使用HTTP Basic认证方式的ES集群")])]),t._v(" "),a("li",[a("p",[t._v("一些查询比请求ES慢很多")]),t._v(" "),a("p",[t._v("是，比如_count相关的query等，ES内部会直接读取满足条件的文档个数相关的元数据，不需要对真实的数据进行过滤")])])])])}),[],!1,null,null,null);e.default=n.exports}}]);