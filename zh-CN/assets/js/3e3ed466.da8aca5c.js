"use strict";(self.webpackChunkdoris_website=self.webpackChunkdoris_website||[]).push([["177587"],{137151:function(e,s,a){a.r(s),a.d(s,{default:()=>b,frontMatter:()=>i,metadata:()=>n,assets:()=>c,toc:()=>o,contentTitle:()=>r});var n=JSON.parse('{"id":"lakehouse/best-practices/doris-aws-s3tables","title":"Doris \u96C6\u6210 AWS S3 Tables","description":"AWS S3 Tables \u662F\u4E00\u79CD\u7279\u6B8A\u7684 S3 Bucket \u7C7B\u578B\uFF0C\u5176\u5BF9\u5916\u63D0\u4F9B Apache Iceberg \u8868\u683C\u5F0F\u6807\u51C6\u7684\u8BFB\u5199\u63A5\u53E3\uFF0C\u5E95\u5C42\u4F9D\u6258 Amazon S3\uFF0C\u63D0\u4F9B\u548C S3 \u672C\u8EAB\u76F8\u540C\u7684\u6301\u4E45\u6027\u3001\u53EF\u7528\u6027\u3001\u53EF\u6269\u5C55\u6027\u548C\u6027\u80FD\u7279\u5F81\u3002\u6B64\u5916\uFF0CS3 Tables \u8FD8\u63D0\u4F9B\u4EE5\u4E0B\u7279\u6027\uFF1A","source":"@site/i18n/zh-CN/docusaurus-plugin-content-docs/current/lakehouse/best-practices/doris-aws-s3tables.md","sourceDirName":"lakehouse/best-practices","slug":"/lakehouse/best-practices/doris-aws-s3tables","permalink":"/zh-CN/docs/dev/lakehouse/best-practices/doris-aws-s3tables","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"title":"Doris \u96C6\u6210 AWS S3 Tables","language":"zh-CN"},"sidebar":"docs","previous":{"title":"\u4F7F\u7528 Doris \u548C Iceberg","permalink":"/zh-CN/docs/dev/lakehouse/best-practices/doris-iceberg"},"next":{"title":"Doris \u96C6\u6210\u963F\u91CC\u4E91 DLF Rest Catalog","permalink":"/zh-CN/docs/dev/lakehouse/best-practices/doris-dlf-paimon"}}'),t=a("785893"),l=a("250065");let i={title:"Doris \u96C6\u6210 AWS S3 Tables",language:"zh-CN"},r=void 0,c={},o=[{value:"\u4F7F\u7528\u6307\u5357",id:"\u4F7F\u7528\u6307\u5357",level:2},{value:"01 \u521B\u5EFA S3 Table Bucket",id:"01-\u521B\u5EFA-s3-table-bucket",level:3},{value:"02 \u521B\u5EFA Iceberg Catalog",id:"02-\u521B\u5EFA-iceberg-catalog",level:3},{value:"03 \u8BBF\u95EE S3Tables",id:"03-\u8BBF\u95EE-s3tables",level:3},{value:"04 \u521B\u5EFA S3Tables \u8868\u5E76\u5199\u5165\u6570\u636E",id:"04-\u521B\u5EFA-s3tables-\u8868\u5E76\u5199\u5165\u6570\u636E",level:3},{value:"05 Time Travel",id:"05-time-travel",level:3},{value:"06 \u4F7F\u7528 EMR Spark \u8BBF\u95EE S3 Tables",id:"06-\u4F7F\u7528-emr-spark-\u8BBF\u95EE-s3-tables",level:3}];function d(e){let s={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,l.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.a,{href:"https://aws.amazon.com/s3/features/tables/",children:"AWS S3 Tables"})," \u662F\u4E00\u79CD\u7279\u6B8A\u7684 S3 Bucket \u7C7B\u578B\uFF0C\u5176\u5BF9\u5916\u63D0\u4F9B Apache Iceberg \u8868\u683C\u5F0F\u6807\u51C6\u7684\u8BFB\u5199\u63A5\u53E3\uFF0C\u5E95\u5C42\u4F9D\u6258 Amazon S3\uFF0C\u63D0\u4F9B\u548C S3 \u672C\u8EAB\u76F8\u540C\u7684\u6301\u4E45\u6027\u3001\u53EF\u7528\u6027\u3001\u53EF\u6269\u5C55\u6027\u548C\u6027\u80FD\u7279\u5F81\u3002\u6B64\u5916\uFF0CS3 Tables \u8FD8\u63D0\u4F9B\u4EE5\u4E0B\u7279\u6027\uFF1A"]}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:"\u4E0E\u5B58\u50A8\u5728\u666E\u901A S3 Buckets \u4E2D\u7684 Iceberg \u8868\u683C\u5F0F\u76F8\u6BD4\uFF0CS3 Tables \u7684\u67E5\u8BE2\u6027\u80FD\u6700\u591A\u53EF\u9AD8 3 \u500D\uFF0C\u6BCF\u79D2\u4E8B\u52A1\u6570\u6700\u591A\u53EF\u9AD8 10 \u500D\u3002"}),"\n",(0,t.jsx)(s.li,{children:"\u81EA\u52A8\u5316\u7684\u8868\u683C\u7BA1\u7406\u3002S3 Tables \u4F1A\u81EA\u52A8\u56DE Iceberg \u8868\u6570\u636E\u8FDB\u884C\u4F18\u5316\uFF0C\u5305\u62EC\u5C0F\u6587\u4EF6\u5408\u5E76\u3001\u5FEB\u7167\u7BA1\u7406\u3001\u5783\u573E\u6587\u4EF6\u6E05\u7406\u7B49\u3002"}),"\n"]}),"\n",(0,t.jsx)(s.p,{children:"S3 Tables \u7684\u53D1\u5E03\uFF0C\u8FDB\u4E00\u6B65\u7B80\u5316 Lakehouse \u7684\u67B6\u6784\uFF0C\u5E76\u4E3A\u4E91\u539F\u751F\u7684\u6E56\u4ED3\u7CFB\u7EDF\u5E26\u6765\u66F4\u591A\u60F3\u8C61\u7A7A\u95F4\u3002\u5305\u62EC\u51B7\u70ED\u5206\u79BB\u3001\u6570\u636E\u5F52\u6863\u3001\u6570\u636E\u5907\u4EFD\u3001\u5B58\u7B97\u5206\u79BB\u67B6\u6784\uFF0C\u90FD\u53EF\u80FD\u57FA\u4E8E S3 Tables \u6F14\u5316\u51FA\u5168\u65B0\u7684\u67B6\u6784\u3002"}),"\n",(0,t.jsx)(s.p,{children:"\u5F97\u76CA\u4E8E Amazon S3 Tables \u5BF9 Iceberg API \u7684\u9AD8\u5EA6\u517C\u5BB9\uFF0CApache Doris \u53EF\u4EE5\u548C S3 Tables \u8FDB\u884C\u5FEB\u901F\u5BF9\u63A5\u3002\u672C\u6587\u5C06\u6F14\u793A\u5982\u4F55\u4F7F\u7528 Apache Doris \u5BF9\u63A5 S3 Tables \u5E76\u8FDB\u884C\u6570\u636E\u5206\u6790\u52A0\u5DE5\u3002"}),"\n",(0,t.jsx)(s.admonition,{type:"tip",children:(0,t.jsx)(s.p,{children:"\u8BE5\u529F\u80FD\u4ECE Doris 3.1 \u5F00\u59CB\u652F\u6301"})}),"\n",(0,t.jsx)(s.h2,{id:"\u4F7F\u7528\u6307\u5357",children:"\u4F7F\u7528\u6307\u5357"}),"\n",(0,t.jsx)(s.h3,{id:"01-\u521B\u5EFA-s3-table-bucket",children:"01 \u521B\u5EFA S3 Table Bucket"}),"\n",(0,t.jsx)(s.p,{children:"S3 Table Bucket \u662F S3 \u63A8\u51FA\u7684\u7B2C\u4E09\u79CD Bucket \u7C7B\u578B\uFF0C\u548C\u4E4B\u524D\u7684 General purpose bucket \u4EE5\u53CA Directory bucket \u5E73\u7EA7\u3002"}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.img,{alt:"AWS S3 Table Bucket",src:a(929807).Z+"",width:"490",height:"600"})}),"\n",(0,t.jsx)(s.p,{children:"\u8FD9\u91CC\u6211\u4EEC\u521B\u5EFA\u4E00\u4E2A\u540D\u4E3A doris-s3-table-bucket \u7684 Table Bucket\u3002\u521B\u5EFA\u540E\u6211\u4EEC\u5C06\u5F97\u5230\u4E00\u4E2A ARN \u8868\u793A\u7684 Table Bucket"}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.img,{alt:"AWS S3 Table Bucket Create",src:a(569416).Z+"",width:"1280",height:"129"})}),"\n",(0,t.jsx)(s.h3,{id:"02-\u521B\u5EFA-iceberg-catalog",children:"02 \u521B\u5EFA Iceberg Catalog"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:["\u521B\u5EFA\u4E00\u4E2A ",(0,t.jsx)(s.code,{children:"s3tables"})," \u7C7B\u578B\u7684 Iceberg Catalog"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-sql",children:"CREATE CATALOG iceberg_s3 PROPERTIES (\n    'type' = 'iceberg',\n    'iceberg.catalog.type' = 's3tables',\n    'warehouse' = 'arn:aws:s3tables:<region>:<acount_id>:bucket/<s3_table_bucket_name>',\n    's3.region' = '<region>',\n    's3.endpoint' = 's3.<region>.amazonaws.com',\n    's3.access_key' = '<ak>',\n    's3.secret_key' = '<sk>'\n);\n"})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:["\u901A\u8FC7 Glue Rest Catalog \u8FDE\u63A5 ",(0,t.jsx)(s.code,{children:"s3 tables"})]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-sql",children:"CREATE CATALOG glue_s3 PROPERTIES (\n    'type' = 'iceberg',\n    'iceberg.catalog.type' = 'rest',\n    'iceberg.rest.uri' = 'https://glue.<region>.amazonaws.com/iceberg',\n    'warehouse' = '<acount_id>:s3tablescatalog/<s3_table_bucket_name>',\n    'iceberg.rest.sigv4-enabled' = 'true',\n    'iceberg.rest.signing-name' = 'glue',\n    'iceberg.rest.access-key-id' = '<ak>',\n    'iceberg.rest.secret-access-key' = '<sk>',\n    'iceberg.rest.signing-region' = '<region>'\n);\n"})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(s.h3,{id:"03-\u8BBF\u95EE-s3tables",children:"03 \u8BBF\u95EE S3Tables"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-sql",children:"Doris > SWITCH iceberg_s3;\n\nDoris > SHOW DATABASES;\n+--------------------+\n| Database           |\n+--------------------+\n| information_schema |\n| my_namespace       |\n| mysql              |\n+--------------------+\n\nDoris > USE my_namespace;\n\nDoris > SHOW TABLES;\n+------------------------+\n| Tables_in_my_namespace |\n+------------------------+\n| my_table               |\n+------------------------+\n\nDoris > SELECT * FROM my_table;\n+------+------+-------+\n| id   | name | value |\n+------+------+-------+\n|    1 | ABC  |   100 |\n|    2 | XYZ  |   200 |\n+------+------+-------+\n"})}),"\n",(0,t.jsx)(s.h3,{id:"04-\u521B\u5EFA-s3tables-\u8868\u5E76\u5199\u5165\u6570\u636E",children:"04 \u521B\u5EFA S3Tables \u8868\u5E76\u5199\u5165\u6570\u636E"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-sql",children:"Doris > CREATE TABLE partition_table (\n    ->   `ts` DATETIME COMMENT 'ts',\n    ->   `id` INT COMMENT 'col1',\n    ->   `pt1` STRING COMMENT 'pt1',\n    ->   `pt2` STRING COMMENT 'pt2'\n    -> )\n    -> PARTITION BY LIST (day(ts), pt1, pt2) ();\n\nDoris > INSERT INTO partition_table VALUES\n    -> (\"2024-01-01 08:00:00\", 1000, \"us-east\", \"PART1\"),\n    -> (\"2024-01-02 10:00:00\", 1002, \"us-sout\", \"PART2\");\nQuery OK, 2 rows affected\n{'status':'COMMITTED', 'txnId':'1736935786473'}\n\nDoris > SELECT * FROM partition_table;\n+----------------------------+------+---------+-------+\n| ts                         | id   | pt1     | pt2   |\n+----------------------------+------+---------+-------+\n| 2024-01-02 10:00:00.000000 | 1002 | us-sout | PART2 |\n| 2024-01-01 08:00:00.000000 | 1000 | us-east | PART1 |\n+----------------------------+------+---------+-------+\n"})}),"\n",(0,t.jsx)(s.h3,{id:"05-time-travel",children:"05 Time Travel"}),"\n",(0,t.jsxs)(s.p,{children:["\u6211\u4EEC\u53EF\u4EE5\u518D\u63D2\u5165\u4E00\u6279\u6570\u636E\uFF0C\u7136\u540E\u4F7F\u7528 ",(0,t.jsx)(s.code,{children:"$snapshots"})," \u7CFB\u7EDF\u8868\u67E5\u770B Iceberg \u7684 Snapshots\uFF1A"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-sql",children:'Doris > INSERT INTO partition_table VALUES\n    -> ("2024-01-03 08:00:00", 1000, "us-east", "PART1"),\n    -> ("2024-01-04 10:00:00", 1002, "us-sout", "PART2");\nQuery OK, 2 rows affected (9.76 sec)\n{\'status\':\'COMMITTED\', \'txnId\':\'1736935786474\'}\n'})}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{children:'Doris > SELECT * FROM partition_table$snapshots\\G\n*************************** 1. row ***************************\n committed_at: 2025-01-15 23:27:01\n  snapshot_id: 6834769222601914216\n    parent_id: -1\n    operation: append\nmanifest_list: s3://80afcb3f-6edf-46f2-7fhehwj6cengfwc7n6iz7ipzakd7quse1b--table-s3/metadata/snap-6834769222601914216-1-a6b2230d-fc0d-4c1d-8f20-94bb798f27b1.avro\n      summary: {"added-data-files":"2","added-records":"2","added-files-size":"5152","changed-partition-count":"2","total-records":"2","total-files-size":"5152","total-data-files":"2","total-delete-files":"0","total-position-deletes":"0","total-equality-deletes":"0","iceberg-version":"Apache Iceberg 1.6.1 (commit 8e9d59d299be42b0bca9461457cd1e95dbaad086)"}\n*************************** 2. row ***************************\n committed_at: 2025-01-15 23:30:00\n  snapshot_id: 5670090782912867298\n    parent_id: 6834769222601914216\n    operation: append\nmanifest_list: s3://80afcb3f-6edf-46f2-7fhehwj6cengfwc7n6iz7ipzakd7quse1b--table-s3/metadata/snap-5670090782912867298-1-beeed339-be96-4710-858b-f39bb01cc3ff.avro\n      summary: {"added-data-files":"2","added-records":"2","added-files-size":"5152","changed-partition-count":"2","total-records":"4","total-files-size":"10304","total-data-files":"4","total-delete-files":"0","total-position-deletes":"0","total-equality-deletes":"0","iceberg-version":"Apache Iceberg 1.6.1 (commit 8e9d59d299be42b0bca9461457cd1e95dbaad086)"}\n'})}),"\n",(0,t.jsxs)(s.p,{children:["\u4F7F\u7528 ",(0,t.jsx)(s.code,{children:"VERSION AS OF"})," \u8BED\u6CD5\u67E5\u8BE2\u4E0D\u540C\u7684\u5FEB\u7167\uFF1A"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-sql",children:"Doris > SELECT * FROM partition_table FOR VERSION AS OF 5670090782912867298;\n+----------------------------+------+---------+-------+\n| ts                         | id   | pt1     | pt2   |\n+----------------------------+------+---------+-------+\n| 2024-01-04 10:00:00.000000 | 1002 | us-sout | PART2 |\n| 2024-01-03 08:00:00.000000 | 1000 | us-east | PART1 |\n| 2024-01-01 08:00:00.000000 | 1000 | us-east | PART1 |\n| 2024-01-02 10:00:00.000000 | 1002 | us-sout | PART2 |\n+----------------------------+------+---------+-------+\n\nDoris > SELECT * FROM partition_table FOR VERSION AS OF 6834769222601914216;\n+----------------------------+------+---------+-------+\n| ts                         | id   | pt1     | pt2   |\n+----------------------------+------+---------+-------+\n| 2024-01-02 10:00:00.000000 | 1002 | us-sout | PART2 |\n| 2024-01-01 08:00:00.000000 | 1000 | us-east | PART1 |\n+----------------------------+------+---------+-------+\n"})}),"\n",(0,t.jsx)(s.h3,{id:"06-\u4F7F\u7528-emr-spark-\u8BBF\u95EE-s3-tables",children:"06 \u4F7F\u7528 EMR Spark \u8BBF\u95EE S3 Tables"}),"\n",(0,t.jsx)(s.p,{children:"\u4F7F\u7528 Doris \u5199\u5165\u7684\u6570\u636E\uFF0C\u4E5F\u53EF\u4EE5\u4F7F\u7528 Spark \u8FDB\u884C\u8BBF\u95EE\uFF1A"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-shell",children:"spark-shell --jars /usr/share/aws/iceberg/lib//iceberg-spark-runtime-3.5_2.12-1.6.1-amzn-1.jar \\\n--packages software.amazon.s3tables:s3-tables-catalog-for-iceberg-runtime:0.1.3 \\\n--conf spark.sql.catalog.s3tablesbucket=org.apache.iceberg.spark.SparkCatalog \\\n--conf spark.sql.catalog.s3tablesbucket.catalog-impl=software.amazon.s3tables.iceberg.S3TablesCatalog \\\n--conf spark.sql.catalog.s3tablesbucket.warehouse=arn:aws:s3tables:us-east-1:169698000000:bucket/doris-s3-table-bucket \\\n--conf spark.sql.defaultCatalog=s3tablesbucket \\\n--conf spark.sql.extensions=org.apache.iceberg.spark.extensions.IcebergSparkSessionExtensions\n"})}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-sql",children:'scala> spark.sql("SELECT * FROM s3tablesbucket.my_namespace.`partition_table` ").show()\n+-------------------+----+-------+-----+\n|                 ts|  id|    pt1|  pt2|\n+-------------------+----+-------+-----+\n|2024-01-02 10:00:00|1002|us-sout|PART2|\n|2024-01-01 08:00:00|1000|us-east|PART1|\n|2024-01-04 10:00:00|1002|us-sout|PART2|\n|2024-01-03 08:00:00|1000|us-east|PART1|\n+-------------------+----+-------+-----+\n'})})]})}function b(e={}){let{wrapper:s}={...(0,l.a)(),...e.components};return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},569416:function(e,s,a){a.d(s,{Z:function(){return n}});let n=a.p+"assets/images/s3-table-bucket-create-5981f616619e698458f9642f57a4af5d.png"},929807:function(e,s,a){a.d(s,{Z:function(){return n}});let n=a.p+"assets/images/s3-table-bucket-cd361f28553b89a7a8dddb6c244c0fb6.png"},250065:function(e,s,a){a.d(s,{Z:function(){return r},a:function(){return i}});var n=a(667294);let t={},l=n.createContext(t);function i(e){let s=n.useContext(l);return n.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function r(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),n.createElement(l.Provider,{value:s},e.children)}}}]);