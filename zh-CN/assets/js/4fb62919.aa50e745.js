"use strict";(self.webpackChunkdoris_website=self.webpackChunkdoris_website||[]).push([["131440"],{326278:function(n,e,i){i.r(e),i.d(e,{default:()=>m,frontMatter:()=>a,metadata:()=>t,assets:()=>l,toc:()=>c,contentTitle:()=>o});var t=JSON.parse('{"id":"admin-manual/audit-plugin","title":"\u5BA1\u8BA1\u65E5\u5FD7\u63D2\u4EF6","description":"Doris \u7684\u5BA1\u8BA1\u65E5\u5FD7\u63D2\u4EF6\u662F\u5728 FE \u7684\u63D2\u4EF6\u6846\u67B6\u57FA\u7840\u4E0A\u5F00\u53D1\u7684\u3002\u662F\u4E00\u4E2A\u53EF\u9009\u63D2\u4EF6\u3002\u7528\u6237\u53EF\u4EE5\u5728\u8FD0\u884C\u65F6\u5B89\u88C5\u6216\u5378\u8F7D\u8FD9\u4E2A\u63D2\u4EF6\u3002","source":"@site/i18n/zh-CN/docusaurus-plugin-content-docs/version-2.0/admin-manual/audit-plugin.md","sourceDirName":"admin-manual","slug":"/admin-manual/audit-plugin","permalink":"/zh-CN/docs/2.0/admin-manual/audit-plugin","draft":false,"unlisted":false,"tags":[],"version":"2.0","frontMatter":{"title":"\u5BA1\u8BA1\u65E5\u5FD7\u63D2\u4EF6","language":"zh-CN"},"sidebar":"docs","previous":{"title":"\u7528\u6237\u914D\u7F6E\u9879","permalink":"/zh-CN/docs/2.0/admin-manual/config/user-property"},"next":{"title":"Config Action","permalink":"/zh-CN/docs/2.0/admin-manual/fe/config-action"}}'),r=i("785893"),s=i("250065");let a={title:"\u5BA1\u8BA1\u65E5\u5FD7\u63D2\u4EF6",language:"zh-CN"},o=void 0,l={},c=[{value:"\u7F16\u8BD1\u3001\u914D\u7F6E\u548C\u90E8\u7F72",id:"\u7F16\u8BD1\u914D\u7F6E\u548C\u90E8\u7F72",level:2},{value:"FE \u914D\u7F6E",id:"fe-\u914D\u7F6E",level:3},{value:"AuditLoader \u914D\u7F6E",id:"auditloader-\u914D\u7F6E",level:3},{value:"\u521B\u5EFA\u5E93\u8868",id:"\u521B\u5EFA\u5E93\u8868",level:3},{value:"\u90E8\u7F72",id:"\u90E8\u7F72",level:3},{value:"\u5B89\u88C5",id:"\u5B89\u88C5",level:3}];function d(n){let e={a:"a",admonition:"admonition",br:"br",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,s.a)(),...n.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.p,{children:"Doris \u7684\u5BA1\u8BA1\u65E5\u5FD7\u63D2\u4EF6\u662F\u5728 FE \u7684\u63D2\u4EF6\u6846\u67B6\u57FA\u7840\u4E0A\u5F00\u53D1\u7684\u3002\u662F\u4E00\u4E2A\u53EF\u9009\u63D2\u4EF6\u3002\u7528\u6237\u53EF\u4EE5\u5728\u8FD0\u884C\u65F6\u5B89\u88C5\u6216\u5378\u8F7D\u8FD9\u4E2A\u63D2\u4EF6\u3002"}),"\n",(0,r.jsx)(e.p,{children:"\u8BE5\u63D2\u4EF6\u53EF\u4EE5\u5C06 FE \u7684\u5BA1\u8BA1\u65E5\u5FD7\u5B9A\u671F\u7684\u5BFC\u5165\u5230\u6307\u5B9A Doris \u96C6\u7FA4\u4E2D\uFF0C\u4EE5\u65B9\u4FBF\u7528\u6237\u901A\u8FC7 SQL \u5BF9\u5BA1\u8BA1\u65E5\u5FD7\u8FDB\u884C\u67E5\u770B\u548C\u5206\u6790\u3002"}),"\n",(0,r.jsx)(e.h2,{id:"\u7F16\u8BD1\u914D\u7F6E\u548C\u90E8\u7F72",children:"\u7F16\u8BD1\u3001\u914D\u7F6E\u548C\u90E8\u7F72"}),"\n",(0,r.jsx)(e.h3,{id:"fe-\u914D\u7F6E",children:"FE \u914D\u7F6E"}),"\n",(0,r.jsxs)(e.p,{children:["\u5BA1\u8BA1\u65E5\u5FD7\u63D2\u4EF6\u6846\u67B6\u5728 Doris \u4E2D\u662F\u9ED8\u8BA4\u5F00\u542F\u7684\u7684\uFF0C\u7531 FE \u7684\u914D\u7F6E ",(0,r.jsx)(e.code,{children:"plugin_enable"})," \u63A7\u5236"]}),"\n",(0,r.jsx)(e.h3,{id:"auditloader-\u914D\u7F6E",children:"AuditLoader \u914D\u7F6E"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u4E0B\u8F7D Audit Loader \u63D2\u4EF6"}),"\n",(0,r.jsxs)(e.p,{children:["Audit Loader \u63D2\u4EF6\u5728 Doris \u7684\u53D1\u884C\u7248\u4E2D\u9ED8\u8BA4\u63D0\u4F9B\uFF0C\u901A\u8FC7 ",(0,r.jsx)(e.a,{href:"https://doris.apache.org/zh-CN/download",children:"DOWNLOAD"})," \u4E0B\u8F7D Doris \u5B89\u88C5\u5305\u89E3\u538B\u5E76\u8FDB\u5165\u76EE\u5F55\u540E\u5373\u53EF\u5728 extensions/audit_loader \u5B50\u76EE\u5F55\u4E0B\u627E\u5230 auditloader.zip \u6587\u4EF6\u3002"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u89E3\u538B\u5B89\u88C5\u5305"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-shell",children:"unzip auditloader.zip\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u89E3\u538B\u751F\u6210\u4EE5\u4E0B\u6587\u4EF6\uFF1A"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"auditloader.jar\uFF1A\u63D2\u4EF6\u4EE3\u7801\u5305\u3002"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"plugin.properties\uFF1A\u63D2\u4EF6\u5C5E\u6027\u6587\u4EF6\u3002"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"plugin.conf\uFF1A\u63D2\u4EF6\u914D\u7F6E\u6587\u4EF6\u3002"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:["\u60A8\u53EF\u4EE5\u5C06\u8FD9\u4E2A\u6587\u4EF6\u653E\u7F6E\u5728\u4E00\u4E2A http \u670D\u52A1\u5668\u4E0A\uFF0C\u6216\u8005\u62F7\u8D1D",(0,r.jsx)(e.code,{children:"auditloader.zip"}),"(\u6216\u8005\u89E3\u538B",(0,r.jsx)(e.code,{children:"auditloader.zip"}),") \u5230\u6240\u6709 FE \u7684\u6307\u5B9A\u76EE\u5F55\u4E0B\u3002\u8FD9\u91CC\u6211\u4EEC\u4F7F\u7528\u540E\u8005\u3002",(0,r.jsx)(e.br,{}),"\n\u8BE5\u63D2\u4EF6\u7684\u5B89\u88C5\u53EF\u4EE5\u53C2\u9605 ",(0,r.jsx)(e.a,{href:"/zh-CN/docs/2.0/sql-manual/sql-reference/Database-Administration-Statements/INSTALL-PLUGIN",children:"INSTALL"}),(0,r.jsx)(e.br,{}),"\n\u6267\u884C install \u540E\u4F1A\u81EA\u52A8\u751F\u6210 AuditLoader \u76EE\u5F55"]}),"\n",(0,r.jsxs)(e.ol,{start:"3",children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u4FEE\u6539 plugin.conf"}),"\n",(0,r.jsx)(e.p,{children:"\u4EE5\u4E0B\u914D\u7F6E\u53EF\u4F9B\u4FEE\u6539\uFF1A"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"frontend_host_port\uFF1AFE \u8282\u70B9 IP \u5730\u5740\u548C HTTP \u7AEF\u53E3\uFF0C\u683C\u5F0F\u4E3A <fe_ip>:<fe_http_port>\u3002\u9ED8\u8BA4\u503C\u4E3A 127.0.0.1:8030\u3002"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"database\uFF1A\u5BA1\u8BA1\u65E5\u5FD7\u5E93\u540D\u3002"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"audit_log_table\uFF1A\u5BA1\u8BA1\u65E5\u5FD7\u8868\u540D\u3002"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"slow_log_table\uFF1A\u6162\u67E5\u8BE2\u65E5\u5FD7\u8868\u540D\u3002"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"enable_slow_log\uFF1A\u662F\u5426\u5F00\u542F\u6162\u67E5\u8BE2\u65E5\u5FD7\u5BFC\u5165\u529F\u80FD\u3002\u9ED8\u8BA4\u503C\u4E3A false\u3002"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"user\uFF1A\u96C6\u7FA4\u7528\u6237\u540D\u3002\u8BE5\u7528\u6237\u5FC5\u987B\u5177\u6709\u5BF9\u5E94\u8868\u7684 INSERT \u6743\u9650\u3002"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"password\uFF1A\u96C6\u7FA4\u7528\u6237\u5BC6\u7801\u3002"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u91CD\u65B0\u6253\u5305 Audit Loader \u63D2\u4EF6"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-shell",children:"zip -r -q -m auditloader.zip auditloader.jar plugin.properties plugin.conf\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.h3,{id:"\u521B\u5EFA\u5E93\u8868",children:"\u521B\u5EFA\u5E93\u8868"}),"\n",(0,r.jsx)(e.p,{children:"\u5728 Doris \u4E2D\uFF0C\u9700\u8981\u521B\u5EFA\u5BA1\u8BA1\u65E5\u5FD7\u7684\u5E93\u548C\u8868\uFF0C\u8868\u7ED3\u6784\u5982\u4E0B\uFF1A"}),"\n",(0,r.jsxs)(e.p,{children:["\u82E5\u9700\u5F00\u542F\u6162\u67E5\u8BE2\u65E5\u5FD7\u5BFC\u5165\u529F\u80FD\uFF0C\u8FD8\u9700\u8981\u989D\u5916\u521B\u5EFA\u6162\u8868 ",(0,r.jsx)(e.code,{children:"doris_slow_log_tbl__"}),"\uFF0C\u5176\u8868\u7ED3\u6784\u4E0E ",(0,r.jsx)(e.code,{children:"doris_audit_log_tbl__"})," \u4E00\u81F4\u3002"]}),"\n",(0,r.jsxs)(e.p,{children:["\u5176\u4E2D ",(0,r.jsx)(e.code,{children:"dynamic_partition"})," \u5C5E\u6027\u6839\u636E\u81EA\u5DF1\u7684\u9700\u8981\uFF0C\u9009\u62E9\u5BA1\u8BA1\u65E5\u5FD7\u4FDD\u7559\u7684\u5929\u6570\u3002"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-sql",children:'create database doris_audit_db__;\n\ncreate table doris_audit_db__.doris_audit_log_tbl__\n(\n    query_id varchar(48) comment "Unique query id",\n    `time` datetime not null comment "Query start time",\n    client_ip varchar(32) comment "Client IP",\n    user varchar(64) comment "User name",\n    catalog varchar(128) comment "Catalog of this query",\n    db varchar(96) comment "Database of this query",\n    state varchar(8) comment "Query result state. EOF, ERR, OK",\n    error_code int comment "Error code of failing query.",\n    error_message string comment "Error message of failing query.",\n    query_time bigint comment "Query execution time in millisecond",\n    scan_bytes bigint comment "Total scan bytes of this query",\n    scan_rows bigint comment "Total scan rows of this query",\n    return_rows bigint comment "Returned rows of this query",\n    stmt_id int comment "An incremental id of statement",\n    is_query tinyint comment "Is this statemt a query. 1 or 0",\n    frontend_ip varchar(32) comment "Frontend ip of executing this statement",\n    cpu_time_ms bigint comment "Total scan cpu time in millisecond of this query",\n    sql_hash varchar(48) comment "Hash value for this query",\n    sql_digest varchar(48) comment "Sql digest for this query",\n    peak_memory_bytes bigint comment "Peak memory bytes used on all backends of this query",\n    stmt string comment "The original statement, trimed if longer than 2G"\n) engine=OLAP\nduplicate key(query_id, `time`, client_ip)\npartition by range(`time`) ()\ndistributed by hash(query_id) buckets 1\nproperties(\n    "dynamic_partition.time_unit" = "DAY",\n    "dynamic_partition.start" = "-30",\n    "dynamic_partition.end" = "3",\n    "dynamic_partition.prefix" = "p",\n    "dynamic_partition.buckets" = "1",\n    "dynamic_partition.enable" = "true",\n    "replication_num" = "3"\n);\n\ncreate table doris_audit_db__.doris_slow_log_tbl__\n(\n    query_id varchar(48) comment "Unique query id",\n    `time` datetime not null comment "Query start time",\n    client_ip varchar(32) comment "Client IP",\n    user varchar(64) comment "User name",\n    catalog varchar(128) comment "Catalog of this query",\n    db varchar(96) comment "Database of this query",\n    state varchar(8) comment "Query result state. EOF, ERR, OK",\n    error_code int comment "Error code of failing query.",\n    error_message string comment "Error message of failing query.",\n    query_time bigint comment "Query execution time in millisecond",\n    scan_bytes bigint comment "Total scan bytes of this query",\n    scan_rows bigint comment "Total scan rows of this query",\n    return_rows bigint comment "Returned rows of this query",\n    stmt_id int comment "An incremental id of statement",\n    is_query tinyint comment "Is this statemt a query. 1 or 0",\n    frontend_ip varchar(32) comment "Frontend ip of executing this statement",\n    cpu_time_ms bigint comment "Total scan cpu time in millisecond of this query",\n    sql_hash varchar(48) comment "Hash value for this query",\n    sql_digest varchar(48) comment "Sql digest for this query",\n    peak_memory_bytes bigint comment "Peak memory bytes used on all backends of this query",\n    stmt string comment "The original statement, trimed if longer than 2G "\n) engine=OLAP\nduplicate key(query_id, `time`, client_ip)\npartition by range(`time`) ()\ndistributed by hash(query_id) buckets 1\nproperties(\n    "dynamic_partition.time_unit" = "DAY",\n    "dynamic_partition.start" = "-30",\n    "dynamic_partition.end" = "3",\n    "dynamic_partition.prefix" = "p",\n    "dynamic_partition.buckets" = "1",\n    "dynamic_partition.enable" = "true",\n    "replication_num" = "3"\n);\n'})}),"\n",(0,r.jsx)(e.admonition,{type:"caution",children:(0,r.jsx)(e.p,{children:"\u4E0A\u9762\u8868\u7ED3\u6784\u4E2D\uFF1Astmt string\uFF0C\u8FD9\u4E2A\u53EA\u80FD\u5728 0.15 \u53CA\u4E4B\u540E\u7248\u672C\u4E2D\u4F7F\u7528\uFF0C\u4E4B\u524D\u7248\u672C\uFF0C\u5B57\u6BB5\u7C7B\u578B\u4F7F\u7528 varchar"})}),"\n",(0,r.jsx)(e.h3,{id:"\u90E8\u7F72",children:"\u90E8\u7F72"}),"\n",(0,r.jsxs)(e.p,{children:["\u60A8\u53EF\u4EE5\u5C06 \u6253\u5305\u597D\u7684 auditloader.zip \u653E\u7F6E\u5728\u4E00\u4E2A http \u670D\u52A1\u5668\u4E0A\uFF0C\u6216\u8005\u62F7\u8D1D",(0,r.jsx)(e.code,{children:"auditloader.zip"})," \u5230\u6240\u6709 FE \u7684\u76F8\u540C\u6307\u5B9A\u76EE\u5F55\u4E0B\u3002"]}),"\n",(0,r.jsx)(e.h3,{id:"\u5B89\u88C5",children:"\u5B89\u88C5"}),"\n",(0,r.jsx)(e.p,{children:"\u901A\u8FC7\u4EE5\u4E0B\u8BED\u53E5\u5B89\u88C5 Audit Loader \u63D2\u4EF6\uFF1A"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-sql",children:'INSTALL PLUGIN FROM [source] [PROPERTIES ("key"="value", ...)]\n'})}),"\n",(0,r.jsxs)(e.p,{children:["\u8BE6\u7EC6\u547D\u4EE4\u53C2\u8003\uFF1A",(0,r.jsx)(e.a,{href:"/zh-CN/docs/2.0/sql-manual/sql-reference/Database-Administration-Statements/INSTALL-PLUGIN",children:"INSTALL"})]}),"\n",(0,r.jsxs)(e.p,{children:["\u5B89\u88C5\u6210\u529F\u540E\uFF0C\u53EF\u4EE5\u901A\u8FC7 ",(0,r.jsx)(e.code,{children:"SHOW PLUGINS"})," \u770B\u5230\u5DF2\u7ECF\u5B89\u88C5\u7684\u63D2\u4EF6\uFF0C\u5E76\u4E14\u72B6\u6001\u4E3A ",(0,r.jsx)(e.code,{children:"INSTALLED"}),"\u3002"]}),"\n",(0,r.jsx)(e.p,{children:"\u5B8C\u6210\u540E\uFF0C\u63D2\u4EF6\u4F1A\u4E0D\u65AD\u7684\u4EE5\u6307\u5B9A\u7684\u65F6\u95F4\u95F4\u9694\u5C06\u5BA1\u8BA1\u65E5\u5FD7\u63D2\u5165\u5230\u8FD9\u4E2A\u8868\u4E2D\u3002"})]})}function m(n={}){let{wrapper:e}={...(0,s.a)(),...n.components};return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(d,{...n})}):d(n)}},250065:function(n,e,i){i.d(e,{Z:function(){return o},a:function(){return a}});var t=i(667294);let r={},s=t.createContext(r);function a(n){let e=t.useContext(s);return t.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function o(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(r):n.components||r:a(n.components),t.createElement(s.Provider,{value:e},n.children)}}}]);