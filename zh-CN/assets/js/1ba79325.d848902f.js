"use strict";(self.webpackChunkdoris_website=self.webpackChunkdoris_website||[]).push([["42486"],{545382:function(e,n,i){i.r(n),i.d(n,{default:()=>p,frontMatter:()=>s,metadata:()=>t,assets:()=>d,toc:()=>c,contentTitle:()=>o});var t=JSON.parse('{"id":"query-acceleration/optimization-technology-principle/topn-optimization","title":"TOPN \u67E5\u8BE2\u4F18\u5316","description":"TOPN \u67E5\u8BE2\u662F\u6307\u4E0B\u9762\u8FD9\u79CD ORDER BY LIMIT \u67E5\u8BE2\uFF0C\u5728\u65E5\u5FD7\u68C0\u7D22\u7B49\u660E\u7EC6\u67E5\u8BE2\u573A\u666F\u4E2D\u5F88\u5E38\u89C1\uFF0CDoris \u4F1A\u81EA\u52A8\u5BF9\u8FD9\u79CD\u7C7B\u578B\u7684\u67E5\u8BE2\u8FDB\u884C\u4F18\u5316\u3002","source":"@site/i18n/zh-CN/docusaurus-plugin-content-docs/current/query-acceleration/optimization-technology-principle/topn-optimization.md","sourceDirName":"query-acceleration/optimization-technology-principle","slug":"/query-acceleration/optimization-technology-principle/topn-optimization","permalink":"/zh-CN/docs/dev/query-acceleration/optimization-technology-principle/topn-optimization","draft":false,"unlisted":false,"tags":[],"version":"current","lastUpdatedAt":1770477659000,"frontMatter":{"title":"TOPN \u67E5\u8BE2\u4F18\u5316","language":"zh-CN","description":"TOPN \u67E5\u8BE2\u662F\u6307\u4E0B\u9762\u8FD9\u79CD ORDER BY LIMIT \u67E5\u8BE2\uFF0C\u5728\u65E5\u5FD7\u68C0\u7D22\u7B49\u660E\u7EC6\u67E5\u8BE2\u573A\u666F\u4E2D\u5F88\u5E38\u89C1\uFF0CDoris \u4F1A\u81EA\u52A8\u5BF9\u8FD9\u79CD\u7C7B\u578B\u7684\u67E5\u8BE2\u8FDB\u884C\u4F18\u5316\u3002"},"sidebar":"docs","previous":{"title":"Runtime Filter","permalink":"/zh-CN/docs/dev/query-acceleration/optimization-technology-principle/runtime-filter"},"next":{"title":"\u7EDF\u8BA1\u4FE1\u606F","permalink":"/zh-CN/docs/dev/query-acceleration/optimization-technology-principle/statistics"}}'),r=i("785893"),l=i("250065");let s={title:"TOPN \u67E5\u8BE2\u4F18\u5316",language:"zh-CN",description:"TOPN \u67E5\u8BE2\u662F\u6307\u4E0B\u9762\u8FD9\u79CD ORDER BY LIMIT \u67E5\u8BE2\uFF0C\u5728\u65E5\u5FD7\u68C0\u7D22\u7B49\u660E\u7EC6\u67E5\u8BE2\u573A\u666F\u4E2D\u5F88\u5E38\u89C1\uFF0CDoris \u4F1A\u81EA\u52A8\u5BF9\u8FD9\u79CD\u7C7B\u578B\u7684\u67E5\u8BE2\u8FDB\u884C\u4F18\u5316\u3002"},o=void 0,d={},c=[{value:"TOPN \u67E5\u8BE2\u4F18\u5316\u7684\u4F18\u5316\u70B9",id:"topn-\u67E5\u8BE2\u4F18\u5316\u7684\u4F18\u5316\u70B9",level:2},{value:"TOPN \u67E5\u8BE2\u4F18\u5316\u7684\u9650\u5236",id:"topn-\u67E5\u8BE2\u4F18\u5316\u7684\u9650\u5236",level:2},{value:"\u914D\u7F6E\u53C2\u6570\u548C\u67E5\u8BE2\u5206\u6790",id:"\u914D\u7F6E\u53C2\u6570\u548C\u67E5\u8BE2\u5206\u6790",level:2},{value:"\u68C0\u67E5 TOPN \u67E5\u8BE2\u4F18\u5316\u662F\u5426\u542F\u7528",id:"\u68C0\u67E5-topn-\u67E5\u8BE2\u4F18\u5316\u662F\u5426\u542F\u7528",level:3},{value:"\u68C0\u67E5 TOPN \u67E5\u8BE2\u4F18\u5316\u6267\u884C\u65F6\u662F\u5426\u6709\u6548\u679C",id:"\u68C0\u67E5-topn-\u67E5\u8BE2\u4F18\u5316\u6267\u884C\u65F6\u662F\u5426\u6709\u6548\u679C",level:3}];function a(e){let n={code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,l.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:"TOPN \u67E5\u8BE2\u662F\u6307\u4E0B\u9762\u8FD9\u79CD ORDER BY LIMIT \u67E5\u8BE2\uFF0C\u5728\u65E5\u5FD7\u68C0\u7D22\u7B49\u660E\u7EC6\u67E5\u8BE2\u573A\u666F\u4E2D\u5F88\u5E38\u89C1\uFF0CDoris \u4F1A\u81EA\u52A8\u5BF9\u8FD9\u79CD\u7C7B\u578B\u7684\u67E5\u8BE2\u8FDB\u884C\u4F18\u5316\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"SELECT * FROM tablex WHERE xxx ORDER BY c1,c2 ... LIMIT n\n"})}),"\n",(0,r.jsx)(n.h2,{id:"topn-\u67E5\u8BE2\u4F18\u5316\u7684\u4F18\u5316\u70B9",children:"TOPN \u67E5\u8BE2\u4F18\u5316\u7684\u4F18\u5316\u70B9"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"\u6267\u884C\u8FC7\u7A0B\u4E2D\u52A8\u6001\u5BF9\u6392\u5E8F\u5217\u6784\u5EFA\u8303\u56F4\u8FC7\u6EE4\u6761\u4EF6\uFF08\u6BD4\u5982 c1 >= 10000\uFF09\uFF0C\u8BFB\u6570\u636E\u65F6\u81EA\u52A8\u5E26\u4E0A\u524D\u9762\u7684\u6761\u4EF6\uFF0C\u5229\u7528 Zonemap \u7D22\u5F15\u8FC7\u6EE4\u6389\u4E00\u4E9B\u6570\u636E\u751A\u81F3\u6587\u4EF6\u3002"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"\u5982\u679C\u6392\u5E8F\u5B57\u6BB5 c1,c2 \u6B63\u597D\u662F Table Key \u7684\u524D\u7F00\uFF0C\u5219\u66F4\u8FDB\u4E00\u6B65\u4F18\u5316\uFF0C\u8BFB\u6570\u636E\u7684\u65F6\u5019\u53EA\u7528\u8BFB\u6570\u636E\u6587\u4EF6\u7684\u5934\u90E8\u6216\u8005\u5C3E\u90E8 n \u884C\u3002"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"SELECT * \u5EF6\u8FDF\u7269\u5316\uFF0C\u8BFB\u6570\u636E\u548C\u6392\u5E8F\u8FC7\u7A0B\u4E2D\u53EA\u8BFB\u6392\u5E8F\u5217\u4E0D\u8BFB\u5176\u5B83\u5217\uFF0C\u5F97\u5230\u7B26\u5408\u6761\u4EF6\u7684\u884C\u53F7\u540E\uFF0C\u518D\u53BB\u8BFB\u90A3 n \u884C\u9700\u8981\u7684\u5168\u90E8\u5217\u6570\u636E\uFF0C\u5927\u5E45\u51CF\u5C11\u8BFB\u53D6\u548C\u6392\u5E8F\u7684\u5217\u3002"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"topn-\u67E5\u8BE2\u4F18\u5316\u7684\u9650\u5236",children:"TOPN \u67E5\u8BE2\u4F18\u5316\u7684\u9650\u5236"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"\u53EA\u80FD\u7528\u4E8E Duplicate \u8868\u548C Unique MOW \u8868\uFF0C\u56E0\u4E3A MOR \u8868\u7528\u8FD9\u4E2A\u4F18\u5316\u53EF\u80FD\u6709\u7ED3\u679C\u9519\u8BEF\u3002"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["\u5BF9\u4E8E\u8FC7\u5927\u7684 ",(0,r.jsx)(n.code,{children:"n"}),"\uFF0C\u4F18\u5316\u5185\u5B58\u6D88\u8017\u4F1A\u5F88\u5927\uFF0C\u6240\u4EE5\u8D85\u8FC7 ",(0,r.jsx)(n.code,{children:"topn_opt_limit_threshold"})," Session \u53D8\u91CF\u7684 ",(0,r.jsx)(n.code,{children:"n"})," \u4E0D\u4F1A\u4F7F\u7528\u4F18\u5316\u3002"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"\u914D\u7F6E\u53C2\u6570\u548C\u67E5\u8BE2\u5206\u6790",children:"\u914D\u7F6E\u53C2\u6570\u548C\u67E5\u8BE2\u5206\u6790"}),"\n",(0,r.jsx)(n.p,{children:"\u4E0B\u9762\u4E24\u4E2A\u53C2\u6570\u90FD\u662F Session Variable\uFF0C\u53EF\u4EE5\u9488\u5BF9\u67D0\u4E2A SQL \u6216\u8005\u5168\u5C40\u8BBE\u7F6E\u3002"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"topn_opt_limit_threshold"}),"\uFF0CLIMIT n \u5C0F\u4E8E\u8FD9\u4E2A\u503C\u624D\u4F1A\u6709\u4F18\u5316\uFF0C\u9ED8\u8BA4\u503C 1024\uFF0C\u5C06\u5B83\u8BBE\u7F6E\u4E3A 0 \u53EF\u4EE5\u5173\u95ED TOPN \u67E5\u8BE2\u4F18\u5316\u3002"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"enable_two_phase_read_opt"}),"\uFF0C\u662F\u5426\u5F00\u542F\u4F18\u5316 3\uFF0C\u9ED8\u8BA4\u4E3A true\uFF0C\u53EF\u4EE5\u8C03\u4E3A false \u5173\u95ED\u8FD9\u4E2A\u4F18\u5316\u3002"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"topn_filter_ratio"}),"\uFF0CLIMIT n \u548C\u8868\u603B\u6570\u636E\u7684\u6BD4\u7387\uFF0C\u9ED8\u8BA4\u503C 0.5\uFF0C\u8868\u793A LIMIT \u6570\u91CF\u591A\u4E8E\u8868\u4E2D\u6570\u636E\u7684\u4E00\u534A\u5219\u4E0D\u751F\u6210 filter\u3002"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"\u68C0\u67E5-topn-\u67E5\u8BE2\u4F18\u5316\u662F\u5426\u542F\u7528",children:"\u68C0\u67E5 TOPN \u67E5\u8BE2\u4F18\u5316\u662F\u5426\u542F\u7528"}),"\n",(0,r.jsx)(n.p,{children:"explain SQL \u62FF\u5230 query plan \u53EF\u4EE5\u786E\u8BA4\u8FD9\u4E2A sql \u662F\u5426\u542F\u7528 TOPN \u67E5\u8BE2\u4F18\u5316\uFF0C\u4EE5\u4E0B\u9762\u7684\u4E3A\u4F8B\uFF1A"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"TOPN OPT \u4EE3\u8868\u6709\u4F18\u5316 1"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"VOlapScanNode \u4E0B\u9762\u6709 SORT LIMIT \u4EE3\u8868\u6709\u4F18\u5316 2"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"OPT TWO PHASE \u4EE3\u8868\u6709\u4F18\u5316 3"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"  1:VTOP-N(137)\n  |  order by: @timestamp18 DESC\n  |  TOPN OPT\n  |  OPT TWO PHASE\n  |  offset: 0\n  |  limit: 10\n  |  distribute expr lists: applicationName5\n  |  \n  0:VOlapScanNode(106)\n     TABLE: log_db.log_core_all_no_index(log_core_all_no_index), PREAGGREGATION: ON\n     SORT INFO:\n          @timestamp18\n     SORT LIMIT: 10\n     TOPN OPT:1\n     PREDICATES: ZYCFC-TRACE-ID4 like '%flowId-1720055220933%'\n     partitions=1/8 (p20240704), tablets=250/250, tabletList=1727094,1727096,1727098 ...\n     cardinality=345472780, avgRowSize=0.0, numNodes=1\n     pushAggOp=NONE\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u68C0\u67E5-topn-\u67E5\u8BE2\u4F18\u5316\u6267\u884C\u65F6\u662F\u5426\u6709\u6548\u679C",children:"\u68C0\u67E5 TOPN \u67E5\u8BE2\u4F18\u5316\u6267\u884C\u65F6\u662F\u5426\u6709\u6548\u679C"}),"\n",(0,r.jsxs)(n.p,{children:["\u9996\u5148\uFF0C\u53EF\u4EE5\u5C06 ",(0,r.jsx)(n.code,{children:"topn_opt_limit_threshold"})," \u8BBE\u7F6E\u4E3A 0 \u5173\u95ED TOPN \u67E5\u8BE2\u4F18\u5316\uFF0C\u5BF9\u6BD4\u5F00\u542F\u548C\u5173\u95ED\u4F18\u5316\u7684 SQL \u6267\u884C\u65F6\u95F4\u3002"]}),"\n",(0,r.jsx)(n.p,{children:"\u5F00\u542F TOPN \u67E5\u8BE2\u4F18\u5316\u540E\uFF0C\u5728 Query Profile \u4E2D\u641C\u7D22 RuntimePredicate\uFF0C\u5173\u6CE8\u4E0B\u9762\u51E0\u4E2A\u6307\u6807\uFF1A"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"RowsZonemapRuntimePredicateFiltered"})," \u8FD9\u4E2A\u4EE3\u8868\u8FC7\u6EE4\u6389\u7684\u884C\u6570\uFF0C\u8D8A\u5927\u8D8A\u597D"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"NumSegmentFiltered"})," \u8FD9\u4E2A\u4EE3\u8868\u8FC7\u6EE4\u6389\u7684\u6570\u636E\u6587\u4EF6\u4E2A\u6570\uFF0C\u8D8A\u5927\u8D8A\u597D"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"BlockConditionsFilteredZonemapRuntimePredicateTime"})," \u4EE3\u8868\u8FC7\u6EE4\u6570\u636E\u7684\u8017\u65F6\uFF0C\u8D8A\u5C0F\u8D8A\u597D"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"\u6CE8\u610F\uFF0C2.0.3 \u4E4B\u524D\u7684\u7248\u672C\u4E2D RuntimePredicate \u7684\u6307\u6807\u672A\u72EC\u7ACB\uFF0C\u53EF\u4EE5\u901A\u8FC7 Zonamap \u6307\u6807\u5927\u81F4\u89C2\u5BDF\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"    SegmentIterator:\n          -  BitmapIndexFilterTimer:  46.54us\n          -  BlockConditionsFilteredBloomFilterTime:  10.352us\n          -  BlockConditionsFilteredDictTime:  7.299us\n          -  BlockConditionsFilteredTime:  202.23ms\n          -  BlockConditionsFilteredZonemapRuntimePredicateTime:  0ns\n          -  BlockConditionsFilteredZonemapTime:  402.917ms\n          -  BlockInitSeekCount:  399\n          -  BlockInitSeekTime:  11.309ms\n          -  BlockInitTime:  215.59ms\n          -  BlockLoadTime:  7s567ms\n          -  BlocksLoad:  392.97K  (392970)\n          -  CachedPagesNum:  0\n          -  CollectIteratorMergeTime:  0ns\n          -  CollectIteratorNormalTime:  0ns\n          -  CompressedBytesRead:  29.76  MB\n          -  DecompressorTimer:  427.713ms\n          -  ExprFilterEvalTime:  3s930ms\n          -  FirstReadSeekCount:  392.921K  (392921)\n          -  FirstReadSeekTime:  528.287ms\n          -  FirstReadTime:  1s134ms\n          -  IOTimer:  51.286ms\n          -  InvertedIndexFilterTime:  49.457us\n          -  InvertedIndexQueryBitmapCopyTime:  0ns\n          -  InvertedIndexQueryBitmapOpTime:  0ns\n          -  InvertedIndexQueryCacheHit:  0\n          -  InvertedIndexQueryCacheMiss:  0\n          -  InvertedIndexQueryTime:  0ns\n          -  InvertedIndexSearcherOpenTime:  0ns\n          -  InvertedIndexSearcherSearchTime:  0ns\n          -  LazyReadSeekCount:  0\n          -  LazyReadSeekTime:  0ns\n          -  LazyReadTime:  106.952us\n          -  NumSegmentFiltered:  0\n          -  NumSegmentTotal:  50\n          -  OutputColumnTime:  61.987ms\n          -  OutputIndexResultColumnTimer:  12.345ms\n          -  RawRowsRead:  3.929151M  (3929151)\n          -  RowsBitmapIndexFiltered:  0\n          -  RowsBloomFilterFiltered:  0\n          -  RowsConditionsFiltered:  6.38976M  (6389760)\n          -  RowsDictFiltered:  0\n          -  RowsInvertedIndexFiltered:  0\n          -  RowsKeyRangeFiltered:  0\n          -  RowsShortCircuitPredFiltered:  0\n          -  RowsShortCircuitPredInput:  0\n          -  RowsStatsFiltered:  6.38976M  (6389760)\n          -  RowsVectorPredFiltered:  0\n          -  RowsVectorPredInput:  0\n          -  RowsZonemapRuntimePredicateFiltered:  6.38976M  (6389760)\n          -  SecondReadTime:  0ns\n          -  ShortPredEvalTime:  0ns\n          -  TotalPagesNum:  2.301K  (2301)\n          -  UncompressedBytesRead:  137.99  MB\n          -  VectorPredEvalTime:  0ns\n"})})]})}function p(e={}){let{wrapper:n}={...(0,l.a)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}},250065:function(e,n,i){i.d(n,{Z:function(){return o},a:function(){return s}});var t=i(667294);let r={},l=t.createContext(r);function s(e){let n=t.useContext(l);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),t.createElement(l.Provider,{value:n},e.children)}}}]);