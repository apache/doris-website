"use strict";(self.webpackChunkdoris_website=self.webpackChunkdoris_website||[]).push([["48082"],{788072:function(n,e,s){s.r(e),s.d(e,{default:()=>o,frontMatter:()=>d,metadata:()=>a,assets:()=>_,toc:()=>c,contentTitle:()=>r});var a=JSON.parse('{"id":"query-data/window-function","title":"\u5206\u6790\u51FD\u6570\uFF08\u7A97\u53E3\u51FD\u6570\uFF09","description":"\u5206\u6790\u51FD\u6570\uFF0C\u4E5F\u79F0\u4E3A\u7A97\u53E3\u51FD\u6570\uFF0C\u662F\u4E00\u79CD\u5728 SQL \u67E5\u8BE2\u4E2D\u5BF9\u6570\u636E\u96C6\u4E2D\u7684\u884C\u8FDB\u884C\u590D\u6742\u8BA1\u7B97\u7684\u51FD\u6570\u3002\u7A97\u53E3\u51FD\u6570\u7684\u7279\u70B9\u5728\u4E8E\uFF0C\u5B83\u4EEC\u4E0D\u4F1A\u51CF\u5C11\u67E5\u8BE2\u7ED3\u679C\u7684\u884C\u6570\uFF0C\u800C\u662F\u4E3A\u6BCF\u4E00\u884C\u589E\u52A0\u4E00\u4E2A\u65B0\u7684\u8BA1\u7B97\u7ED3\u679C\u3002\u7A97\u53E3\u51FD\u6570\u9002\u7528\u4E8E\u591A\u79CD\u5206\u6790\u573A\u666F\uFF0C\u5982\u8BA1\u7B97\u6EDA\u52A8\u5408\u8BA1\u3001\u6392\u540D\u4EE5\u53CA\u79FB\u52A8\u5E73\u5747\u7B49\u3002","source":"@site/i18n/zh-CN/docusaurus-plugin-content-docs/current/query-data/window-function.md","sourceDirName":"query-data","slug":"/query-data/window-function","permalink":"/zh-CN/docs/dev/query-data/window-function","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"title":"\u5206\u6790\u51FD\u6570\uFF08\u7A97\u53E3\u51FD\u6570\uFF09","language":"zh-CN"},"sidebar":"docs","previous":{"title":"\u805A\u5408\u591A\u7EF4\u5206\u6790","permalink":"/zh-CN/docs/dev/query-data/multi-dimensional-analytics"},"next":{"title":"\u516C\u7528\u8868\u8868\u8FBE\u5F0F\uFF08CTE\uFF09","permalink":"/zh-CN/docs/dev/query-data/cte"}}'),t=s("785893"),i=s("250065");let d={title:"\u5206\u6790\u51FD\u6570\uFF08\u7A97\u53E3\u51FD\u6570\uFF09",language:"zh-CN"},r=void 0,_={},c=[{value:"\u57FA\u672C\u6982\u5FF5\u4ECB\u7ECD",id:"\u57FA\u672C\u6982\u5FF5\u4ECB\u7ECD",level:2},{value:"\u5904\u7406\u987A\u5E8F",id:"\u5904\u7406\u987A\u5E8F",level:3},{value:"\u7ED3\u679C\u96C6\u5206\u533A",id:"\u7ED3\u679C\u96C6\u5206\u533A",level:3},{value:"\u7A97\u53E3",id:"\u7A97\u53E3",level:3},{value:"\u5F53\u524D\u884C",id:"\u5F53\u524D\u884C",level:3},{value:"\u6392\u5E8F\u51FD\u6570",id:"\u6392\u5E8F\u51FD\u6570",level:2},{value:"NTILE \u51FD\u6570",id:"ntile-\u51FD\u6570",level:3},{value:"\u805A\u5408\u51FD\u6570",id:"\u805A\u5408\u51FD\u6570",level:2},{value:"\u4F7F\u7528\u805A\u5408\u51FD\u6570 SUM \u8BA1\u7B97\u7D2F\u8BA1\u503C",id:"\u4F7F\u7528\u805A\u5408\u51FD\u6570-sum-\u8BA1\u7B97\u7D2F\u8BA1\u503C",level:3},{value:"\u4F7F\u7528\u805A\u5408\u51FD\u6570 AVG \u8BA1\u7B97\u79FB\u52A8\u5E73\u5747\u503C",id:"\u4F7F\u7528\u805A\u5408\u51FD\u6570-avg-\u8BA1\u7B97\u79FB\u52A8\u5E73\u5747\u503C",level:3},{value:"\u62A5\u544A\u51FD\u6570",id:"\u62A5\u544A\u51FD\u6570",level:2},{value:"LAG / LEAD \u51FD\u6570",id:"lag--lead-\u51FD\u6570",level:2},{value:"\u9644\u5F55",id:"\u9644\u5F55",level:2}];function l(n){let e={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.a)(),...n.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(e.p,{children:["\u5206\u6790\u51FD\u6570\uFF0C\u4E5F\u79F0\u4E3A\u7A97\u53E3\u51FD\u6570\uFF0C\u662F\u4E00\u79CD\u5728 SQL \u67E5\u8BE2\u4E2D\u5BF9\u6570\u636E\u96C6\u4E2D\u7684\u884C\u8FDB\u884C\u590D\u6742\u8BA1\u7B97\u7684\u51FD\u6570\u3002\u7A97\u53E3\u51FD\u6570\u7684\u7279\u70B9\u5728\u4E8E\uFF0C\u5B83\u4EEC\u4E0D\u4F1A\u51CF\u5C11\u67E5\u8BE2\u7ED3\u679C\u7684\u884C\u6570\uFF0C\u800C\u662F\u4E3A\u6BCF\u4E00\u884C\u589E\u52A0\u4E00\u4E2A\u65B0\u7684\u8BA1\u7B97\u7ED3\u679C\u3002\u7A97\u53E3\u51FD\u6570\u9002\u7528\u4E8E\u591A\u79CD\u5206\u6790\u573A\u666F\uFF0C\u5982\u8BA1\u7B97\u6EDA\u52A8\u5408\u8BA1\u3001\u6392\u540D\u4EE5\u53CA\u79FB\u52A8\u5E73\u5747\u7B49\u3002\n\u5177\u4F53\u7684\u8BED\u6CD5\u4ECB\u7ECD\u53EF\u4EE5",(0,t.jsx)(e.a,{href:"/zh-CN/docs/dev/sql-manual/sql-functions/window-functions/overview",children:"\u53C2\u9605"})]}),"\n",(0,t.jsx)(e.p,{children:"\u4E0B\u9762\u662F\u4E00\u4E2A\u4F7F\u7528\u7A97\u53E3\u51FD\u6570\u8BA1\u7B97\u6BCF\u4E2A\u5546\u5E97\u7684\u524D\u540E\u4E09\u5929\u7684\u9500\u552E\u79FB\u52A8\u5E73\u5747\u503C\u7684\u4F8B\u5B50\uFF1A"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"CREATE TABLE daily_sales (\n    store_id INT,\n    sales_date DATE,\n    sales_amount DECIMAL(10, 2)\n) PROPERTIES (\"replication_num\" = \"1\");\n\nINSERT INTO daily_sales (store_id, sales_date, sales_amount) VALUES (1, '2023-01-01', 100.00), (1, '2023-01-02', 150.00), (1, '2023-01-03', 200.00), (1, '2023-01-04', 250.00), (1, '2023-01-05', 300.00), (1, '2023-01-06', 350.00), (1, '2023-01-07', 400.00), (1, '2023-01-08', 450.00), (1, '2023-01-09', 500.00), (2, '2023-01-01', 110.00), (2, '2023-01-02', 160.00), (2, '2023-01-03', 210.00), (2, '2023-01-04', 260.00), (2, '2023-01-05', 310.00), (2, '2023-01-06', 360.00), (2, '2023-01-07', 410.00), (2, '2023-01-08', 460.00), (2, '2023-01-09', 510.00);\n\nSELECT\n        store_id,\n        sales_date,\n        sales_amount,\n        AVG(sales_amount) OVER ( PARTITION BY store_id ORDER BY sales_date \n        ROWS BETWEEN 3 PRECEDING AND 3 FOLLOWING ) AS moving_avg_sales\nFROM\n        daily_sales;\n"})}),"\n",(0,t.jsx)(e.p,{children:"\u67E5\u8BE2\u7ED3\u679C\u4E3A\u5982\u4E0B\uFF1A"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"+----------+------------+--------------+------------------+\n| store_id | sales_date | sales_amount | moving_avg_sales |\n+----------+------------+--------------+------------------+\n|        1 | 2023-01-01 |       100.00 |         175.0000 |\n|        1 | 2023-01-02 |       150.00 |         200.0000 |\n|        1 | 2023-01-03 |       200.00 |         225.0000 |\n|        1 | 2023-01-04 |       250.00 |         250.0000 |\n|        1 | 2023-01-05 |       300.00 |         300.0000 |\n|        1 | 2023-01-06 |       350.00 |         350.0000 |\n|        1 | 2023-01-07 |       400.00 |         375.0000 |\n|        1 | 2023-01-08 |       450.00 |         400.0000 |\n|        1 | 2023-01-09 |       500.00 |         425.0000 |\n|        2 | 2023-01-01 |       110.00 |         185.0000 |\n|        2 | 2023-01-02 |       160.00 |         210.0000 |\n|        2 | 2023-01-03 |       210.00 |         235.0000 |\n|        2 | 2023-01-04 |       260.00 |         260.0000 |\n|        2 | 2023-01-05 |       310.00 |         310.0000 |\n|        2 | 2023-01-06 |       360.00 |         360.0000 |\n|        2 | 2023-01-07 |       410.00 |         385.0000 |\n|        2 | 2023-01-08 |       460.00 |         410.0000 |\n|        2 | 2023-01-09 |       510.00 |         435.0000 |\n+----------+------------+--------------+------------------+\n18 rows in set (0.09 sec)\n"})}),"\n",(0,t.jsx)(e.h2,{id:"\u57FA\u672C\u6982\u5FF5\u4ECB\u7ECD",children:"\u57FA\u672C\u6982\u5FF5\u4ECB\u7ECD"}),"\n",(0,t.jsx)(e.h3,{id:"\u5904\u7406\u987A\u5E8F",children:"\u5904\u7406\u987A\u5E8F"}),"\n",(0,t.jsx)(e.p,{children:"\u4F7F\u7528\u5206\u6790\u51FD\u6570\u7684\u67E5\u8BE2\u5904\u7406\u53EF\u4EE5\u5206\u4E3A\u4E09\u4E2A\u9636\u6BB5\u3002"}),"\n",(0,t.jsxs)(e.ol,{children:["\n",(0,t.jsxs)(e.li,{children:["\n",(0,t.jsx)(e.p,{children:"\u6267\u884C\u6240\u6709\u7684JOIN\u3001WHERE\u3001GROUP BY \u548C HAVING \u5B50\u53E5\u3002"}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\n",(0,t.jsx)(e.p,{children:"\u5C06\u7ED3\u679C\u96C6\u63D0\u4F9B\u7ED9\u5206\u6790\u51FD\u6570\uFF0C\u5E76\u8FDB\u884C\u6240\u6709\u5FC5\u8981\u7684\u8BA1\u7B97\u3002"}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\n",(0,t.jsx)(e.p,{children:"\u5982\u679C\u67E5\u8BE2\u7684\u672B\u5C3E\u5305\u542B ORDER BY \u5B50\u53E5\uFF0C\u5219\u5904\u7406\u8BE5\u5B50\u53E5\u4EE5\u5B9E\u73B0\u7CBE\u786E\u7684\u8F93\u51FA\u6392\u5E8F\u3002"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.p,{children:"\u67E5\u8BE2\u7684\u5904\u7406\u987A\u5E8F\u5982\u56FE\u6240\u793A\uFF1A"}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.img,{alt:"\u57FA\u672C\u6982\u5FF5\u4ECB\u7ECD",src:s(748660).Z+"",width:"2560",height:"1280"})}),"\n",(0,t.jsx)(e.h3,{id:"\u7ED3\u679C\u96C6\u5206\u533A",children:"\u7ED3\u679C\u96C6\u5206\u533A"}),"\n",(0,t.jsx)(e.p,{children:"\u5206\u533A\u662F\u5728\u4F7F\u7528 PARTITION BY \u5B50\u53E5\u5B9A\u4E49\u7684\u7EC4\u4E4B\u540E\u521B\u5EFA\u7684\u3002"}),"\n",(0,t.jsx)(e.admonition,{title:"\u6CE8\u610F",type:"caution",children:(0,t.jsx)(e.p,{children:"\u5206\u6790\u51FD\u6570\u4E2D\u4F7F\u7528\u7684\u672F\u8BED\u201C\u5206\u533A\u201D\u4E0E\u8868\u5206\u533A\u529F\u80FD\u65E0\u5173\u3002\u5728\u672C\u7AE0\u4E2D\uFF0C\u672F\u8BED\u201C\u5206\u533A\u201D\u4EC5\u6307\u4E0E\u5206\u6790\u51FD\u6570\u76F8\u5173\u7684\u542B\u4E49\u3002"})}),"\n",(0,t.jsx)(e.h3,{id:"\u7A97\u53E3",children:"\u7A97\u53E3"}),"\n",(0,t.jsx)(e.p,{children:"\u5BF9\u4E8E\u5206\u533A\u4E2D\u7684\u6BCF\u4E00\u884C\uFF0C\u4F60\u53EF\u4EE5\u5B9A\u4E49\u4E00\u4E2A\u6ED1\u52A8\u6570\u636E\u7A97\u53E3\uFF0C\u6B64\u7A97\u53E3\u786E\u5B9A\u4E86\u7528\u4E8E\u6267\u884C\u5F53\u524D\u884C\u8BA1\u7B97\u6240\u6D89\u53CA\u7684\u884C\u8303\u56F4\u3002\u7A97\u53E3\u5177\u6709\u4E00\u4E2A\u8D77\u59CB\u884C\u548C\u4E00\u4E2A\u7ED3\u675F\u884C\uFF0C\u6839\u636E\u5176\u5B9A\u4E49\uFF0C\u7A97\u53E3\u53EF\u4EE5\u5728\u4E00\u7AEF\u6216\u4E24\u7AEF\u8FDB\u884C\u6ED1\u52A8\u3002\u4F8B\u5982ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW\uFF0C\u4E3A\u7D2F\u79EF\u548C\u51FD\u6570\u5B9A\u4E49\u7684\u7A97\u53E3\uFF0C\u5176\u8D77\u59CB\u884C\u56FA\u5B9A\u5728\u5176\u5206\u533A\u7684\u7B2C\u4E00\u884C\uFF0C\u800C\u5176\u7ED3\u675F\u884C\u5219\u4ECE\u8D77\u70B9\u4E00\u76F4\u6ED1\u52A8\u5230\u5206\u533A\u7684\u6700\u540E\u4E00\u884C\u3002\u76F8\u53CDROWS BETWEEN 3 PRECEDING AND 3 FOLLOWING\uFF0C\u4E3A\u79FB\u52A8\u5E73\u5747\u503C\u5B9A\u4E49\u7684\u7A97\u53E3\uFF0C\u5176\u8D77\u70B9\u548C\u7EC8\u70B9\u90FD\u4F1A\u8FDB\u884C\u6ED1\u52A8\u3002"}),"\n",(0,t.jsx)(e.p,{children:"\u7A97\u53E3\u7684\u5927\u5C0F\u53EF\u4EE5\u8BBE\u7F6E\u4E3A\u4E0E\u5206\u533A\u4E2D\u7684\u6240\u6709\u884C\u4E00\u6837\u5927\uFF0C\u4E5F\u53EF\u4EE5\u8BBE\u7F6E\u4E3A\u5728\u5206\u533A\u5185\u4EC5\u5305\u542B\u4E00\u884C\u7684\u6ED1\u52A8\u7A97\u53E3\u3002\u9700\u8981\u6CE8\u610F\u7684\u662F\uFF0C\u5F53\u7A97\u53E3\u9760\u8FD1\u5206\u533A\u7684\u8FB9\u754C\u65F6\uFF0C\u7531\u4E8E\u8FB9\u754C\u7684\u9650\u5236\uFF0C\u8BA1\u7B97\u7684\u8303\u56F4\u53EF\u80FD\u4F1A\u7F29\u51CF\u884C\u6570\uFF0C\u6B64\u65F6\u51FD\u6570\u4EC5\u8FD4\u56DE\u53EF\u7528\u884C\u7684\u8BA1\u7B97\u7ED3\u679C\u3002"}),"\n",(0,t.jsx)(e.p,{children:"\u5728\u4F7F\u7528\u7A97\u53E3\u51FD\u6570\u65F6\uFF0C\u5F53\u524D\u884C\u4F1A\u88AB\u5305\u542B\u5728\u8BA1\u7B97\u4E4B\u4E2D\u3002\u56E0\u6B64\uFF0C\u5728\u5904\u7406 n \u4E2A\u9879\u76EE\u65F6\uFF0C\u5E94\u6307\u5B9A\u4E3A (n-1)\u3002\u4F8B\u5982\uFF0C\u5982\u679C\u60A8\u9700\u8981\u8BA1\u7B97\u4E94\u5929\u7684\u5E73\u5747\u503C\uFF0C\u7A97\u53E3\u5E94\u6307\u5B9A\u4E3A\u201CROWS BETWEEN 4 PRECEDING AND CURRENT ROW\u201D\uFF0C\u8FD9\u4E5F\u53EF\u4EE5\u7B80\u5199\u4E3A\u201CROWS 4 PRECEDING\u201D\u3002"}),"\n",(0,t.jsx)(e.h3,{id:"\u5F53\u524D\u884C",children:"\u5F53\u524D\u884C"}),"\n",(0,t.jsx)(e.p,{children:"\u4F7F\u7528\u5206\u6790\u51FD\u6570\u6267\u884C\u7684\u6BCF\u4E2A\u8BA1\u7B97\u90FD\u662F\u57FA\u4E8E\u5206\u533A\u5185\u7684\u5F53\u524D\u884C\u3002\u5F53\u524D\u884C\u4F5C\u4E3A\u786E\u5B9A\u7A97\u53E3\u5F00\u59CB\u548C\u7ED3\u675F\u7684\u53C2\u8003\u70B9\uFF0C\u5177\u4F53\u5982\u56FE\u6240\u793A\u3002"}),"\n",(0,t.jsx)(e.p,{children:"\u4F8B\u5982: ROWS BETWEEN 6 PRECEDING AND 6 FOLLOWING\uFF0C\u53EF\u4EE5\u4F7F\u7528\u4E00\u4E2A\u7A97\u53E3\u6765\u5B9A\u4E49\u4E2D\u5FC3\u79FB\u52A8\u5E73\u5747\u503C\u8BA1\u7B97\uFF0C\u8BE5\u7A97\u53E3\u5305\u542B\u5F53\u524D\u884C\u3001\u5F53\u524D\u884C\u4E4B\u524D\u7684 6 \u884C\u4EE5\u53CA\u5F53\u524D\u884C\u4E4B\u540E\u7684 6 \u884C\u3002\u8FD9\u6837\u5C31\u521B\u5EFA\u4E86\u4E00\u4E2A\u5305\u542B 13 \u884C\u7684\u6ED1\u52A8\u7A97\u53E3\u3002"}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.img,{alt:"\u5F53\u524D\u884C",src:s(406961).Z+"",width:"1280",height:"640"})}),"\n",(0,t.jsx)(e.h2,{id:"\u6392\u5E8F\u51FD\u6570",children:"\u6392\u5E8F\u51FD\u6570"}),"\n",(0,t.jsxs)(e.p,{children:["\u6392\u5E8F\u51FD\u6570\u4E2D\uFF0C\u53EA\u6709\u5F53\u6307\u5B9A\u7684\u6392\u5E8F\u5217\u662F\u552F\u4E00\u503C\u5217\u65F6\uFF0C\u67E5\u8BE2\u7ED3\u679C\u624D\u662F\u786E\u5B9A\u7684\uFF1B\u5982\u679C\u6392\u5E8F\u5217\u5305\u542B\u91CD\u590D\u503C\uFF0C\u5219\u6BCF\u6B21\u7684\u67E5\u8BE2\u7ED3\u679C\u53EF\u80FD\u4E0D\u540C\u3002\u66F4\u591A\u76F8\u5173\u51FD\u6570\u53EF\u4EE5",(0,t.jsx)(e.a,{href:"/zh-CN/docs/dev/sql-manual/sql-functions/window-functions/overview",children:"\u53C2\u9605"})]}),"\n",(0,t.jsx)(e.h3,{id:"ntile-\u51FD\u6570",children:"NTILE \u51FD\u6570"}),"\n",(0,t.jsx)(e.p,{children:"NTILE \u662F SQL \u4E2D\u7684\u4E00\u79CD\u7A97\u53E3\u51FD\u6570\uFF0C\u7528\u4E8E\u5C06\u67E5\u8BE2\u7ED3\u679C\u96C6\u5206\u6210\u6307\u5B9A\u6570\u91CF\u7684\u6876\uFF08\u7EC4\uFF09\uFF0C\u5E76\u4E3A\u6BCF\u4E00\u884C\u5206\u914D\u4E00\u4E2A\u6876\u53F7\u3002\u8FD9\u5728\u6570\u636E\u5206\u6790\u548C\u62A5\u544A\u4E2D\u975E\u5E38\u6709\u7528\uFF0C\u7279\u522B\u662F\u5728\u9700\u8981\u5BF9\u6570\u636E\u8FDB\u884C\u5206\u7EC4\u548C\u6392\u5E8F\u65F6\u3002"}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"1. \u51FD\u6570\u8BED\u6CD5"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"NTILE(num_buckets) OVER ([PARTITION BY partition_expression] ORDER BY order_expression)\n"})}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.code,{children:"num_buckets"}),"\uFF1A\u8981\u5C06\u884C\u5212\u5206\u6210\u7684\u6876\u7684\u6570\u91CF\u3002"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.code,{children:"PARTITION BY partition_expression"}),"\uFF08\u53EF\u9009\uFF09\uFF1A\u5B9A\u4E49\u5982\u4F55\u5206\u533A\u6570\u636E\u3002"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.code,{children:"ORDER BY order_expression"}),"\uFF1A\u5B9A\u4E49\u5982\u4F55\u6392\u5E8F\u6570\u636E\u3002"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"2. \u4F7F\u7528 NTILE \u51FD\u6570"})}),"\n",(0,t.jsxs)(e.p,{children:["\u5047\u8BBE\u6709\u4E00\u4E2A\u5305\u542B\u5B66\u751F\u8003\u8BD5\u6210\u7EE9\u7684\u8868",(0,t.jsx)(e.code,{children:"class_student_scores"}),"\uFF0C\u5E0C\u671B\u5C06\u5B66\u751F\u6309\u6210\u7EE9\u5206\u6210 4 \u4E2A\u7EC4\uFF0C\u6BCF\u7EC4\u4E2D\u7684\u5B66\u751F\u6570\u91CF\u5C3D\u53EF\u80FD\u5747\u5300\u3002"]}),"\n",(0,t.jsxs)(e.p,{children:["\u9996\u5148\uFF0C\u521B\u5EFA\u5E76\u63D2\u5165\u6570\u636E\u5230",(0,t.jsx)(e.code,{children:"class_student_scores"}),"\u8868\u4E2D\uFF1A"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"CREATE TABLE class_student_scores (\n    class_id INT,\n    student_id INT,\n    student_name VARCHAR(50),\n    score INT\n)distributed by hash(student_id) properties('replication_num'=1);\n\nINSERT INTO class_student_scores VALUES\n(1, 1, 'Alice', 85),\n(1, 2, 'Bob', 92),\n(1, 3, 'Charlie', 87),\n(2, 4, 'David', 78),\n(2, 5, 'Eve', 95),\n(2, 6, 'Frank', 80),\n(2, 7, 'Grace', 90),\n(2, 8, 'Hannah', 84);\n"})}),"\n",(0,t.jsx)(e.p,{children:"\u7136\u540E\uFF0C\u4F7F\u7528 NTILE \u51FD\u6570\u5C06\u5B66\u751F\u6309\u6210\u7EE9\u5206\u6210 4 \u4E2A\u7EC4\uFF1A"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"SELECT  \n    student_id,  \n    student_name,  \n    score,  \n    NTILE(4) OVER (ORDER BY score DESC) AS bucket  \nFROM  \n    class_student_scores;\n"})}),"\n",(0,t.jsx)(e.p,{children:"\u7ED3\u679C\u5982\u4E0B\uFF1A"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"+------------+--------------+-------+--------+\n| student_id | student_name | score | bucket |\n+------------+--------------+-------+--------+\n|          5 | Eve          |    95 |      1 |\n|          2 | Bob          |    92 |      1 |\n|          7 | Grace        |    90 |      2 |\n|          3 | Charlie      |    87 |      2 |\n|          1 | Alice        |    85 |      3 |\n|          8 | Hannah       |    84 |      3 |\n|          6 | Frank        |    80 |      4 |\n|          4 | David        |    78 |      4 |\n+------------+--------------+-------+--------+\n8 rows in set (0.12 sec)\n"})}),"\n",(0,t.jsxs)(e.p,{children:["\u5728\u8FD9\u4E2A\u4F8B\u5B50\u4E2D\uFF0C",(0,t.jsx)(e.code,{children:"NTILE(4)"}),"\u51FD\u6570\u6839\u636E\u6210\u7EE9\u5C06\u5B66\u751F\u5206\u6210\u4E86 4 \u4E2A\u7EC4\uFF08\u6876\uFF09\uFF0C\u6BCF\u4E2A\u7EC4\u7684\u5B66\u751F\u6570\u91CF\u5C3D\u53EF\u80FD\u5747\u5300\u3002"]}),"\n",(0,t.jsx)(e.admonition,{title:"\u6CE8\u610F\u4E8B\u9879",type:"caution",children:(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\n",(0,t.jsx)(e.p,{children:"\u5982\u679C\u4E0D\u80FD\u5747\u5300\u5730\u5C06\u884C\u5206\u914D\u5230\u6876\u4E2D\uFF0C\u67D0\u4E9B\u6876\u53EF\u80FD\u4F1A\u591A\u4E00\u884C\u3002"}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.code,{children:"NTILE"}),"\u51FD\u6570\u5728\u6BCF\u4E2A\u5206\u533A\u5185\u5DE5\u4F5C\uFF0C\u5982\u679C\u4F7F\u7528",(0,t.jsx)(e.code,{children:"PARTITION BY"}),"\u5B50\u53E5\uFF0C\u5219\u6BCF\u4E2A\u5206\u533A\u5185\u7684\u6570\u636E\u5C06\u5206\u522B\u8FDB\u884C\u6876\u5206\u914D\u3002"]}),"\n"]}),"\n"]})}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"3. \u4F7F\u7528 NTILE \u548C PARTITION BY"})}),"\n",(0,t.jsxs)(e.p,{children:["\u5047\u8BBE\u6309\u73ED\u7EA7\u5BF9\u5B66\u751F\u8FDB\u884C\u5206\u7EC4\uFF0C\u7136\u540E\u5728\u6BCF\u4E2A\u73ED\u7EA7\u5185\u5C06\u5B66\u751F\u6309\u6210\u7EE9\u5206\u6210 3 \u4E2A\u7EC4\uFF0C\u53EF\u4EE5\u4F7F\u7528",(0,t.jsx)(e.code,{children:"PARTITION BY"}),"\u548C",(0,t.jsx)(e.code,{children:"NTILE"}),"\u51FD\u6570\uFF1A"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"SELECT  \n    class_id,  \n    student_id,  \n    student_name,  \n    score,  \n    NTILE(3) OVER (PARTITION BY class_id ORDER BY score DESC) AS bucket  \nFROM  \n    class_student_scores;\n"})}),"\n",(0,t.jsx)(e.p,{children:"\u7ED3\u679C\u5982\u4E0B\uFF1A"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"+----------+------------+--------------+-------+--------+\n| class_id | student_id | student_name | score | bucket |\n+----------+------------+--------------+-------+--------+\n|        1 |          2 | Bob          |    92 |      1 |\n|        1 |          3 | Charlie      |    87 |      2 |\n|        1 |          1 | Alice        |    85 |      3 |\n|        2 |          5 | Eve          |    95 |      1 |\n|        2 |          7 | Grace        |    90 |      1 |\n|        2 |          8 | Hannah       |    84 |      2 |\n|        2 |          6 | Frank        |    80 |      2 |\n|        2 |          4 | David        |    78 |      3 |\n+----------+------------+--------------+-------+--------+\n8 rows in set (0.05 sec)\n"})}),"\n",(0,t.jsx)(e.p,{children:"\u5728\u8FD9\u4E2A\u4F8B\u5B50\u4E2D\uFF0C\u5B66\u751F\u6309\u73ED\u7EA7\u8FDB\u884C\u5206\u533A\uFF0C\u7136\u540E\u5728\u6BCF\u4E2A\u73ED\u7EA7\u5185\u6309\u6210\u7EE9\u5206\u6210 3 \u4E2A\u7EC4\u3002\u6BCF\u4E2A\u7EC4\u7684\u5B66\u751F\u6570\u91CF\u5C3D\u53EF\u80FD\u5747\u5300\u3002"}),"\n",(0,t.jsx)(e.h2,{id:"\u805A\u5408\u51FD\u6570",children:"\u805A\u5408\u51FD\u6570"}),"\n",(0,t.jsx)(e.h3,{id:"\u4F7F\u7528\u805A\u5408\u51FD\u6570-sum-\u8BA1\u7B97\u7D2F\u8BA1\u503C",children:"\u4F7F\u7528\u805A\u5408\u51FD\u6570 SUM \u8BA1\u7B97\u7D2F\u8BA1\u503C"}),"\n",(0,t.jsx)(e.p,{children:"\u793A\u4F8B\u5982\u4E0B\uFF1A"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"SELECT\n        i_category,\n        year(d_date),\n        month(d_date),\n        sum(ss_net_paid) as total_sales,\n        sum(sum(ss_net_paid)) over (partition by i_category order by year(d_date),month(d_date) ROWS UNBOUNDED PRECEDING) as cum_sales\nFROM \n        store_sales,\n        date_dim d1,\n        item\nWHERE \n        d1.d_date_sk = ss_sold_date_sk\n        and i_item_sk = ss_item_sk\n        and year(d_date) =2000\n        and i_category in ('Books','Electronics')\nGROUP BY         \n        i_category,\n        year(d_date),\n        month(d_date)\n"})}),"\n",(0,t.jsx)(e.p,{children:"\u67E5\u8BE2\u7ED3\u679C\u5982\u4E0B\uFF1A"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"+-------------+--------------+---------------+-------------+-------------+\n| i_category  | year(d_date) | month(d_date) | total_sales | cum_sales   |\n+-------------+--------------+---------------+-------------+-------------+\n| Books       |         2000 |             1 |  5348482.88 |  5348482.88 |\n| Books       |         2000 |             2 |  4353162.03 |  9701644.91 |\n| Books       |         2000 |             3 |  4466958.01 | 14168602.92 |\n| Books       |         2000 |             4 |  4495802.19 | 18664405.11 |\n| Books       |         2000 |             5 |  4589913.47 | 23254318.58 |\n| Books       |         2000 |             6 |  4384384.00 | 27638702.58 |\n| Books       |         2000 |             7 |  4488018.76 | 32126721.34 |\n| Books       |         2000 |             8 |  9909227.94 | 42035949.28 |\n| Books       |         2000 |             9 | 10366110.30 | 52402059.58 |\n| Books       |         2000 |            10 | 10445320.76 | 62847380.34 |\n| Books       |         2000 |            11 | 15246901.52 | 78094281.86 |\n| Books       |         2000 |            12 | 15526630.11 | 93620911.97 |\n| Electronics |         2000 |             1 |  5534568.17 |  5534568.17 |\n| Electronics |         2000 |             2 |  4472655.10 | 10007223.27 |\n| Electronics |         2000 |             3 |  4316942.60 | 14324165.87 |\n| Electronics |         2000 |             4 |  4211523.06 | 18535688.93 |\n| Electronics |         2000 |             5 |  4723661.00 | 23259349.93 |\n| Electronics |         2000 |             6 |  4127773.06 | 27387122.99 |\n| Electronics |         2000 |             7 |  4286523.05 | 31673646.04 |\n| Electronics |         2000 |             8 | 10004890.96 | 41678537.00 |\n| Electronics |         2000 |             9 | 10143665.77 | 51822202.77 |\n| Electronics |         2000 |            10 | 10312020.35 | 62134223.12 |\n| Electronics |         2000 |            11 | 14696000.54 | 76830223.66 |\n| Electronics |         2000 |            12 | 15344441.52 | 92174665.18 |\n+-------------+--------------+---------------+-------------+-------------+\n24 rows in set (0.13 sec)\n"})}),"\n",(0,t.jsx)(e.p,{children:"\u5728\u6B64\u793A\u4F8B\u4E2D\uFF0C\u805A\u5408\u51FD\u6570 SUM \u4E3A\u6BCF\u4E00\u884C\u5B9A\u4E49\u4E00\u4E2A\u7A97\u53E3\uFF0C\u8BE5\u7A97\u53E3\u4ECE\u5206\u533A\u7684\u5F00\u5934\uFF08UNBOUNDED PRECEDING\uFF09\u5F00\u59CB\uFF0C\u9ED8\u8BA4\u5728\u5F53\u524D\u884C\u7ED3\u675F\u3002\u5728\u6B64\u793A\u4F8B\u4E2D\uFF0C\u9700\u8981\u5D4C\u5957\u4F7F\u7528 SUM\uFF0C\u56E0\u4E3A\u9700\u8981\u5BF9\u672C\u8EAB\u5C31\u662F SUM \u7684\u7ED3\u679C\u6267\u884C SUM\u3002\u5D4C\u5957\u805A\u5408\u5728\u5206\u6790\u805A\u5408\u51FD\u6570\u4E2D\u9AD8\u9891\u4F7F\u7528\u3002"}),"\n",(0,t.jsx)(e.h3,{id:"\u4F7F\u7528\u805A\u5408\u51FD\u6570-avg-\u8BA1\u7B97\u79FB\u52A8\u5E73\u5747\u503C",children:"\u4F7F\u7528\u805A\u5408\u51FD\u6570 AVG \u8BA1\u7B97\u79FB\u52A8\u5E73\u5747\u503C"}),"\n",(0,t.jsx)(e.p,{children:"\u793A\u4F8B\u5982\u4E0B\uFF1A"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"SELECT\n        i_category,\n        year(d_date),\n        month(d_date),\n        sum(ss_net_paid) as total_sales,\n        avg(sum(ss_net_paid)) over (order by year(d_date),month(d_date) ROWS 2 PRECEDING) as avg\nFROM \n        store_sales,\n        date_dim d1,\n        item\nWHERE \n        d1.d_date_sk = ss_sold_date_sk\n        and i_item_sk = ss_item_sk\n        and year(d_date) =2000\n        and i_category='Books'\nGROUP BY         \n        i_category,\n        year(d_date),\n        month(d_date)\n"})}),"\n",(0,t.jsx)(e.p,{children:"\u67E5\u8BE2\u7ED3\u679C\u5982\u4E0B\uFF1A"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"+------------+--------------+---------------+-------------+---------------+\n| i_category | year(d_date) | month(d_date) | total_sales | avg           |\n+------------+--------------+---------------+-------------+---------------+\n| Books      |         2000 |             1 |  5348482.88 |  5348482.8800 |\n| Books      |         2000 |             2 |  4353162.03 |  4850822.4550 |\n| Books      |         2000 |             3 |  4466958.01 |  4722867.6400 |\n| Books      |         2000 |             4 |  4495802.19 |  4438640.7433 |\n| Books      |         2000 |             5 |  4589913.47 |  4517557.8900 |\n| Books      |         2000 |             6 |  4384384.00 |  4490033.2200 |\n| Books      |         2000 |             7 |  4488018.76 |  4487438.7433 |\n| Books      |         2000 |             8 |  9909227.94 |  6260543.5666 |\n| Books      |         2000 |             9 | 10366110.30 |  8254452.3333 |\n| Books      |         2000 |            10 | 10445320.76 | 10240219.6666 |\n| Books      |         2000 |            11 | 15246901.52 | 12019444.1933 |\n| Books      |         2000 |            12 | 15526630.11 | 13739617.4633 |\n+------------+--------------+---------------+-------------+---------------+\n12 rows in set (0.13 sec)\n"})}),"\n",(0,t.jsx)(e.admonition,{title:"\u6CE8\u610F",type:"caution",children:(0,t.jsx)(e.p,{children:"\u8F93\u51FA\u6570\u636E\u4E2D AVG \u5217\u7684\u524D\u4E24\u884C\u6CA1\u6709\u8BA1\u7B97\u4E09\u5929\u7684\u79FB\u52A8\u5E73\u5747\u503C\uFF0C\u56E0\u4E3A\u8FB9\u754C\u6570\u636E\u524D\u9762\u6CA1\u6709\u8DB3\u591F\u7684\u884C\u6570\uFF08\u5728 SQL \u4E2D\u6307\u5B9A\u7684\u884C\u6570\u4E3A 3\uFF09\u3002"})}),"\n",(0,t.jsx)(e.p,{children:"\u540C\u65F6\uFF0C\u8FD8\u53EF\u4EE5\u8BA1\u7B97\u4EE5\u5F53\u524D\u884C\u4E3A\u4E2D\u5FC3\u7684\u7A97\u53E3\u805A\u5408\u51FD\u6570\u3002\u4F8B\u5982\uFF0C\u6B64\u793A\u4F8B\u8BA1\u7B97\u4E86 Books \u7C7B\u522B\u7684\u4EA7\u54C1 \u5728 2000 \u5E74\u5404\u6708\u9500\u552E\u989D\u7684\u4E2D\u5FC3\u79FB\u52A8\u5E73\u5747\u503C\uFF0C\u5177\u4F53\u8BA1\u7B97\u7684\u662F\u5F53\u524D\u884C\u524D\u4E00\u4E2A\u6708\u3001\u5F53\u524D\u884C\u3001\u4EE5\u53CA\u5F53\u524D\u884C\u540E\u4E00\u4E2A\u6708\u7684\u9500\u552E\u603B\u989D\u5E73\u5747\u503C\u3002"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"SELECT\n        i_category,\n        year(d_date),\n        month(d_date),\n        sum(ss_net_paid) as total_sales,\n        avg(sum(ss_net_paid)) over (order by year(d_date),month(d_date) ROWS between 1 PRECEDING and 1 following) as avg_sales\nFROM \n        store_sales,\n        date_dim d1,\n        item\nWHERE \n        d1.d_date_sk = ss_sold_date_sk\n        and i_item_sk = ss_item_sk\n        and year(d_date) =2000\n        and i_category='Books'\nGROUP BY         \n        i_category,\n        year(d_date),\n        month(d_date)\n"})}),"\n",(0,t.jsx)(e.admonition,{title:"\u6CE8\u610F",type:"caution",children:(0,t.jsx)(e.p,{children:"\u8F93\u51FA\u6570\u636E\u4E2D\u8D77\u59CB\u884C\u548C\u7ED3\u675F\u884C\u7684\u4E2D\u5FC3\u79FB\u52A8\u5E73\u5747\u503C\u8BA1\u7B97\u4EC5\u57FA\u4E8E\u4E24\u5929\uFF0C\u56E0\u4E3A\u8FB9\u754C\u6570\u636E\u524D\u540E\u6CA1\u6709\u8DB3\u591F\u7684\u884C\u6570\u3002"})}),"\n",(0,t.jsx)(e.h2,{id:"\u62A5\u544A\u51FD\u6570",children:"\u62A5\u544A\u51FD\u6570"}),"\n",(0,t.jsx)(e.p,{children:"\u62A5\u544A\u51FD\u6570\u662F\u6307\u6BCF\u4E00\u884C\u7684\u7A97\u53E3\u8303\u56F4\u90FD\u662F\u6574\u4E2A partition\u3002\u62A5\u544A\u51FD\u6570\u7684\u4E3B\u8981\u4F18\u70B9\u662F\u80FD\u591F\u5728\u5355\u4E2A\u67E5\u8BE2\u5757\u4E2D\u591A\u6B21\u4F20\u9012\u6570\u636E\uFF0C\u4ECE\u800C\u63D0\u9AD8\u67E5\u8BE2\u6027\u80FD\u3002\u4F8B\u5982\uFF0C\u201C\u5BF9\u4E8E\u6BCF\u4E00\u5E74\uFF0C\u627E\u51FA\u5176\u9500\u552E\u989D\u6700\u9AD8\u7684\u5546\u54C1\u7C7B\u522B\u201D\u4E4B\u7C7B\u7684\u67E5\u8BE2\uFF0C\u4F7F\u7528\u62A5\u544A\u51FD\u6570\u5219\u4E0D\u9700\u8981\u8FDB\u884C JOIN \u64CD\u4F5C\u3002\u793A\u4F8B\u5982\u4E0B\uFF1A"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"select year,category,total_sum from (\nselect\n        year(d_date) as year,\n        i_category as category,\n        sum(ss_net_paid) as total_sum,\n        max(sum(ss_net_paid)) over (partition by year(d_date)) as max_sales\nfrom\n        store_sales,\n        date_dim d1,\n        item\nwhere\n        d1.d_date_sk = ss_sold_date_sk\n        and i_item_sk = ss_item_sk\n        and year(d_date) in(1998, 1999)\ngroup by\n        year(d_date), i_category \n) t\nwhere total_sum=max_sales;\n"})}),"\n",(0,t.jsxs)(e.p,{children:["\u62A5\u544A",(0,t.jsx)(e.code,{children:"MAX(SUM(ss_net_paid))"}),"\u7684\u5185\u5C42\u67E5\u8BE2\u7ED3\u679C\u5982\u4E0B\uFF1A"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"+------+-------------+-------------+-------------+\n| year | category    | total_sum   | max_sales   |\n+------+-------------+-------------+-------------+\n| 1998 | Electronics | 91723676.27 | 91723676.27 |\n| 1998 | Books       | 91307909.84 | 91723676.27 |\n| 1999 | Electronics | 90310850.54 | 90310850.54 |\n| 1999 | Books       | 88993351.11 | 90310850.54 |\n+------+-------------+-------------+-------------+\n4 rows in set (0.11 sec)\n"})}),"\n",(0,t.jsx)(e.p,{children:"\u5B8C\u6574\u7684\u67E5\u8BE2\u7ED3\u679C\u5982\u4E0B\uFF1A"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"+------+-------------+-------------+\n| year | category    | total_sum   |\n+------+-------------+-------------+\n| 1998 | Electronics | 91723676.27 |\n| 1999 | Electronics | 90310850.54 |\n+------+-------------+-------------+\n2 rows in set (0.12 sec)\n"})}),"\n",(0,t.jsx)(e.p,{children:"\u4F60\u53EF\u4EE5\u5C06\u62A5\u544A\u805A\u5408\u4E0E\u5D4C\u5957\u67E5\u8BE2\u7ED3\u5408\u4F7F\u7528\uFF0C\u4EE5\u89E3\u51B3\u4E00\u4E9B\u590D\u6742\u7684\u95EE\u9898\uFF0C\u6BD4\u5982\u67E5\u627E\u91CD\u8981\u5546\u54C1\u5B50\u7C7B\u522B\u4E2D\u9500\u91CF\u6700\u597D\u7684\u4EA7\u54C1\u3002\u4EE5\u201C\u67E5\u627E\u4EA7\u54C1\u9500\u552E\u989D\u5360\u5176\u4EA7\u54C1\u7C7B\u522B\u603B\u9500\u552E\u989D 20% \u4EE5\u4E0A\u7684\u5B50\u7C7B\u522B\uFF0C\u5E76\u4ECE\u4E2D\u9009\u51FA\u5176\u4E2D\u9500\u91CF\u6700\u9AD8\u7684\u4E94\u79CD\u5546\u54C1\u201D\u4E3A\u4F8B\uFF0C\u67E5\u8BE2\u8BED\u53E5\u5982\u4E0B\uFF1A"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"select i_category as categ, i_class as sub_categ, i_item_id \nfrom\n    (\n    select \n        i_item_id,i_class, i_category, sum(ss_net_paid) as sales,\n        sum(sum(ss_net_paid)) over(partition by i_category) as cat_sales,\n        sum(sum(ss_net_paid)) over(partition by i_class) as sub_cat_sales,\n        rank() over (partition by i_class order by sum(ss_net_paid) desc) rank_in_line\n    from \n        store_sales,\n        item\n    where\n        i_item_sk = ss_item_sk\n    group by i_class, i_category, i_item_id) t\nwhere sub_cat_sales>0.2*cat_sales and rank_in_line<=5;\n"})}),"\n",(0,t.jsx)(e.h2,{id:"lag--lead-\u51FD\u6570",children:"LAG / LEAD \u51FD\u6570"}),"\n",(0,t.jsxs)(e.p,{children:["LAG \u548C LEAD \u51FD\u6570\u9002\u7528\u4E8E\u503C\u4E4B\u95F4\u7684\u6BD4\u8F83\u3002\u4E24\u4E2A\u51FD\u6570\u65E0\u9700\u8FDB\u884C\u81EA\u8FDE\u63A5\uFF0C\u5747\u53EF\u4EE5\u540C\u65F6\u8BBF\u95EE\u8868\u4E2D\u7684\u591A\u4E2A\u884C\uFF0C\u4ECE\u800C\u53EF\u4EE5\u63D0\u9AD8\u67E5\u8BE2\u5904\u7406\u7684\u901F\u5EA6\u3002\u5177\u4F53\u6765\u8BF4\uFF0CLAG \u51FD\u6570\u80FD\u591F\u63D0\u4F9B\u5BF9\u5F53",(0,t.jsx)(e.strong,{children:"\u524D\u884C\u4E4B\u524D"}),"\u7ED9\u5B9A\u504F\u79FB\u5904\u7684\u884C\u7684\u8BBF\u95EE\uFF0C\u800C LEAD \u51FD\u6570\u5219\u63D0\u4F9B\u5BF9\u5F53",(0,t.jsx)(e.strong,{children:"\u524D\u884C\u4E4B\u540E"}),"\u7ED9\u5B9A\u504F\u79FB\u5904\u7684\u884C\u7684\u8BBF\u95EE\u3002"]}),"\n",(0,t.jsx)(e.p,{children:"\u4EE5\u4E0B\u662F\u4E00\u4E2A\u4F7F\u7528 LAG \u51FD\u6570\u7684 SQL \u67E5\u8BE2\u793A\u4F8B\uFF0C\u8BE5\u67E5\u8BE2\u5E0C\u671B\u9009\u53D6\u7279\u5B9A\u5E74\u4EFD\uFF081999, 2000, 2001, 2002\uFF09\u4E2D\uFF0C\u6BCF\u4E2A\u5546\u54C1\u7C7B\u522B\u7684\u603B\u9500\u552E\u989D\u3001\u524D\u4E00\u5E74\u7684\u603B\u9500\u552E\u989D\u4EE5\u53CA\u4E24\u8005\u4E4B\u95F4\u7684\u5DEE\u5F02\uFF1A"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"select year, category, total_sales, before_year_sales, total_sales - before_year_sales from\n(\nselect\n        sum(ss_net_paid) as total_sales,\n        year(d_date) year,\n        i_category category,\n        lag(sum(ss_net_paid), 1,0) over(PARTITION BY i_category ORDER BY YEAR(d_date)) AS before_year_sales\nfrom\n        store_sales,\n        date_dim d1,\n        item\nwhere\n        d1.d_date_sk = ss_sold_date_sk\n        and i_item_sk = ss_item_sk\nGROUP BY \n        YEAR(d_date), i_category\n) t\nwhere year in (1999, 2000, 2001, 2002)\n"})}),"\n",(0,t.jsx)(e.p,{children:"\u67E5\u8BE2\u7ED3\u679C\u5982\u4E0B\uFF1A"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"+------+-------------+-------------+-------------------+-----------------------------------+\n| year | category    | total_sales | before_year_sales | (total_sales - before_year_sales) |\n+------+-------------+-------------+-------------------+-----------------------------------+\n| 1999 | Books       | 88993351.11 |       91307909.84 |                       -2314558.73 |\n| 2000 | Books       | 93620911.97 |       88993351.11 |                        4627560.86 |\n| 2001 | Books       | 90640097.99 |       93620911.97 |                       -2980813.98 |\n| 2002 | Books       | 89585515.90 |       90640097.99 |                       -1054582.09 |\n| 1999 | Electronics | 90310850.54 |       91723676.27 |                       -1412825.73 |\n| 2000 | Electronics | 92174665.18 |       90310850.54 |                        1863814.64 |\n| 2001 | Electronics | 92598527.85 |       92174665.18 |                         423862.67 |\n| 2002 | Electronics | 94303831.84 |       92598527.85 |                        1705303.99 |\n+------+-------------+-------------+-------------------+-----------------------------------+\n8 rows in set (0.16 sec)\n"})}),"\n",(0,t.jsxs)(e.ol,{children:["\n",(0,t.jsx)(e.li,{children:"\u5047\u8BBE\u6211\u4EEC\u6709\u5982\u4E0B\u7684\u80A1\u7968\u6570\u636E\uFF0C\u80A1\u7968\u4EE3\u7801\u662F JDR\uFF0Cclosing price \u662F\u6BCF\u5929\u7684\u6536\u76D8\u4EF7\u3002"}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:'create table stock_ticker (stock_symbol string, closing_price decimal(8,2), closing_date timestamp);    \n\nINSERT INTO stock_ticker VALUES \n    ("JDR", 12.86, "2014-10-02 00:00:00"), \n    ("JDR", 12.89, "2014-10-03 00:00:00"), \n    ("JDR", 12.94, "2014-10-04 00:00:00"), \n    ("JDR", 12.55, "2014-10-05 00:00:00"), \n    ("JDR", 14.03, "2014-10-06 00:00:00"), \n    ("JDR", 14.75, "2014-10-07 00:00:00"), \n    ("JDR", 13.98, "2014-10-08 00:00:00")\n;\n\nselect * from stock_ticker order by stock_symbol, closing_date\n'})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-text",children:"| stock_symbol | closing_price | closing_date        |\n|--------------|---------------|---------------------|\n| JDR          | 12.86         | 2014-10-02 00:00:00 |\n| JDR          | 12.89         | 2014-10-03 00:00:00 |\n| JDR          | 12.94         | 2014-10-04 00:00:00 |\n| JDR          | 12.55         | 2014-10-05 00:00:00 |\n| JDR          | 14.03         | 2014-10-06 00:00:00 |\n| JDR          | 14.75         | 2014-10-07 00:00:00 |\n| JDR          | 13.98         | 2014-10-08 00:00:00 |\n"})}),"\n",(0,t.jsxs)(e.ol,{start:"2",children:["\n",(0,t.jsx)(e.li,{children:"\u8FD9\u4E2A\u67E5\u8BE2\u4F7F\u7528\u5206\u6790\u51FD\u6570\u4EA7\u751F moving_average \u8FD9\u4E00\u5217\uFF0C\u5B83\u7684\u503C\u662F 3 \u5929\u7684\u80A1\u7968\u5747\u4EF7\uFF0C\u5373\u524D\u4E00\u5929\u3001\u5F53\u524D\u4EE5\u53CA\u540E\u4E00\u5929\u4E09\u5929\u7684\u5747\u4EF7\u3002\u7B2C\u4E00\u5929\u6CA1\u6709\u524D\u4E00\u5929\u7684\u503C\uFF0C\u6700\u540E\u4E00\u5929\u6CA1\u6709\u540E\u4E00\u5929\u7684\u503C\uFF0C\u6240\u4EE5\u8FD9\u4E24\u884C\u53EA\u8BA1\u7B97\u4E86\u4E24\u5929\u7684\u5747\u503C\u3002\u8FD9\u91CC Partition By \u6CA1\u6709\u8D77\u5230\u4F5C\u7528\uFF0C\u56E0\u4E3A\u6240\u6709\u7684\u6570\u636E\u90FD\u662F JDR \u7684\u6570\u636E\uFF0C\u4F46\u5982\u679C\u8FD8\u6709\u5176\u4ED6\u80A1\u7968\u4FE1\u606F\uFF0CPartition By \u4F1A\u4FDD\u8BC1\u5206\u6790\u51FD\u6570\u503C\u4F5C\u7528\u5728\u672C Partition \u4E4B\u5185\u3002"}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"select stock_symbol, closing_date, closing_price,    \navg(closing_price) over (partition by stock_symbol order by closing_date    \nrows between 1 preceding and 1 following) as moving_average    \nfrom stock_ticker;\n"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-text",children:"| stock_symbol | closing_date        | closing_price | moving_average |\n|--------------|---------------------|---------------|----------------|\n| JDR          | 2014-10-02 00:00:00 | 12.86         | 12.87          |\n| JDR          | 2014-10-03 00:00:00 | 12.89         | 12.89          |\n| JDR          | 2014-10-04 00:00:00 | 12.94         | 12.79          |\n| JDR          | 2014-10-05 00:00:00 | 12.55         | 13.17          |\n| JDR          | 2014-10-06 00:00:00 | 14.03         | 13.77          |\n| JDR          | 2014-10-07 00:00:00 | 14.75         | 14.25          |\n| JDR          | 2014-10-08 00:00:00 | 13.98         | 14.36          |\n"})}),"\n",(0,t.jsx)(e.h2,{id:"\u9644\u5F55",children:"\u9644\u5F55"}),"\n",(0,t.jsx)(e.p,{children:"\u793A\u4F8B\u4E2D\u4F7F\u7528\u5230\u7684\u8868\u7684\u5EFA\u8868\u8BED\u53E5\u5982\u4E0B\uFF1A"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:'CREATE DATABASE IF NOT EXISTS doc_tpcds;\nUSE doc_tpcds;\n\nCREATE TABLE IF NOT EXISTS item (\n    i_item_sk bigint not null,\n    i_item_id char(16) not null,\n    i_rec_start_date date,\n    i_rec_end_date date,\n    i_item_desc varchar(200),\n    i_current_price decimal(7,2),\n    i_wholesale_cost decimal(7,2),\n    i_brand_id integer,\n    i_brand char(50),\n    i_class_id integer,\n    i_class char(50),\n    i_category_id integer,\n    i_category char(50),\n    i_manufact_id integer,\n    i_manufact char(50),\n    i_size char(20),\n    i_formulation char(20),\n    i_color char(20),\n    i_units char(10),\n    i_container char(10),\n    i_manager_id integer,\n    i_product_name char(50)\n)\nDUPLICATE KEY(i_item_sk)\nDISTRIBUTED BY HASH(i_item_sk) BUCKETS 12\nPROPERTIES (\n  "replication_num" = "1"\n);\n\nCREATE TABLE IF NOT EXISTS store_sales (\n    ss_item_sk bigint not null,\n    ss_ticket_number bigint not null,\n    ss_sold_date_sk bigint,\n    ss_sold_time_sk bigint,\n    ss_customer_sk bigint,\n    ss_cdemo_sk bigint,\n    ss_hdemo_sk bigint,\n    ss_addr_sk bigint,\n    ss_store_sk bigint,\n    ss_promo_sk bigint,\n    ss_quantity integer,\n    ss_wholesale_cost decimal(7,2),\n    ss_list_price decimal(7,2),\n    ss_sales_price decimal(7,2),\n    ss_ext_discount_amt decimal(7,2),\n    ss_ext_sales_price decimal(7,2),\n    ss_ext_wholesale_cost decimal(7,2),\n    ss_ext_list_price decimal(7,2),\n    ss_ext_tax decimal(7,2),\n    ss_coupon_amt decimal(7,2),\n    ss_net_paid decimal(7,2),\n    ss_net_paid_inc_tax decimal(7,2),\n    ss_net_profit decimal(7,2)\n)\nDUPLICATE KEY(ss_item_sk, ss_ticket_number)\nDISTRIBUTED BY HASH(ss_item_sk, ss_ticket_number) BUCKETS 32\nPROPERTIES (\n  "replication_num" = "1"\n);\n\nCREATE TABLE IF NOT EXISTS date_dim (\n    d_date_sk bigint not null,\n    d_date_id char(16) not null,\n    d_date date,\n    d_month_seq integer,\n    d_week_seq integer,\n    d_quarter_seq integer,\n    d_year integer,\n    d_dow integer,\n    d_moy integer,\n    d_dom integer,\n    d_qoy integer,\n    d_fy_year integer,\n    d_fy_quarter_seq integer,\n    d_fy_week_seq integer,\n    d_day_name char(9),\n    d_quarter_name char(6),\n    d_holiday char(1),\n    d_weekend char(1),\n    d_following_holiday char(1),\n    d_first_dom integer,\n    d_last_dom integer,\n    d_same_day_ly integer,\n    d_same_day_lq integer,\n    d_current_day char(1),\n    d_current_week char(1),\n    d_current_month char(1),\n    d_current_quarter char(1),\n    d_current_year char(1)\n)\nDUPLICATE KEY(d_date_sk)\nDISTRIBUTED BY HASH(d_date_sk) BUCKETS 12\nPROPERTIES (\n  "replication_num" = "1"\n);\n\nCREATE TABLE IF NOT EXISTS customer_address (\n    ca_address_sk bigint not null,\n    ca_address_id char(16) not null,\n    ca_street_number char(10),\n    ca_street_name varchar(60),\n    ca_street_type char(15),\n    ca_suite_number char(10),\n    ca_city varchar(60),\n    ca_county varchar(30),\n    ca_state char(2),\n    ca_zip char(10),\n    ca_country varchar(20),\n    ca_gmt_offset decimal(5,2),\n    ca_location_type char(20)\n)\nDUPLICATE KEY(ca_address_sk)\nDISTRIBUTED BY HASH(ca_address_sk) BUCKETS 12\nPROPERTIES (\n  "replication_num" = "1"\n);\n'})}),"\n",(0,t.jsx)(e.p,{children:"\u5728\u7EC8\u7AEF\u6267\u884C\u5982\u4E0B\u547D\u4EE4\uFF0C\u4E0B\u8F7D\u6570\u636E\u5230\u672C\u5730\uFF0C\u5E76\u4F7F\u7528 Stream Load \u7684\u65B9\u5F0F\u52A0\u8F7D\u6570\u636E\uFF1A"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-shell",children:'curl -L https://cdn.selectdb.com/static/doc_ddl_dir_d27a752a7b.tar -o - | tar -Jxf -\n\ncurl --location-trusted \\\n-u "root:" \\\n-H "column_separator:|" \\\n-H "columns: i_item_sk, i_item_id, i_rec_start_date, i_rec_end_date, i_item_desc, i_current_price, i_wholesale_cost, i_brand_id, i_brand, i_class_id, i_class, i_category_id, i_category, i_manufact_id, i_manufact, i_size, i_formulation, i_color, i_units, i_container, i_manager_id, i_product_name" \\\n-T "doc_ddl_dir/item_1_10.dat" \\\nhttp://127.0.0.1:8030/api/doc_tpcds/item/_stream_load\n\ncurl --location-trusted \\\n-u "root:" \\\n-H "column_separator:|" \\\n-H "columns: d_date_sk, d_date_id, d_date, d_month_seq, d_week_seq, d_quarter_seq, d_year, d_dow, d_moy, d_dom, d_qoy, d_fy_year, d_fy_quarter_seq, d_fy_week_seq, d_day_name, d_quarter_name, d_holiday, d_weekend, d_following_holiday, d_first_dom, d_last_dom, d_same_day_ly, d_same_day_lq, d_current_day, d_current_week, d_current_month, d_current_quarter, d_current_year" \\\n-T "doc_ddl_dir/date_dim_1_10.dat" \\\nhttp://127.0.0.1:8030/api/doc_tpcds/date_dim/_stream_load\n\ncurl --location-trusted \\\n-u "root:" \\\n-H "column_separator:|" \\\n-H "columns: ss_sold_date_sk, ss_sold_time_sk, ss_item_sk, ss_customer_sk, ss_cdemo_sk, ss_hdemo_sk, ss_addr_sk, ss_store_sk, ss_promo_sk, ss_ticket_number, ss_quantity, ss_wholesale_cost, ss_list_price, ss_sales_price, ss_ext_discount_amt, ss_ext_sales_price, ss_ext_wholesale_cost, ss_ext_list_price, ss_ext_tax, ss_coupon_amt, ss_net_paid, ss_net_paid_inc_tax, ss_net_profit" \\\n-T "doc_ddl_dir/store_sales.csv" \\\nhttp://127.0.0.1:8030/api/doc_tpcds/store_sales/_stream_load\n\ncurl --location-trusted \\\n-u "root:" \\\n-H "column_separator:|" \\\n-H "ca_address_sk, ca_address_id, ca_street_number, ca_street_name, ca_street_type, ca_suite_number, ca_city, ca_county, ca_state, ca_zip, ca_country, ca_gmt_offset, ca_location_type" \\\n-T "doc_ddl_dir/customer_address_1_10.dat" \\\nhttp://127.0.0.1:8030/api/doc_tpcds/customer_address/_stream_load\n'})}),"\n",(0,t.jsxs)(e.p,{children:["\u6570\u636E\u6587\u4EF6",(0,t.jsx)(e.code,{children:"item_1_10.dat"}),"\uFF0C",(0,t.jsx)(e.code,{children:"date_dim_1_10.dat"}),"\uFF0C",(0,t.jsx)(e.code,{children:"store_sales.csv"}),"\uFF0C",(0,t.jsx)(e.code,{children:"customer_address_1_10.dat"}),"\u53EF\u4EE5",(0,t.jsx)(e.a,{href:"https://cdn.selectdb.com/static/doc_ddl_dir_d27a752a7b.tar",children:"\u70B9\u51FB\u94FE\u63A5"}),"\u4E0B\u8F7D\u3002"]})]})}function o(n={}){let{wrapper:e}={...(0,i.a)(),...n.components};return e?(0,t.jsx)(e,{...n,children:(0,t.jsx)(l,{...n})}):l(n)}},748660:function(n,e,s){s.d(e,{Z:function(){return a}});let a=s.p+"assets/images/window-function-order-56d1969ee6d25b67878966313d4482c5.png"},406961:function(n,e,s){s.d(e,{Z:function(){return a}});let a=s.p+"assets/images/window-function-rows-0505d7225ee230aeac864b0754b88270.jpg"},250065:function(n,e,s){s.d(e,{Z:function(){return r},a:function(){return d}});var a=s(667294);let t={},i=a.createContext(t);function d(n){let e=a.useContext(i);return a.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function r(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(t):n.components||t:d(n.components),a.createElement(i.Provider,{value:e},n.children)}}}]);